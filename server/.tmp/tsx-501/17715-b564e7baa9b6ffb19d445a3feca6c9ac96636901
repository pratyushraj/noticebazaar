{"code":"import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";import{generateSignedUploadUrl,generateSignedDownloadUrl}from\"../services/storage.js\";import{scanFileForVirus}from\"../services/virusScan.js\";const router=Router();const ALLOWED_MIME=new Set([\"image/png\",\"image/jpeg\",\"image/webp\",\"application/pdf\",\"text/plain\"]);const MAX_SIZE=5*1024*1024;router.post(\"/:conversationId/attachments/request-upload\",async(req,res)=>{try{const userId=req.user.id;const{conversationId}=req.params;const{file_name,file_size,file_type}=req.body;if(!file_name||!file_size||!file_type){return res.status(400).json({error:\"file_name, file_size, file_type required\"})}const{data:participant}=await supabase.from(\"conversation_participants\").select(\"user_id\").eq(\"conversation_id\",conversationId).eq(\"user_id\",userId).single();if(!participant){return res.status(403).json({error:\"Access denied\"})}if(file_size>MAX_SIZE){return res.status(400).json({error:\"File size exceeds 5MB limit\"})}if(!ALLOWED_MIME.has(file_type)){return res.status(400).json({error:\"Unsupported file type\"})}const sanitizedFileName=file_name.replace(/[^a-zA-Z0-9.-]/g,\"_\");const storagePath=`conversations/${conversationId}/${userId}/${Date.now()}_${sanitizedFileName}`;const{signedUrl,path}=await generateSignedUploadUrl(storagePath,file_type);const{data:attachment,error}=await supabase.from(\"message_attachments\").insert({file_name:sanitizedFileName,file_size,file_type,storage_path:path,virus_scan_status:\"pending\"}).select().single();if(error)throw error;res.json({data:{attachment_id:attachment.id,signed_upload_url:signedUrl,expires_in:3600}})}catch(error){res.status(500).json({error:error.message})}});router.post(\"/:conversationId/attachments/confirm\",async(req,res)=>{try{const userId=req.user.id;const{conversationId}=req.params;const{attachment_id}=req.body;if(!attachment_id){return res.status(400).json({error:\"attachment_id required\"})}const{data:attachment,error:attError}=await supabase.from(\"message_attachments\").select(\"*\").eq(\"id\",attachment_id).single();if(attError||!attachment){return res.status(404).json({error:\"Attachment not found\"})}const{data:participant}=await supabase.from(\"conversation_participants\").select(\"user_id\").eq(\"conversation_id\",conversationId).eq(\"user_id\",userId).single();if(!participant){return res.status(403).json({error:\"Access denied\"})}scanFileForVirus(attachment.id,attachment.storage_path).then(result=>{if(result.status===\"clean\"){return generateSignedDownloadUrl(attachment.storage_path).then(downloadUrl=>{return supabase.from(\"message_attachments\").update({virus_scan_status:result.status,virus_scan_result:result.result,scanned_at:new Date().toISOString(),signed_download_url:downloadUrl}).eq(\"id\",attachment.id)})}return supabase.from(\"message_attachments\").update({virus_scan_status:result.status,virus_scan_result:result.result,scanned_at:new Date().toISOString()}).eq(\"id\",attachment.id)}).catch(err=>{console.error(\"Virus scan error:\",err);supabase.from(\"message_attachments\").update({virus_scan_status:\"error\",virus_scan_result:err.message}).eq(\"id\",attachment.id)});res.json({data:{attachment_id:attachment.id,scan_status:\"pending\"}})}catch(error){res.status(500).json({error:error.message})}});router.get(\"/:conversationId/attachments/:attachmentId/status\",async(req,res)=>{try{const userId=req.user.id;const{conversationId,attachmentId}=req.params;const{data:participant}=await supabase.from(\"conversation_participants\").select(\"user_id\").eq(\"conversation_id\",conversationId).eq(\"user_id\",userId).single();if(!participant){return res.status(403).json({error:\"Access denied\"})}const{data:attachment,error:attError}=await supabase.from(\"message_attachments\").select(\"id, virus_scan_status, signed_download_url\").eq(\"id\",attachmentId).single();if(attError||!attachment){return res.status(404).json({error:\"Attachment not found\"})}res.json({data:{attachment_id:attachment.id,scan_status:attachment.virus_scan_status,download_url:attachment.signed_download_url||null}})}catch(error){res.status(500).json({error:error.message})}});var attachments_default=router;export{attachments_default as default};\n","warnings":[],"map":{"version":3,"mappings":"AAGA,OAAS,WAAwB,UACjC,OAAS,aAAgB,qBAEzB,OAAS,wBAAyB,8BAAiC,yBACnE,OAAS,qBAAwB,2BAEjC,MAAM,OAAS,OAAO,EACtB,MAAM,aAAe,IAAI,IAAI,CAC3B,YACA,aACA,aACA,kBACA,YACF,CAAC,EACD,MAAM,SAAW,EAAI,KAAO,KAG5B,OAAO,KAAK,8CAA+C,MAAO,IAA2B,MAAkB,CAC7G,GAAI,CACF,MAAM,OAAS,IAAI,KAAM,GACzB,KAAM,CAAE,cAAe,EAAI,IAAI,OAC/B,KAAM,CAAE,UAAW,UAAW,SAAU,EAAI,IAAI,KAEhD,GAAI,CAAC,WAAa,CAAC,WAAa,CAAC,UAAW,CAC1C,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,0CAA2C,CAAC,CACnF,CAGA,KAAM,CAAE,KAAM,WAAY,EAAI,MAAM,SACjC,KAAK,2BAA2B,EAChC,OAAO,SAAS,EAChB,GAAG,kBAAmB,cAAc,EACpC,GAAG,UAAW,MAAM,EACpB,OAAO,EAEV,GAAI,CAAC,YAAa,CAChB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,eAAgB,CAAC,CACxD,CAGA,GAAI,UAAY,SAAU,CACxB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,6BAA8B,CAAC,CACtE,CACA,GAAI,CAAC,aAAa,IAAI,SAAS,EAAG,CAChC,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,uBAAwB,CAAC,CAChE,CAGA,MAAM,kBAAoB,UAAU,QAAQ,kBAAmB,GAAG,EAClE,MAAM,YAAc,iBAAiB,cAAc,IAAI,MAAM,IAAI,KAAK,IAAI,CAAC,IAAI,iBAAiB,GAGhG,KAAM,CAAE,UAAW,IAAK,EAAI,MAAM,wBAAwB,YAAa,SAAS,EAGhF,KAAM,CAAE,KAAM,WAAY,KAAM,EAAI,MAAM,SACvC,KAAK,qBAAqB,EAC1B,OAAO,CACN,UAAW,kBACX,UACA,UACA,aAAc,KACd,kBAAmB,SACrB,CAAC,EACA,OAAO,EACP,OAAO,EAEV,GAAI,MAAO,MAAM,MAEjB,IAAI,KAAK,CACP,KAAM,CACJ,cAAe,WAAW,GAC1B,kBAAmB,UACnB,WAAY,IACd,CACF,CAAC,CACH,OAAS,MAAY,CACnB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,MAAM,OAAQ,CAAC,CAC/C,CACF,CAAC,EAGD,OAAO,KAAK,uCAAwC,MAAO,IAA2B,MAAkB,CACtG,GAAI,CACF,MAAM,OAAS,IAAI,KAAM,GACzB,KAAM,CAAE,cAAe,EAAI,IAAI,OAC/B,KAAM,CAAE,aAAc,EAAI,IAAI,KAE9B,GAAI,CAAC,cAAe,CAClB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,wBAAyB,CAAC,CACjE,CAGA,KAAM,CAAE,KAAM,WAAY,MAAO,QAAS,EAAI,MAAM,SACjD,KAAK,qBAAqB,EAC1B,OAAO,GAAG,EACV,GAAG,KAAM,aAAa,EACtB,OAAO,EAEV,GAAI,UAAY,CAAC,WAAY,CAC3B,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,sBAAuB,CAAC,CAC/D,CAIA,KAAM,CAAE,KAAM,WAAY,EAAI,MAAM,SACjC,KAAK,2BAA2B,EAChC,OAAO,SAAS,EAChB,GAAG,kBAAmB,cAAc,EACpC,GAAG,UAAW,MAAM,EACpB,OAAO,EAEV,GAAI,CAAC,YAAa,CAChB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,eAAgB,CAAC,CACxD,CAGA,iBAAiB,WAAW,GAAI,WAAW,YAAY,EACpD,KAAM,QAAW,CAChB,GAAI,OAAO,SAAW,QAAS,CAC7B,OAAO,0BAA0B,WAAW,YAAY,EACrD,KAAM,aAAgB,CACrB,OAAO,SACJ,KAAK,qBAAqB,EAC1B,OAAO,CACN,kBAAmB,OAAO,OAC1B,kBAAmB,OAAO,OAC1B,WAAY,IAAI,KAAK,EAAE,YAAY,EACnC,oBAAqB,WACvB,CAAC,EACA,GAAG,KAAM,WAAW,EAAE,CAC3B,CAAC,CACL,CACA,OAAO,SACJ,KAAK,qBAAqB,EAC1B,OAAO,CACN,kBAAmB,OAAO,OAC1B,kBAAmB,OAAO,OAC1B,WAAY,IAAI,KAAK,EAAE,YAAY,CACrC,CAAC,EACA,GAAG,KAAM,WAAW,EAAE,CAC3B,CAAC,EACA,MAAO,KAAQ,CACd,QAAQ,MAAM,oBAAqB,GAAG,EACtC,SACG,KAAK,qBAAqB,EAC1B,OAAO,CACN,kBAAmB,QACnB,kBAAmB,IAAI,OACzB,CAAC,EACA,GAAG,KAAM,WAAW,EAAE,CAC3B,CAAC,EAEH,IAAI,KAAK,CACP,KAAM,CACJ,cAAe,WAAW,GAC1B,YAAa,SACf,CACF,CAAC,CACH,OAAS,MAAY,CACnB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,MAAM,OAAQ,CAAC,CAC/C,CACF,CAAC,EAGD,OAAO,IAAI,oDAAqD,MAAO,IAA2B,MAAkB,CAClH,GAAI,CACF,MAAM,OAAS,IAAI,KAAM,GACzB,KAAM,CAAE,eAAgB,YAAa,EAAI,IAAI,OAE7C,KAAM,CAAE,KAAM,WAAY,EAAI,MAAM,SACjC,KAAK,2BAA2B,EAChC,OAAO,SAAS,EAChB,GAAG,kBAAmB,cAAc,EACpC,GAAG,UAAW,MAAM,EACpB,OAAO,EAEV,GAAI,CAAC,YAAa,CAChB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,eAAgB,CAAC,CACxD,CAEA,KAAM,CAAE,KAAM,WAAY,MAAO,QAAS,EAAI,MAAM,SACjD,KAAK,qBAAqB,EAC1B,OAAO,4CAA4C,EACnD,GAAG,KAAM,YAAY,EACrB,OAAO,EAEV,GAAI,UAAY,CAAC,WAAY,CAC3B,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,sBAAuB,CAAC,CAC/D,CAEA,IAAI,KAAK,CACP,KAAM,CACJ,cAAe,WAAW,GAC1B,YAAa,WAAW,kBACxB,aAAc,WAAW,qBAAuB,IAClD,CACF,CAAC,CACH,OAAS,MAAY,CACnB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,MAAM,OAAQ,CAAC,CAC/C,CACF,CAAC,EAED,IAAO,oBAAQ","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/attachments.ts"],"sourcesContent":[null]}}