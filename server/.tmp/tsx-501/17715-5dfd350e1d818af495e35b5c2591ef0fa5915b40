{"code":"import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";const router=Router();router.get(\"/recent\",async(req,res)=>{try{const userId=req.user.id;const limit=parseInt(req.query.limit)||20;const{data:payments,error}=await supabase.from(\"brand_deals\").select(\"*\").eq(\"creator_id\",userId).not(\"deal_amount\",\"is\",null).order(\"updated_at\",{ascending:false}).limit(limit);if(error)throw error;res.json({data:payments})}catch(error){res.status(500).json({error:error.message})}});router.post(\"/request\",async(req,res)=>{try{const userId=req.user.id;const{deal_id,amount,due_date,notes}=req.body;if(!deal_id||!amount){return res.status(400).json({error:\"deal_id and amount required\"})}const{data:deal}=await supabase.from(\"brand_deals\").select(\"*\").eq(\"id\",deal_id).eq(\"creator_id\",userId).single();if(!deal){return res.status(404).json({error:\"Deal not found\"})}const signedStatuses=[\"signed\",\"SIGNED_BY_BRAND\",\"content_making\",\"Content Making\",\"content_delivered\",\"Content Delivered\",\"completed\",\"COMPLETED\"];const dealStatus=deal.status?.toLowerCase()||\"\";const isSigned=signedStatuses.some(s=>s.toLowerCase()===dealStatus);if(!isSigned){return res.status(400).json({error:\"Payments can only be created for signed deals\"})}const{data:updated,error}=await supabase.from(\"brand_deals\").update({payment_expected_date:due_date,payment_notes:notes,updated_at:new Date().toISOString()}).eq(\"id\",deal_id).select().single();if(error)throw error;res.json({data:updated})}catch(error){res.status(500).json({error:error.message})}});router.post(\"/mark-received\",async(req,res)=>{try{const userId=req.user.id;const{deal_id,received_date,utr_number,proof_url}=req.body;if(!deal_id){return res.status(400).json({error:\"deal_id required\"})}const{data:deal}=await supabase.from(\"brand_deals\").select(\"*\").eq(\"id\",deal_id).eq(\"creator_id\",userId).single();if(!deal){return res.status(404).json({error:\"Deal not found\"})}const signedStatuses=[\"signed\",\"SIGNED_BY_BRAND\",\"content_making\",\"Content Making\",\"content_delivered\",\"Content Delivered\",\"completed\",\"COMPLETED\"];const dealStatus=deal.status?.toLowerCase()||\"\";const isSigned=signedStatuses.some(s=>s.toLowerCase()===dealStatus);if(!isSigned){return res.status(400).json({error:\"Payments can only be marked as received for signed deals\"})}const{data:updated,error}=await supabase.from(\"brand_deals\").update({payment_received_date:received_date||new Date().toISOString(),utr_number:utr_number||null,proof_of_payment_url:proof_url||null,status:\"Completed\",updated_at:new Date().toISOString()}).eq(\"id\",deal_id).select().single();if(error)throw error;res.json({data:updated})}catch(error){res.status(500).json({error:error.message})}});var payments_default=router;export{payments_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/payments.ts"],"sourcesContent":[null]}}