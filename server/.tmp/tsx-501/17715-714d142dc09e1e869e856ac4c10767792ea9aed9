{"code":"import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";import{authMiddleware}from\"../middleware/auth.js\";import{createDealDetailsToken,getDealDetailsTokenInfo,submitDealDetails,getDealSubmissionDetails}from\"../services/dealDetailsTokenService.js\";const router=Router();router.post(\"/\",authMiddleware,async(req,res)=>{try{const userId=req.user?.id;if(!userId){return res.status(401).json({success:false,error:\"Unauthorized\"})}const{expiresAt}=req.body;let expiresDate=null;if(expiresAt){expiresDate=new Date(expiresAt);if(isNaN(expiresDate.getTime())){return res.status(400).json({success:false,error:\"Invalid expiresAt format. Use ISO 8601 date string or null.\"})}}const token=await createDealDetailsToken({creatorId:userId,expiresAt:expiresDate});return res.json({success:true,token:{id:token.id,creator_id:token.creator_id,created_at:token.created_at,expires_at:token.expires_at}})}catch(error){console.error(\"[DealDetailsTokens] Error:\",error);return res.status(500).json({success:false,error:error.message||\"Internal server error\"})}});router.get(\"/deal/:dealId\",authMiddleware,async(req,res)=>{try{const userId=req.user?.id;const{dealId}=req.params;if(!userId){return res.status(401).json({success:false,error:\"Unauthorized\"})}if(!dealId){return res.status(400).json({success:false,error:\"Deal ID is required\"})}const details=await getDealSubmissionDetails(dealId);if(!details){return res.json({success:true,submission:null,formData:null})}const{data:deal}=await supabase.from(\"brand_deals\").select(\"creator_id\").eq(\"id\",dealId).single();if(!deal||deal.creator_id!==userId){return res.status(403).json({success:false,error:\"Access denied\"})}return res.json({success:true,submission:details.submission,formData:details.formData})}catch(error){console.error(\"[DealDetailsTokens] Get deal details error:\",error);return res.status(500).json({success:false,error:error.message||\"An error occurred. Please try again later.\"})}});router.get(\"/:token/contract-ready-token\",async(req,res)=>{try{const{token}=req.params;if(!token||typeof token!==\"string\"||token.trim()===\"\"){return res.status(400).json({success:false,error:\"Invalid token\"})}const{data:submission,error:submissionError}=await supabase.from(\"deal_details_submissions\").select(\"deal_id\").eq(\"token_id\",token.trim()).maybeSingle();if(submissionError||!submission||!submission.deal_id){return res.status(404).json({success:false,error:\"No contract ready yet. Please wait a moment and try again.\"})}const{data:contractReadyTokenData,error:tokenError}=await supabase.from(\"contract_ready_tokens\").select(\"id\").eq(\"deal_id\",submission.deal_id).eq(\"is_active\",true).is(\"revoked_at\",null).order(\"created_at\",{ascending:false}).limit(1).maybeSingle();if(tokenError||!contractReadyTokenData||!contractReadyTokenData.id){return res.status(404).json({success:false,error:\"Contract is being prepared. Please wait a moment and try again.\"})}return res.json({success:true,contractReadyToken:contractReadyTokenData.id,dealId:submission.deal_id})}catch(error){console.error(\"[DealDetailsTokens] Get contract ready token error:\",error);return res.status(500).json({success:false,error:\"An error occurred. Please try again later.\"})}});router.get(\"/:token\",async(req,res)=>{try{const{token}=req.params;if(!token||typeof token!==\"string\"||token.trim()===\"\"){return res.status(400).json({success:false,error:\"Invalid token\"})}const tokenInfo=await getDealDetailsTokenInfo(token.trim());if(!tokenInfo){return res.status(404).json({success:false,error:\"This link is no longer valid. Please contact the creator.\"})}const isUsed=!!tokenInfo.token.used_at;let contractReadyToken=null;let dealId=null;let isSigned=false;if(isUsed){const{data:submission}=await supabase.from(\"deal_details_submissions\").select(\"deal_id\").eq(\"token_id\",token.trim()).maybeSingle();if(submission?.deal_id){dealId=submission.deal_id;const{data:signatures}=await supabase.from(\"contract_signatures\").select(\"signed\").eq(\"deal_id\",dealId).eq(\"signer_role\",\"brand\").maybeSingle();isSigned=signatures?.signed===true;if(!isSigned){const{data:contractReadyTokenData}=await supabase.from(\"contract_ready_tokens\").select(\"id\").eq(\"deal_id\",dealId).eq(\"is_active\",true).is(\"revoked_at\",null).order(\"created_at\",{ascending:false}).limit(1).maybeSingle();if(contractReadyTokenData?.id){contractReadyToken=contractReadyTokenData.id}}}}return res.json({success:true,creatorName:tokenInfo.creatorName,isUsed,contractReadyToken,dealId,isSigned})}catch(error){console.error(\"[DealDetailsTokens] GET Error:\",error);return res.status(500).json({success:false,error:\"An error occurred. Please try again later.\"})}});router.post(\"/:token/submit\",async(req,res)=>{try{const{token}=req.params;const formData=req.body;if(!token||typeof token!==\"string\"||token.trim()===\"\"){return res.status(400).json({success:false,error:\"Invalid token\"})}if(!formData||typeof formData!==\"object\"){return res.status(400).json({success:false,error:\"Invalid form data\"})}const result=await submitDealDetails(token.trim(),formData);return res.json({success:true,submissionId:result.submissionId,dealId:result.dealId,contractReadyToken:result.contractReadyToken||null})}catch(error){console.error(\"[DealDetailsTokens] Submit Error:\",error);return res.status(500).json({success:false,error:error.message||\"An error occurred. Please try again later.\"})}});var dealDetailsTokens_default=router;export{dealDetailsTokens_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/dealDetailsTokens.ts"],"sourcesContent":[null]}}