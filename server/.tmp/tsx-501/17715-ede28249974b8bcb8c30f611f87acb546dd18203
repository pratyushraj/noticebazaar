{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import crypto from\"crypto\";import{supabase}from\"../lib/supabase.js\";function getMeonConfig(){return{baseUrl:(process.env.MEON_BASE_URL||\"https://esign.meon.co.in\").replace(/\\/$/,\"\"),username:process.env.MEON_USERNAME||\"\",clientSecretKey:process.env.MEON_CLIENT_SECRET_KEY||\"\",webhookSecret:process.env.MEON_WEBHOOK_SECRET||\"\"}}__name(getMeonConfig,\"getMeonConfig\");async function uploadPDF(buffer,fileName){try{const cfg=getMeonConfig();if(!cfg.username||!cfg.clientSecretKey){return{success:false,error:\"Meon is not configured properly.\"}}const documentData=buffer.toString(\"base64\");const signature=cfg.clientSecretKey;const uploadUrl=`${cfg.baseUrl}/EsignServices/uploadPDF`;console.log(\"[Meon] Uploading PDF to:\",uploadUrl);console.log(\"[Meon] Document name:\",fileName);console.log(\"[Meon] Document size:\",buffer.length,\"bytes\");console.log(\"[Meon] Document size (base64):\",documentData.length,\"chars\");const protocol=process.env.NODE_ENV===\"production\"?\"https\":\"http\";const host=process.env.WEBHOOK_HOST||\"localhost:3001\";const webhookUrl=`${protocol}://${host}/api/esign/webhook`;const requestBody={name:\"\",document_name:fileName,email:\"\",mobile:\"\",reason:\"Contract Signing\",days_to_expire:\"7\",coordinate:[],webhook:webhookUrl,redirect_url:\"\",cancel_redirect_url:\"\",esign_type:\"EKYC\",remove_preview_pdf:false,need_name_match:false,debit:false,percentage_name_match:80,need_aadhaar_match:false,aadhaar_number:\"\",need_gender_match:false,gender:\"\",document_data:documentData};const axios=(await import(\"axios\").then(s=>{const e=\"default\";return s[e]&&typeof s[e]==\"object\"&&\"__esModule\"in s[e]?s[e]:s})).default;console.log(\"[Meon] Request details:\",{url:uploadUrl,hasSignature:!!signature,signatureLength:signature?.length,documentSize:buffer.length,base64Size:documentData.length});const res=await axios.post(uploadUrl,requestBody,{headers:{\"Content-Type\":\"application/json\",\"signature\":signature},timeout:3e4,validateStatus:__name(()=>true,\"validateStatus\")});console.log(\"[Meon] Upload response status:\",res.status);console.log(\"[Meon] Upload response data:\",JSON.stringify(res.data));if(res.status>=400){const errorMsg=res.data?.message||res.data?.error||`HTTP ${res.status}: ${res.statusText}`;console.error(\"[Meon] API returned error status:\",{status:res.status,statusText:res.statusText,error:errorMsg,fullResponse:res.data});return{success:false,error:errorMsg}}if(!res.data?.success&&res.data?.message){return{success:false,error:res.data.message||\"Meon API returned an error\"}}const token=res.data?.token;const esignUrl=res.data?.esign_url;if(!token){return{success:false,error:res.data?.message||\"No token received from Meon API\"}}return{success:true,fileId:token,token,esignUrl}}catch(err){console.error(\"[Meon] Upload error:\",{message:err.message,status:err.response?.status,statusText:err.response?.statusText,data:err.response?.data,url:err.config?.url});let errorMessage=err.message||\"Unknown error\";if(err.response?.data){if(typeof err.response.data===\"string\"){errorMessage=err.response.data}else if(err.response.data.message||err.response.data.error){errorMessage=err.response.data.message||err.response.data.error}else{errorMessage=JSON.stringify(err.response.data)}}return{success:false,error:errorMessage}}}__name(uploadPDF,\"uploadPDF\");async function createInvite(fileId,signers,callbackUrl){try{return{success:true,invitationId:fileId,signUrl:\"\"}}catch(err){return{success:false,error:err.message}}}__name(createInvite,\"createInvite\");async function getInviteStatus(invitationId){try{const cfg=getMeonConfig();const res=await fetch(`${cfg.baseUrl}/invite/${invitationId}`,{headers:{username:cfg.username,client_secret_key:cfg.clientSecretKey}});if(!res.ok)return{success:false,error:\"Could not get invitation status.\"};const data=await res.json();return{success:true,status:data?.status||data?.data?.status,data}}catch(err){return{success:false,error:err.message}}}__name(getInviteStatus,\"getInviteStatus\");async function downloadSignedPDF(invitationId){try{const cfg=getMeonConfig();const res=await fetch(`${cfg.baseUrl}/invite/${invitationId}/signedDocument`,{headers:{username:cfg.username,client_secret_key:cfg.clientSecretKey}});if(!res.ok)return{success:false,error:\"Could not download signed PDF.\"};const buffer=Buffer.from(await res.arrayBuffer());return{success:true,pdfBuffer:buffer}}catch(err){return{success:false,error:err.message}}}__name(downloadSignedPDF,\"downloadSignedPDF\");function verifyWebhookSignature(req,body){const cfg=getMeonConfig();if(!cfg.webhookSecret)return true;const signature=req.headers[\"x-meon-signature\"];if(!signature)return false;const expected=crypto.createHmac(\"sha256\",cfg.webhookSecret).update(body).digest(\"hex\");return signature===expected}__name(verifyWebhookSignature,\"verifyWebhookSignature\");async function downloadPDFFromUrl(url){console.log(\"[Meon] Downloading PDF from URL:\",url);try{const response=await fetch(url,{headers:{\"Accept\":\"application/pdf, */*\"}});if(response.ok){const buffer=Buffer.from(await response.arrayBuffer());console.log(\"[Meon] PDF downloaded successfully via direct fetch, size:\",buffer.length,\"bytes\");return buffer}console.warn(\"[Meon] Direct fetch failed:\",{status:response.status,statusText:response.statusText})}catch(error){console.warn(\"[Meon] Direct fetch error:\",error.message)}if(url.includes(\"supabase.co\")&&url.includes(\"/storage/v1/object/public/\")&&supabase){try{const urlMatch=url.match(/\\/storage\\/v1\\/object\\/public\\/([^/]+)\\/(.+)$/);if(urlMatch){const bucketName=urlMatch[1];let filePath=decodeURIComponent(urlMatch[2].split(\"?\")[0]);console.log(\"[Meon] Trying Supabase Storage API:\",{bucketName,filePath});const{data,error}=await supabase.storage.from(bucketName).download(filePath);if(!error&&data){const buffer=Buffer.from(await data.arrayBuffer());console.log(\"[Meon] PDF downloaded successfully via Supabase Storage API, size:\",buffer.length,\"bytes\");return buffer}console.error(\"[Meon] Supabase Storage API download failed:\",error)}}catch(error){console.error(\"[Meon] Supabase Storage API error:\",error.message)}}throw new Error(`Failed to download PDF from URL: ${url}`)}__name(downloadPDFFromUrl,\"downloadPDFFromUrl\");export{createInvite,downloadPDFFromUrl,downloadSignedPDF,getInviteStatus,uploadPDF,verifyWebhookSignature};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/meonService.ts"],"sourcesContent":[null]}}