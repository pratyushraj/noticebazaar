{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import crypto from\"crypto\";const GRAPH_VERSION=process.env.META_GRAPH_VERSION||\"v22.0\";const GRAPH_BASE=`https://graph.facebook.com/${GRAPH_VERSION}`;const FB_DIALOG_BASE=`https://www.facebook.com/${GRAPH_VERSION}/dialog/oauth`;const REQUIRED_SCOPES=(process.env.META_SCOPES||\"instagram_basic\").split(\",\").map(s=>s.trim()).filter(Boolean);function assertMetaEnv(){if(!process.env.META_APP_ID||!process.env.META_APP_SECRET||!process.env.META_REDIRECT_URI){throw new Error(\"Missing META_APP_ID, META_APP_SECRET, or META_REDIRECT_URI\")}}__name(assertMetaEnv,\"assertMetaEnv\");function b64urlEncode(input){return Buffer.from(input,\"utf8\").toString(\"base64\").replace(/\\+/g,\"-\").replace(/\\//g,\"_\").replace(/=+$/g,\"\")}__name(b64urlEncode,\"b64urlEncode\");function b64urlDecode(input){const base64=input.replace(/-/g,\"+\").replace(/_/g,\"/\");const pad=4-(base64.length%4||4);return Buffer.from(base64+\"=\".repeat(pad),\"base64\").toString(\"utf8\")}__name(b64urlDecode,\"b64urlDecode\");function signPayload(payload){return crypto.createHmac(\"sha256\",process.env.META_APP_SECRET||\"creatorarmour\").update(payload).digest(\"hex\")}__name(signPayload,\"signPayload\");function createInstagramOAuthState(params){const payload=JSON.stringify({creatorId:params.creatorId,returnTo:params.returnTo||\"\",ts:Date.now()});const encoded=b64urlEncode(payload);const sig=signPayload(encoded);return`${encoded}.${sig}`}__name(createInstagramOAuthState,\"createInstagramOAuthState\");function parseInstagramOAuthState(state){const[encoded,sig]=(state||\"\").split(\".\");if(!encoded||!sig){throw new Error(\"Invalid state\")}const expectedSig=signPayload(encoded);if(expectedSig!==sig){throw new Error(\"Invalid state signature\")}const parsed=JSON.parse(b64urlDecode(encoded));const createdAt=Number(parsed.ts||0);const maxAgeMs=15*60*1e3;if(!createdAt||Date.now()-createdAt>maxAgeMs){throw new Error(\"State expired\")}if(!parsed.creatorId){throw new Error(\"State missing creator id\")}return{creatorId:parsed.creatorId,returnTo:parsed.returnTo||\"\"}}__name(parseInstagramOAuthState,\"parseInstagramOAuthState\");function getInstagramOAuthUrl(state){assertMetaEnv();const params=new URLSearchParams({client_id:process.env.META_APP_ID||\"\",redirect_uri:process.env.META_REDIRECT_URI||\"\",response_type:\"code\",scope:REQUIRED_SCOPES.join(\",\"),state});if(process.env.META_FB_CONFIG_ID){params.set(\"config_id\",process.env.META_FB_CONFIG_ID)}return`${FB_DIALOG_BASE}?${params.toString()}`}__name(getInstagramOAuthUrl,\"getInstagramOAuthUrl\");async function graphGet(path,params){const qs=new URLSearchParams(params);const url=`${GRAPH_BASE}${path}?${qs.toString()}`;const res=await fetch(url,{method:\"GET\"});const text=await res.text();let json={};try{json=JSON.parse(text)}catch{json={raw:text}}if(!res.ok||json?.error){throw new Error(`Graph GET failed (${res.status}): ${json?.error?.message||text}`)}return json}__name(graphGet,\"graphGet\");async function exchangeCodeForTokens(code){assertMetaEnv();const first=await graphGet(\"/oauth/access_token\",{client_id:process.env.META_APP_ID||\"\",client_secret:process.env.META_APP_SECRET||\"\",redirect_uri:process.env.META_REDIRECT_URI||\"\",code});const shortToken=first.access_token;const longLived=await graphGet(\"/oauth/access_token\",{grant_type:\"fb_exchange_token\",client_id:process.env.META_APP_ID||\"\",client_secret:process.env.META_APP_SECRET||\"\",fb_exchange_token:shortToken});const token=longLived.access_token||shortToken;const expiresIn=Number(longLived.expires_in||first.expires_in||0);const expiresAt=expiresIn>0?new Date(Date.now()+expiresIn*1e3).toISOString():new Date(Date.now()+55*24*60*60*1e3).toISOString();return{userAccessToken:token,userExpiresAt:expiresAt}}__name(exchangeCodeForTokens,\"exchangeCodeForTokens\");async function resolveInstagramBusinessAccount(userAccessToken){const pages=await graphGet(\"/me/accounts\",{access_token:userAccessToken,fields:\"id,name,access_token\",limit:\"20\"});for(const page of pages?.data||[]){try{const pageData=await graphGet(`/${page.id}`,{access_token:page.access_token,fields:\"instagram_business_account{id,username,profile_picture_url,followers_count}\"});const ig=pageData?.instagram_business_account;if(ig?.id&&ig?.username){return{pageId:page.id,pageAccessToken:page.access_token,igUserId:ig.id,igUsername:ig.username,profilePhoto:ig.profile_picture_url||null,followersCount:typeof ig.followers_count===\"number\"?ig.followers_count:null}}}catch(e){}}throw new Error(\"No Instagram business account connected to managed pages\")}__name(resolveInstagramBusinessAccount,\"resolveInstagramBusinessAccount\");function median(values){if(!values.length)return null;const sorted=[...values].sort((a,b)=>a-b);const mid=Math.floor(sorted.length/2);if(sorted.length%2===0)return Math.round((sorted[mid-1]+sorted[mid])/2);return Math.round(sorted[mid])}__name(median,\"median\");async function fetchMediaInsights(mediaId,pageAccessToken){const metrics=[\"views\",\"video_views\",\"plays\",\"reach\",\"impressions\",\"saved\",\"shares\",\"likes\",\"comments\"];const result={};for(const metric of metrics){try{const data=await graphGet(`/${mediaId}/insights`,{access_token:pageAccessToken,metric});const value=data?.data?.[0]?.values?.[0]?.value;if(typeof value===\"number\")result[metric]=value}catch{}}return result}__name(fetchMediaInsights,\"fetchMediaInsights\");async function fetchInstagramPerformanceSummary(igUserId,pageAccessToken,followersCount){const mediaData=await graphGet(`/${igUserId}/media`,{access_token:pageAccessToken,fields:\"id,caption,media_type,media_product_type,timestamp,like_count,comments_count,permalink\",limit:\"20\"});const media=Array.isArray(mediaData?.data)?mediaData.data:[];const reels=media.filter(m=>(m.media_product_type||\"\").toUpperCase()===\"REELS\"||(m.media_type||\"\").toUpperCase()===\"VIDEO\");const rows=[];for(const m of reels.slice(0,10)){const insights=await fetchMediaInsights(m.id,pageAccessToken);const likes=Number(insights.likes??m.like_count??0);const comments=Number(insights.comments??m.comments_count??0);const saves=Number(insights.saved??0);const shares=Number(insights.shares??0);const views=Number(insights.views??insights.video_views??insights.plays??insights.impressions??0);rows.push({id:m.id,views,likes,comments,saves,shares,timestamp:m.timestamp})}const sampleSize=rows.length;const totalLikes=rows.reduce((sum,r)=>sum+r.likes,0);const totalComments=rows.reduce((sum,r)=>sum+r.comments,0);const totalSaves=rows.reduce((sum,r)=>sum+r.saves,0);const totalShares=rows.reduce((sum,r)=>sum+r.shares,0);const avgLikes=sampleSize>0?totalLikes/sampleSize:0;const avgComments=sampleSize>0?totalComments/sampleSize:0;const avgSaves=sampleSize>0?totalSaves/sampleSize:0;const avgShares=sampleSize>0?totalShares/sampleSize:0;const medianReelViews=median(rows.map(r=>r.views).filter(v=>Number.isFinite(v)&&v>0));const engagementRate=followersCount&&followersCount>0?(avgLikes+avgComments+avgSaves+avgShares)/followersCount:null;return{sampleSize,medianReelViews,avgLikes:Math.round(avgLikes),avgComments:Math.round(avgComments),avgSaves:Math.round(avgSaves),avgShares:Math.round(avgShares),engagementRate,dataQuality:sampleSize>=5?\"verified\":\"limited\",media:rows}}__name(fetchInstagramPerformanceSummary,\"fetchInstagramPerformanceSummary\");export{createInstagramOAuthState,exchangeCodeForTokens,fetchInstagramPerformanceSummary,getInstagramOAuthUrl,parseInstagramOAuthState,resolveInstagramBusinessAccount};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/instagramGraphService.ts"],"sourcesContent":[null]}}