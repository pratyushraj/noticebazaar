{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase}from\"../lib/supabase.js\";async function createBrandReplyToken(options){const{dealId,creatorId,expiresAt}=options;if(!dealId||!creatorId){throw new Error(\"dealId and creatorId are required\")}const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"id, creator_id\").eq(\"id\",dealId).eq(\"creator_id\",creatorId).maybeSingle();if(dealError||!deal){throw new Error(\"Deal not found or access denied\")}const{data:token,error:tokenError}=await supabase.from(\"brand_reply_tokens\").insert({deal_id:dealId,created_by:creatorId,expires_at:expiresAt?expiresAt.toISOString():null,is_active:true}).select().single();if(tokenError||!token){console.error(\"[BrandReplyTokenService] Token creation error:\",tokenError);throw new Error(\"Failed to create brand reply token\")}return token}__name(createBrandReplyToken,\"createBrandReplyToken\");async function revokeBrandReplyToken(tokenId,creatorId){const result=await supabase.from(\"brand_reply_tokens\").select(\"id, created_by\").eq(\"id\",tokenId).maybeSingle();const token=result.data;const tokenError=result.error;if(tokenError||!token){throw new Error(\"Token not found\")}if(token.created_by!==creatorId){throw new Error(\"Access denied\")}const{error:updateError}=await supabase.from(\"brand_reply_tokens\").update({is_active:false,revoked_at:new Date().toISOString(),revoked_by:creatorId}).eq(\"id\",tokenId);if(updateError){console.error(\"[BrandReplyTokenService] Token revocation error:\",updateError);throw new Error(\"Failed to revoke token\")}}__name(revokeBrandReplyToken,\"revokeBrandReplyToken\");async function getAuditSummary(dealId,creatorId){const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"id, creator_id\").eq(\"id\",dealId).eq(\"creator_id\",creatorId).maybeSingle();if(dealError||!deal){throw new Error(\"Deal not found or access denied\")}const{data:tokens,error:tokensError}=await supabase.from(\"brand_reply_tokens\").select(\"id\").eq(\"deal_id\",dealId).eq(\"created_by\",creatorId);if(tokensError||!tokens||tokens.length===0){return{firstViewedAt:null,latestDecision:null,lastUpdatedAt:null}}const tokenIds=tokens.map(t=>t.id);const firstViewedResult=await supabase.from(\"brand_reply_audit_log\").select(\"action_timestamp\").eq(\"deal_id\",dealId).eq(\"action_type\",\"viewed\").in(\"reply_token_id\",tokenIds).order(\"action_timestamp\",{ascending:true}).limit(1).maybeSingle();const firstViewed=firstViewedResult.data;const latestDecisionResult=await supabase.from(\"brand_reply_audit_log\").select(\"action_type, action_timestamp\").eq(\"deal_id\",dealId).in(\"action_type\",[\"accepted\",\"negotiation_requested\",\"rejected\",\"updated_response\"]).in(\"reply_token_id\",tokenIds).order(\"action_timestamp\",{ascending:false}).limit(1).maybeSingle();const latestDecision=latestDecisionResult.data;return{firstViewedAt:firstViewed?firstViewed.action_timestamp:null,latestDecision:latestDecision?latestDecision.action_type:null,lastUpdatedAt:latestDecision?latestDecision.action_timestamp:null}}__name(getAuditSummary,\"getAuditSummary\");export{createBrandReplyToken,getAuditSummary,revokeBrandReplyToken};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/brandReplyTokenService.ts"],"sourcesContent":[null]}}