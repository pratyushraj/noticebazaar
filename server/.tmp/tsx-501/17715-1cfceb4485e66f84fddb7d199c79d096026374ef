{"code":"import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";import{getShippingTokenInfo,useShippingToken}from\"../services/shippingTokenService.js\";import{sendCreatorProductShippedEmail}from\"../services/shippingEmailService.js\";const router=Router();router.get(\"/:token\",async(req,res)=>{try{const{token}=req.params;if(!token||typeof token!==\"string\"||token.trim()===\"\"){return res.status(400).json({success:false,error:\"Invalid token\"})}const info=await getShippingTokenInfo(token.trim());if(!info){return res.status(404).json({success:false,error:\"This link is invalid or has expired. Please contact the creator for a new link.\"})}return res.json({success:true,dealId:info.dealId,creatorName:info.creatorName,creatorCity:info.creatorCity,productDescription:info.productDescription,brandName:info.brandName})}catch(error){console.error(\"[Shipping] GET error:\",error);return res.status(500).json({success:false,error:\"An error occurred. Please try again later.\"})}});router.post(\"/:token\",async(req,res)=>{try{const{token}=req.params;const{courier_name,tracking_number,tracking_url,expected_delivery_date}=req.body;if(!token||typeof token!==\"string\"||token.trim()===\"\"){return res.status(400).json({success:false,error:\"Invalid token\"})}if(!courier_name||typeof courier_name!==\"string\"||!courier_name.trim()){return res.status(400).json({success:false,error:\"Courier name is required\"})}if(!tracking_number||typeof tracking_number!==\"string\"||!tracking_number.trim()){return res.status(400).json({success:false,error:\"Tracking number is required\"})}const info=await getShippingTokenInfo(token.trim());if(!info){return res.status(404).json({success:false,error:\"This link is invalid or has expired. Please contact the creator for a new link.\"})}const dealId=await useShippingToken(token.trim());if(!dealId){return res.status(400).json({success:false,error:\"This link has already been used. Contact the creator if you need to update shipping.\"})}const now=new Date().toISOString();const expectedDate=expected_delivery_date?typeof expected_delivery_date===\"string\"?expected_delivery_date.trim():null:null;const{error:updateError}=await supabase.from(\"brand_deals\").update({shipping_status:\"shipped\",courier_name:courier_name.trim(),tracking_number:tracking_number.trim(),tracking_url:tracking_url&&typeof tracking_url===\"string\"?tracking_url.trim()||null:null,expected_delivery_date:expectedDate||null,shipped_at:now,updated_at:now}).eq(\"id\",dealId);if(updateError){console.error(\"[Shipping] Update brand_deals error:\",updateError);return res.status(500).json({success:false,error:\"Failed to save shipping details. Please try again.\"})}await supabase.from(\"deal_action_logs\").insert({deal_id:dealId,event:\"shipping_marked_shipped\",metadata:{courier_name:courier_name.trim(),tracking_number:tracking_number.trim()}}).then(()=>{}).catch(e=>console.warn(\"[Shipping] Audit log insert failed:\",e));try{const{data:deal}=await supabase.from(\"brand_deals\").select(\"creator_id, brand_name, courier_name, tracking_number, tracking_url\").eq(\"id\",dealId).single();if(deal?.creator_id){const{data:profile}=await supabase.from(\"profiles\").select(\"email, first_name, last_name\").eq(\"id\",deal.creator_id).maybeSingle();const creatorEmail=profile?.email;const creatorName=profile?`${(profile.first_name||\"\").trim()} ${(profile.last_name||\"\").trim()}`.trim()||\"Creator\":\"Creator\";if(creatorEmail){sendCreatorProductShippedEmail(creatorEmail,{creatorName,brandName:deal.brand_name||\"Brand\",courierName:courier_name.trim(),trackingNumber:tracking_number.trim(),trackingUrl:tracking_url&&typeof tracking_url===\"string\"?tracking_url.trim()||void 0:void 0}).catch(e=>console.error(\"[Shipping] Creator email failed:\",e))}}}catch(emailErr){console.error(\"[Shipping] Creator notification error:\",emailErr)}return res.json({success:true,message:\"Shipping details saved. The creator has been notified.\"})}catch(error){console.error(\"[Shipping] POST error:\",error);return res.status(500).json({success:false,error:\"An error occurred. Please try again later.\"})}});var shipping_default=router;export{shipping_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/shipping.ts"],"sourcesContent":[null]}}