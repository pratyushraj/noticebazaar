{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase}from\"../lib/supabase.js\";async function generateCreatorSigningToken(dealId,creatorId,creatorEmail){try{await supabase.from(\"creator_signing_tokens\").update({is_valid:false}).eq(\"deal_id\",dealId).eq(\"is_valid\",true);const{data,error}=await supabase.from(\"creator_signing_tokens\").insert({deal_id:dealId,creator_id:creatorId,creator_email:creatorEmail,expires_at:new Date(Date.now()+7*24*60*60*1e3).toISOString(),is_valid:true}).select(\"token\").single();if(error){console.error(\"[CreatorSigningTokenService] Error creating token:\",error);return{success:false,error:\"Failed to generate signing token\"}}return{success:true,token:data.token}}catch(error){console.error(\"[CreatorSigningTokenService] Exception:\",error);return{success:false,error:error.message||\"Failed to generate token\"}}}__name(generateCreatorSigningToken,\"generateCreatorSigningToken\");async function validateCreatorSigningToken(token){try{const{data:tokenData,error:tokenError}=await supabase.from(\"creator_signing_tokens\").select(`\n        *,\n        deal:brand_deals(*)\n      `).eq(\"token\",token).eq(\"is_valid\",true).maybeSingle();if(tokenError){console.error(\"[CreatorSigningTokenService] Token lookup error:\",tokenError);return{success:false,error:\"Invalid or expired signing link\"}}if(!tokenData){return{success:false,error:\"This signing link is invalid or has already been used.\"}}if(new Date(tokenData.expires_at)<new Date){await supabase.from(\"creator_signing_tokens\").update({is_valid:false}).eq(\"id\",tokenData.id);return{success:false,error:\"This signing link has expired. Please contact the brand for a new link.\"}}if(tokenData.used_at){return{success:false,error:\"This signing link has already been used.\"}}const deal=tokenData.deal;if(deal.status!==\"SIGNED_BY_BRAND\"&&deal.status!==\"AWAITING_CREATOR_SIGNATURE\"){return{success:false,error:\"This contract is not ready for signing. Current status: \"+deal.status}}const{data:existingSignature}=await supabase.from(\"contract_signatures\").select(\"signed\").eq(\"deal_id\",tokenData.deal_id).eq(\"signer_role\",\"creator\").eq(\"signed\",true).maybeSingle();if(existingSignature){return{success:false,error:\"You have already signed this contract.\"}}return{success:true,tokenData,dealData:deal}}catch(error){console.error(\"[CreatorSigningTokenService] Validation exception:\",error);return{success:false,error:\"Failed to validate signing link\"}}}__name(validateCreatorSigningToken,\"validateCreatorSigningToken\");async function markTokenAsUsed(token){try{const{error}=await supabase.from(\"creator_signing_tokens\").update({used_at:new Date().toISOString(),is_valid:false}).eq(\"token\",token);if(error){console.error(\"[CreatorSigningTokenService] Error marking token as used:\",error);return{success:false}}return{success:true}}catch(error){console.error(\"[CreatorSigningTokenService] Exception marking token:\",error);return{success:false}}}__name(markTokenAsUsed,\"markTokenAsUsed\");export{generateCreatorSigningToken,markTokenAsUsed,validateCreatorSigningToken};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/creatorSigningTokenService.ts"],"sourcesContent":[null]}}