{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase}from\"../lib/supabase.js\";const CREATOR_ASSETS_BUCKET=\"creator-assets\";async function generateInvoice(dealId){try{const result=await supabase.from(\"brand_deals\").select(\"invoice_url, invoice_number\").eq(\"id\",dealId).single();const existingDeal=result.data;if(existingDeal&&existingDeal.invoice_url&&existingDeal.invoice_number){console.log(`[InvoiceService] Invoice already exists for deal ${dealId}`);return{success:true,invoiceUrl:existingDeal.invoice_url,invoiceNumber:existingDeal.invoice_number}}const dealResult=await supabase.from(\"brand_deals\").select(`\n        id,\n        brand_name,\n        deal_amount,\n        deliverables,\n        due_date,\n        payment_expected_date,\n        creator_id,\n        otp_verified_at\n      `).eq(\"id\",dealId).single();const deal=dealResult.data;const dealError=dealResult.error;if(dealError||!deal){return{success:false,error:\"Deal not found\"}}const profileResult=await supabase.from(\"profiles\").select(\"id, first_name, last_name, email, phone, gst_number, pan_number, bank_account_name, bank_account_number, bank_ifsc\").eq(\"id\",deal.creator_id).single();const creatorProfile=profileResult.data;const creatorError=profileResult.error;if(creatorError||!creatorProfile){return{success:false,error:\"Creator profile not found\"}}const year=new Date().getFullYear();const shortDealId=dealId.substring(0,8).toUpperCase();const invoiceNumber=`INV-${year}-${shortDealId}`;const creatorName=`${creatorProfile.first_name||\"\"} ${creatorProfile.last_name||\"\"}`.trim()||\"Creator\";const pdfBuffer=await generateInvoicePDF({dealId,brandName:deal.brand_name,creatorName,creatorEmail:creatorProfile.email||\"\",dealAmount:deal.deal_amount||0,dueDate:deal.due_date||\"\",paymentExpectedDate:deal.payment_expected_date||void 0,deliverables:deal.deliverables||\"\",invoiceNumber,signedAt:deal.otp_verified_at||void 0});const fileName=`invoice-${dealId}-${Date.now()}.pdf`;const filePath=`${deal.creator_id}/invoices/${fileName}`;const{error:uploadError}=await supabase.storage.from(CREATOR_ASSETS_BUCKET).upload(filePath,pdfBuffer,{contentType:\"application/pdf\",cacheControl:\"3600\",upsert:false});if(uploadError){console.error(\"[InvoiceService] Upload error:\",uploadError);return{success:false,error:`Failed to upload invoice: ${uploadError.message}`}}const{data:urlData}=supabase.storage.from(CREATOR_ASSETS_BUCKET).getPublicUrl(filePath);if(!urlData?.publicUrl){return{success:false,error:\"Failed to get public URL for invoice\"}}const{error:updateError}=await supabase.from(\"brand_deals\").update({invoice_url:urlData.publicUrl,invoice_number:invoiceNumber,updated_at:new Date().toISOString()}).eq(\"id\",dealId);if(updateError){console.error(\"[InvoiceService] Update error:\",updateError)}return{success:true,invoiceUrl:urlData.publicUrl,invoiceNumber}}catch(error){console.error(\"[InvoiceService] Error:\",error);return{success:false,error:error.message||\"Failed to generate invoice\"}}}__name(generateInvoice,\"generateInvoice\");async function generateInvoicePDF(data){const PDFDocument=(await import(\"pdfkit\").then(s=>{const e=\"default\";return s[e]&&typeof s[e]==\"object\"&&\"__esModule\"in s[e]?s[e]:s})).default;return new Promise((resolve,reject)=>{try{const doc=new PDFDocument({size:\"A4\",margin:50});const chunks=[];doc.on(\"data\",chunk=>chunks.push(chunk));doc.on(\"end\",()=>resolve(Buffer.concat(chunks)));doc.on(\"error\",reject);doc.fontSize(24).fillColor(\"#7C3AED\").text(\"CreatorArmour\",50,50);doc.fontSize(12).fillColor(\"#666\").text(\"Legal Invoice & Receipt\",50,80);doc.fontSize(10).fillColor(\"#000\").text(`Invoice Number: ${data.invoiceNumber}`,400,50,{align:\"right\"});doc.text(`Date: ${new Date().toLocaleDateString(\"en-IN\",{day:\"2-digit\",month:\"short\",year:\"numeric\"})}`,400,70,{align:\"right\"});doc.fontSize(14).fillColor(\"#000\").text(\"From:\",50,130);doc.fontSize(12).text(data.creatorName,50,150);if(data.creatorEmail){doc.fontSize(10).fillColor(\"#666\").text(data.creatorEmail,50,170)}doc.fontSize(14).fillColor(\"#000\").text(\"To:\",350,130);doc.fontSize(12).text(data.brandName,350,150);doc.moveTo(50,220).lineTo(550,220).stroke();doc.fontSize(16).fillColor(\"#000\").text(\"Invoice Details\",50,240);doc.fontSize(12).fillColor(\"#000\").text(\"Description:\",50,270);doc.fontSize(11).fillColor(\"#333\").text(data.deliverables||\"Brand collaboration services\",50,290,{width:500});const yPos=350;doc.fontSize(12).fillColor(\"#000\").text(\"Amount:\",50,yPos);doc.fontSize(16).fillColor(\"#7C3AED\").text(`\\u20B9${data.dealAmount.toLocaleString(\"en-IN\")}`,400,yPos,{align:\"right\"});if(data.paymentExpectedDate){doc.fontSize(10).fillColor(\"#666\").text(`Payment Due: ${new Date(data.paymentExpectedDate).toLocaleDateString(\"en-IN\",{day:\"2-digit\",month:\"short\",year:\"numeric\"})}`,50,yPos+40)}doc.fontSize(9).fillColor(\"#999\").text(\"This invoice is generated automatically after contract acceptance via OTP verification.\",50,700,{align:\"center\",width:500});if(data.signedAt){doc.text(`Contract signed on: ${new Date(data.signedAt).toLocaleDateString(\"en-IN\",{day:\"2-digit\",month:\"short\",year:\"numeric\"})}`,50,720,{align:\"center\",width:500})}doc.text(\"CreatorArmour \\u2022 Secure Legal Portal\",50,750,{align:\"center\",width:500});doc.end()}catch(error){reject(error)}})}__name(generateInvoicePDF,\"generateInvoicePDF\");export{generateInvoice};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/invoiceService.ts"],"sourcesContent":[null]}}