{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase}from\"../lib/supabase.js\";import{fetchInstagramPublicData}from\"../services/instagramService.js\";const syncSingleCreatorInstagram=__name(async(creatorId,instagramUsername)=>{let username=instagramUsername?.replace(/^@+/,\"\").trim().toLowerCase()||null;if(!username){const{data:profile,error}=await supabase.from(\"profiles\").select(\"instagram_handle\").eq(\"id\",creatorId).maybeSingle();if(error)return{success:false,reason:\"profile_fetch_failed\"};username=(profile?.instagram_handle||\"\").replace(/^@+/,\"\").trim().toLowerCase()||null}if(!username)return{success:false,reason:\"instagram_not_set\"};const data=await fetchInstagramPublicData(username);if(!data)return{success:false,reason:\"instagram_fetch_failed\"};const payload={last_instagram_sync:new Date().toISOString()};if(typeof data.followers===\"number\")payload.instagram_followers=data.followers;if(data.profile_photo)payload.instagram_profile_photo=data.profile_photo;const{error:updateError}=await supabase.from(\"profiles\").update(payload).eq(\"id\",creatorId);if(updateError)return{success:false,reason:\"profile_update_failed\"};return{success:true,profile_photo:data.profile_photo,followers:data.followers}},\"syncSingleCreatorInstagram\");const syncInstagramStats=__name(async()=>{const{data:creators,error}=await supabase.from(\"profiles\").select(\"id, instagram_handle\").eq(\"role\",\"creator\").not(\"instagram_handle\",\"is\",null);if(error){throw new Error(`Failed to fetch creators for Instagram sync: ${error.message}`)}const rows=Array.isArray(creators)?creators:[];let updated=0;for(const creator of rows){const handle=creator?.instagram_handle;const creatorId=creator?.id;if(!handle||!creatorId)continue;const data=await fetchInstagramPublicData(handle);if(!data)continue;const payload={last_instagram_sync:new Date().toISOString()};if(data.followers!==null)payload.instagram_followers=data.followers;if(data.profile_photo)payload.instagram_profile_photo=data.profile_photo;const{error:updateError}=await supabase.from(\"profiles\").update(payload).eq(\"id\",creatorId);if(!updateError)updated++}return{checked:rows.length,updated}},\"syncInstagramStats\");export{syncInstagramStats,syncSingleCreatorInstagram};\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAS,aAAgB,qBACzB,OAAS,6BAAgC,kCAElC,MAAM,2BAA6B,aACxC,UACA,oBAMI,CACJ,IAAI,SAAW,mBAAmB,QAAQ,MAAO,EAAE,EAAE,KAAK,EAAE,YAAY,GAAK,KAE7E,GAAI,CAAC,SAAU,CACb,KAAM,CAAE,KAAM,QAAS,KAAM,EAAI,MAAM,SACpC,KAAK,UAAU,EACf,OAAO,kBAAkB,EACzB,GAAG,KAAM,SAAS,EAClB,YAAY,EACf,GAAI,MAAO,MAAO,CAAE,QAAS,MAAO,OAAQ,sBAAuB,EACnE,UAAa,SAAiB,kBAAoB,IAAI,QAAQ,MAAO,EAAE,EAAE,KAAK,EAAE,YAAY,GAAK,IACnG,CAEA,GAAI,CAAC,SAAU,MAAO,CAAE,QAAS,MAAO,OAAQ,mBAAoB,EAEpE,MAAM,KAAO,MAAM,yBAAyB,QAAQ,EACpD,GAAI,CAAC,KAAM,MAAO,CAAE,QAAS,MAAO,OAAQ,wBAAyB,EAErE,MAAM,QAAmC,CACvC,oBAAqB,IAAI,KAAK,EAAE,YAAY,CAC9C,EACA,GAAI,OAAO,KAAK,YAAc,SAAU,QAAQ,oBAAsB,KAAK,UAC3E,GAAI,KAAK,cAAe,QAAQ,wBAA0B,KAAK,cAE/D,KAAM,CAAE,MAAO,WAAY,EAAI,MAAM,SAClC,KAAK,UAAU,EACf,OAAO,OAAc,EACrB,GAAG,KAAM,SAAS,EAErB,GAAI,YAAa,MAAO,CAAE,QAAS,MAAO,OAAQ,uBAAwB,EAE1E,MAAO,CACL,QAAS,KACT,cAAe,KAAK,cACpB,UAAW,KAAK,SAClB,CACF,EA5C0C,8BA8CnC,MAAM,mBAAqB,gBAA2D,CAC3F,KAAM,CAAE,KAAM,SAAU,KAAM,EAAI,MAAM,SACrC,KAAK,UAAU,EACf,OAAO,sBAAsB,EAC7B,GAAG,OAAQ,SAAS,EACpB,IAAI,mBAAoB,KAAM,IAAI,EAErC,GAAI,MAAO,CACT,MAAM,IAAI,MAAM,gDAAgD,MAAM,OAAO,EAAE,CACjF,CAEA,MAAM,KAAO,MAAM,QAAQ,QAAQ,EAAI,SAAW,CAAC,EACnD,IAAI,QAAU,EAEd,UAAW,WAAW,KAAM,CAC1B,MAAM,OAAU,SAAiB,iBACjC,MAAM,UAAa,SAAiB,GACpC,GAAI,CAAC,QAAU,CAAC,UAAW,SAE3B,MAAM,KAAO,MAAM,yBAAyB,MAAM,EAClD,GAAI,CAAC,KAAM,SAEX,MAAM,QAAmC,CACvC,oBAAqB,IAAI,KAAK,EAAE,YAAY,CAC9C,EACA,GAAI,KAAK,YAAc,KAAM,QAAQ,oBAAsB,KAAK,UAChE,GAAI,KAAK,cAAe,QAAQ,wBAA0B,KAAK,cAE/D,KAAM,CAAE,MAAO,WAAY,EAAI,MAAM,SAClC,KAAK,UAAU,EACf,OAAO,OAAc,EACrB,GAAG,KAAM,SAAS,EAErB,GAAI,CAAC,YAAa,SACpB,CAEA,MAAO,CAAE,QAAS,KAAK,OAAQ,OAAQ,CACzC,EArCkC","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/jobs/instagramSync.ts"],"sourcesContent":[null]}}