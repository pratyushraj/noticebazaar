{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{callLLM}from\"./aiContractAnalysis.js\";import{supabase}from\"../lib/supabase.js\";const RATE_LIMIT_DAILY_MAX=30;async function checkRateLimit(instagramHandle){const today=new Date;today.setHours(0,0,0,0);const{data,error}=await supabase.from(\"influencers\").select(\"last_dm_sent_at, contacted_at\").eq(\"instagram_handle\",instagramHandle).single();if(error||!data){return{allowed:true}}if(data.last_dm_sent_at){const lastSent=new Date(data.last_dm_sent_at);if(lastSent>=today){const{count}=await supabase.from(\"influencers\").select(\"*\",{count:\"exact\",head:true}).eq(\"instagram_handle\",instagramHandle).gte(\"last_dm_sent_at\",today.toISOString());if(count&&count>=RATE_LIMIT_DAILY_MAX){return{allowed:false,reason:`Rate limit exceeded: ${RATE_LIMIT_DAILY_MAX} messages/day`}}}}return{allowed:true}}__name(checkRateLimit,\"checkRateLimit\");function getDefaultTemplate(influencer){const name=influencer.creator_name.split(\" \")[0];const niche=influencer.niche||\"content\";return`Hey ${name}, loved your recent ${niche} content! We're building Creator Armour \\u2014 a platform that protects creators with contracts and payments. Would you like early access as a Founding Creator? \\u{1F680}`}__name(getDefaultTemplate,\"getDefaultTemplate\");function getFoundingCreatorTemplate(influencer){const name=influencer.creator_name.split(\" \")[0];const niche=influencer.niche||\"content\";return`Hey ${name}! Your ${niche} content is \\u{1F525} We're launching Creator Armour \\u2014 the platform that protects creators with smart contracts and secure payments. We'd love to have you as a Founding Creator with exclusive benefits. Interested?`}__name(getFoundingCreatorTemplate,\"getFoundingCreatorTemplate\");function getFollowUpTemplate(influencer){const name=influencer.creator_name.split(\" \")[0];return`Hey ${name}, just following up on my message about Creator Armour. We're helping creators protect their work and get paid fairly. Would love to chat if you're interested!`}__name(getFollowUpTemplate,\"getFollowUpTemplate\");async function generateOutreachMessage(influencer,template=\"default\"){const rateLimitCheck=await checkRateLimit(influencer.instagram_handle);if(!rateLimitCheck.allowed){throw new Error(rateLimitCheck.reason||\"Rate limit exceeded\")}let baseMessage;switch(template){case\"founding_creator\":baseMessage=getFoundingCreatorTemplate(influencer);break;case\"follow_up\":baseMessage=getFollowUpTemplate(influencer);break;default:baseMessage=getDefaultTemplate(influencer)}try{const personalized=await personalizeMessageWithAI(influencer,baseMessage,template);return personalized}catch(error){return{message:baseMessage,template_type:template,personalized:false}}}__name(generateOutreachMessage,\"generateOutreachMessage\");async function personalizeMessageWithAI(influencer,baseMessage,template){const prompt=`You are helping Creator Armour reach out to influencers.\n\nInfluencer Details:\n- Name: ${influencer.creator_name}\n- Instagram: @${influencer.instagram_handle}\n- Niche: ${influencer.niche}\n- Bio: ${influencer.bio||\"Not provided\"}\n- Followers: ${influencer.followers.toLocaleString()}\n\nTemplate Type: ${template}\n\nBase Message:\n${baseMessage}\n\nPersonalize this message (max 200 characters) to:\n1. Mention their specific content type if possible\n2. Keep it friendly and authentic\n3. Maintain the core message about Creator Armour\n4. Include a clear call-to-action\n\nReturn ONLY a valid JSON object:\n{\n  \"message\": \"<the personalized DM message text>\",\n  \"personalized\": true,\n  \"content_type\": \"<type of content mentioned>\"\n}`;try{const response=await callLLM(prompt);let jsonMatch=response.match(/\\{[\\s\\S]*\\}/);if(!jsonMatch){throw new Error(\"No JSON found in AI response\")}const outreach=JSON.parse(jsonMatch[0]);if(!outreach.message||outreach.message.length>200){throw new Error(\"Invalid message length\")}return{...outreach,template_type:template}}catch(error){throw error}}__name(personalizeMessageWithAI,\"personalizeMessageWithAI\");async function generateBatchOutreachMessages(influencers,template=\"default\"){const messages=new Map;const batchSize=5;for(let i=0;i<influencers.length;i+=batchSize){const batch=influencers.slice(i,i+batchSize);await Promise.all(batch.map(async influencer=>{try{const rateLimitCheck=await checkRateLimit(influencer.instagram_handle);if(!rateLimitCheck.allowed){console.warn(`[InfluencerOutreach] Rate limit for @${influencer.instagram_handle}: ${rateLimitCheck.reason}`);return}const message=await generateOutreachMessage(influencer,template);messages.set(influencer.instagram_handle,message)}catch(error){console.error(`[InfluencerOutreach] Error generating message for @${influencer.instagram_handle}:`,error.message);messages.set(influencer.instagram_handle,{message:getDefaultTemplate(influencer),template_type:template,personalized:false})}}));if(i+batchSize<influencers.length){await new Promise(resolve=>setTimeout(resolve,1e3))}}return messages}__name(generateBatchOutreachMessages,\"generateBatchOutreachMessages\");async function markAsContacted(instagramHandle,dmSentAt,followUpDueAt,responseStatus){const{error}=await supabase.from(\"influencers\").update({status:\"contacted\",already_contacted:true,contacted_at:dmSentAt.toISOString(),last_dm_sent_at:dmSentAt.toISOString(),follow_up_due_at:followUpDueAt?.toISOString(),response_status:responseStatus||\"pending\",updated_at:new Date().toISOString()}).eq(\"instagram_handle\",instagramHandle);if(error){throw error}}__name(markAsContacted,\"markAsContacted\");async function updateInfluencerStatus(instagramHandle,status,responseStatus){const{error}=await supabase.from(\"influencers\").update({status,response_status:responseStatus,updated_at:new Date().toISOString()}).eq(\"instagram_handle\",instagramHandle);if(error){throw error}}__name(updateInfluencerStatus,\"updateInfluencerStatus\");async function getInfluencersDueForFollowUp(){const{data,error}=await supabase.from(\"influencers\").select(\"*\").eq(\"status\",\"contacted\").not(\"follow_up_due_at\",\"is\",null).lte(\"follow_up_due_at\",new Date().toISOString()).order(\"follow_up_due_at\",{ascending:true});if(error){throw error}return data||[]}__name(getInfluencersDueForFollowUp,\"getInfluencersDueForFollowUp\");async function getUncontactedInfluencers(limit=50){const{data,error}=await supabase.from(\"influencers\").select(\"*\").eq(\"status\",\"new\").eq(\"already_contacted\",false).order(\"fit_score\",{ascending:false}).limit(limit);if(error){throw error}return data||[]}__name(getUncontactedInfluencers,\"getUncontactedInfluencers\");export{generateBatchOutreachMessages,generateOutreachMessage,getInfluencersDueForFollowUp,getUncontactedInfluencers,markAsContacted,updateInfluencerStatus};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/influencerOutreach.ts"],"sourcesContent":[null]}}