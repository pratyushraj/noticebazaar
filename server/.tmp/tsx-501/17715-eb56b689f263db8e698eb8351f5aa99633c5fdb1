{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase,supabaseInitialized}from\"../lib/supabase.js\";const authMiddleware=__name(async(req,res,next)=>{try{if(!supabaseInitialized){return res.status(500).json({error:\"Server configuration error: Supabase not initialized. Please check environment variables.\"})}console.log(`[AuthMiddleware] Hit: ${req.method} ${req.path}`,{hasAuthHeader:!!req.headers.authorization,authHeaderPrefix:req.headers.authorization?.substring(0,15)});const authHeader=req.headers.authorization;if(!authHeader||!authHeader.startsWith(\"Bearer \")){return res.status(401).json({error:\"Missing or invalid authorization header\"})}let token=authHeader.substring(7).trim();if(token.startsWith('\"')&&token.endsWith('\"')){token=token.substring(1,token.length-1)}let user,authError;try{const result=await Promise.race([supabase.auth.getUser(token),new Promise((_,reject)=>setTimeout(()=>reject(new Error(\"Auth timeout\")),5e3))]);user=result.data?.user;authError=result.error}catch(err){if(err.message===\"Auth timeout\"){return res.status(504).json({error:\"Authentication timeout - Supabase connection issue\"})}throw err}if(authError||!user){console.warn(\"[AuthMiddleware] Token verification failed:\",{event:\"auth_failure\",error:authError?.message,errorCode:authError?.status,hasUser:!!user,tokenPrefix:token.substring(0,10)+\"...\",path:req.path,method:req.method});return res.status(401).json({error:\"Invalid or expired token\",details:authError?.message||\"User not found for token\",path:req.path})}let profile;try{const profileResult=await Promise.race([supabase.from(\"profiles\").select(\"role\").eq(\"id\",user.id).single(),new Promise((_,reject)=>setTimeout(()=>reject(new Error(\"Profile timeout\")),3e3))]);profile=profileResult.data}catch(err){console.warn(\"Profile query failed, using default role:\",err.message);profile=null}req.user={id:user.id,email:user.email,role:profile?.role||\"creator\"};next()}catch(error){console.error(\"Auth middleware error:\",error);if(error.message?.includes(\"timeout\")){return res.status(504).json({error:\"Authentication timeout - Supabase connection issue\"})}res.status(500).json({error:\"Authentication failed\",details:error.message})}},\"authMiddleware\");export{authMiddleware};\n","warnings":[],"map":{"version":3,"mappings":"kHAGA,OAAS,SAAU,wBAA2B,qBAavC,MAAM,eAAiB,aAC5B,IACA,IACA,OACG,CACH,GAAI,CACF,GAAI,CAAC,oBAAqB,CACxB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,2FAA4F,CAAC,CACpI,CAGA,QAAQ,IAAI,yBAAyB,IAAI,MAAM,IAAI,IAAI,IAAI,GAAI,CAC7D,cAAe,CAAC,CAAC,IAAI,QAAQ,cAC7B,iBAAkB,IAAI,QAAQ,eAAe,UAAU,EAAG,EAAE,CAC9D,CAAC,EAED,MAAM,WAAa,IAAI,QAAQ,cAC/B,GAAI,CAAC,YAAc,CAAC,WAAW,WAAW,SAAS,EAAG,CACpD,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,yCAA0C,CAAC,CAClF,CAEA,IAAI,MAAQ,WAAW,UAAU,CAAC,EAAE,KAAK,EAEzC,GAAI,MAAM,WAAW,GAAG,GAAK,MAAM,SAAS,GAAG,EAAG,CAChD,MAAQ,MAAM,UAAU,EAAG,MAAM,OAAS,CAAC,CAC7C,CAGA,IAAI,KAAM,UACV,GAAI,CACF,MAAM,OAAS,MAAM,QAAQ,KAAK,CAChC,SAAS,KAAK,QAAQ,KAAK,EAC3B,IAAI,QAAQ,CAAC,EAAG,SAAW,WAAW,IAAM,OAAO,IAAI,MAAM,cAAc,CAAC,EAAG,GAAI,CAAC,CACtF,CAAC,EACD,KAAO,OAAO,MAAM,KACpB,UAAY,OAAO,KACrB,OAAS,IAAU,CACjB,GAAI,IAAI,UAAY,eAAgB,CAClC,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,oDAAqD,CAAC,CAC7F,CACA,MAAM,GACR,CAEA,GAAI,WAAa,CAAC,KAAM,CACtB,QAAQ,KAAK,8CAA+C,CAC1D,MAAO,eACP,MAAO,WAAW,QAClB,UAAW,WAAW,OACtB,QAAS,CAAC,CAAC,KACX,YAAa,MAAM,UAAU,EAAG,EAAE,EAAI,MACtC,KAAM,IAAI,KACV,OAAQ,IAAI,MACd,CAAC,EACD,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAC1B,MAAO,2BACP,QAAS,WAAW,SAAW,2BAC/B,KAAM,IAAI,IACZ,CAAC,CACH,CAGA,IAAI,QACJ,GAAI,CACF,MAAM,cAAgB,MAAM,QAAQ,KAAK,CACvC,SAAS,KAAK,UAAU,EAAE,OAAO,MAAM,EAAE,GAAG,KAAM,KAAK,EAAE,EAAE,OAAO,EAClE,IAAI,QAAQ,CAAC,EAAG,SAAW,WAAW,IAAM,OAAO,IAAI,MAAM,iBAAiB,CAAC,EAAG,GAAI,CAAC,CACzF,CAAC,EACD,QAAU,cAAc,IAC1B,OAAS,IAAU,CAEjB,QAAQ,KAAK,4CAA6C,IAAI,OAAO,EACrE,QAAU,IACZ,CAEA,IAAI,KAAO,CACT,GAAI,KAAK,GACT,MAAO,KAAK,MACZ,KAAM,SAAS,MAAQ,SACzB,EAEA,KAAK,CACP,OAAS,MAAY,CACnB,QAAQ,MAAM,yBAA0B,KAAK,EAC7C,GAAI,MAAM,SAAS,SAAS,SAAS,EAAG,CACtC,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,oDAAqD,CAAC,CAC7F,CACA,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,wBAAyB,QAAS,MAAM,OAAQ,CAAC,CACjF,CACF,EAxF8B","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/middleware/auth.ts"],"sourcesContent":[null]}}