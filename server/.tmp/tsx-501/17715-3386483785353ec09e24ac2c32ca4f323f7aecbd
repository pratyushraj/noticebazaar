{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase}from\"../lib/supabase.js\";async function getPlatformMetrics(){const metrics={timeToCreatorSignature:{averageHours:0,medianHours:0,totalSigned:0},shipmentToReceipt:{averageDays:0,totalConfirmed:0},remindersEfficiency:{totalRemindersSent:0,deliverablesSubmittedAfterReminder:0,lateSubmissionRateAfterReminder:0}};try{const{data:signatureEvents,error:sigError}=await supabase.from(\"deal_action_logs\").select(\"deal_id, event, created_at\").in(\"event\",[\"BRAND_SIGNED\",\"CREATOR_SIGNED\"]).order(\"created_at\",{ascending:true});if(!sigError&&signatureEvents){const dealPairs={};signatureEvents.forEach(evt=>{if(!dealPairs[evt.deal_id])dealPairs[evt.deal_id]={};if(evt.event===\"BRAND_SIGNED\")dealPairs[evt.deal_id].brandSigned=new Date(evt.created_at);if(evt.event===\"CREATOR_SIGNED\")dealPairs[evt.deal_id].creatorSigned=new Date(evt.created_at)});const deltas=[];Object.values(dealPairs).forEach(pair=>{if(pair.brandSigned&&pair.creatorSigned){const deltaInHours=(pair.creatorSigned.getTime()-pair.brandSigned.getTime())/(1e3*60*60);if(deltaInHours>0)deltas.push(deltaInHours)}});if(deltas.length>0){metrics.timeToCreatorSignature.averageHours=deltas.reduce((a,b)=>a+b,0)/deltas.length;metrics.timeToCreatorSignature.totalSigned=deltas.length;const sorted=[...deltas].sort((a,b)=>a-b);metrics.timeToCreatorSignature.medianHours=sorted[Math.floor(sorted.length/2)]}}const{data:shippingEvents,error:shipError}=await supabase.from(\"deal_action_logs\").select(\"deal_id, event, created_at\").in(\"event\",[\"shipping_marked_shipped\",\"shipping_confirmed_delivered\"]).order(\"created_at\",{ascending:true});if(!shipError&&shippingEvents){const dealPairs={};shippingEvents.forEach(evt=>{if(!dealPairs[evt.deal_id])dealPairs[evt.deal_id]={};if(evt.event===\"shipping_marked_shipped\")dealPairs[evt.deal_id].shipped=new Date(evt.created_at);if(evt.event===\"shipping_confirmed_delivered\")dealPairs[evt.deal_id].delivered=new Date(evt.created_at)});const deltas=[];Object.values(dealPairs).forEach(pair=>{if(pair.shipped&&pair.delivered){const deltaInDays=(pair.delivered.getTime()-pair.shipped.getTime())/(1e3*60*60*24);if(deltaInDays>0)deltas.push(deltaInDays)}});if(deltas.length>0){metrics.shipmentToReceipt.averageDays=deltas.reduce((a,b)=>a+b,0)/deltas.length;metrics.shipmentToReceipt.totalConfirmed=deltas.length}}const{data:reminderEvents,error:remError}=await supabase.from(\"deal_action_logs\").select(\"deal_id, event, created_at\").eq(\"event\",\"CREATOR_DELIVERABLE_DUE_REMINDER_SENT\");if(!remError&&reminderEvents){metrics.remindersEfficiency.totalRemindersSent=reminderEvents.length;const{data:submissions,error:subError}=await supabase.from(\"brand_deals\").select(\"id, updated_at, status, due_date\").in(\"id\",reminderEvents.map(r=>r.deal_id));if(!subError&&submissions){let afterReminder=0;let lateAfterReminder=0;submissions.forEach(deal=>{const reminder=reminderEvents.find(r=>r.deal_id===deal.id);if(reminder){const reminderDate=new Date(reminder.created_at);const statusUpper=(deal.status||\"\").toUpperCase();if(statusUpper.includes(\"DELIVERED\")||statusUpper.includes(\"COMPLETED\")){const updatedDate=new Date(deal.updated_at);if(updatedDate>reminderDate){afterReminder++;if(deal.due_date&&updatedDate>new Date(deal.due_date)){lateAfterReminder++}}}}});metrics.remindersEfficiency.deliverablesSubmittedAfterReminder=afterReminder;metrics.remindersEfficiency.lateSubmissionRateAfterReminder=afterReminder>0?lateAfterReminder/afterReminder*100:0}}}catch(err){console.error(\"[InternalMetrics] Calculation error:\",err)}return metrics}__name(getPlatformMetrics,\"getPlatformMetrics\");export{getPlatformMetrics};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/internalMetricsService.ts"],"sourcesContent":[null]}}