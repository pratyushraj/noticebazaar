{"code":"import express from\"express\";import{supabase}from\"../lib/supabase.js\";import{generateSignedDownloadUrl}from\"../services/storage.js\";const router=express.Router();router.post(\"/signed-url\",async(req,res)=>{try{const{dealId}=req.body;const authHeader=req.headers.authorization;if(!authHeader||!authHeader.startsWith(\"Bearer \")){return res.status(401).json({error:\"Unauthorized: No token provided\"})}const token=authHeader.substring(7);const{data:{user},error:authError}=await supabase.auth.getUser(token);if(authError||!user){return res.status(401).json({error:\"Unauthorized: Invalid token\"})}if(!dealId){return res.status(400).json({error:\"Missing dealId\"})}const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"id, creator_id, contract_file_path, contract_file_url, signed_contract_path, signed_contract_url\").eq(\"id\",dealId).single();if(dealError||!deal){return res.status(404).json({error:\"Deal not found\"})}if(deal.creator_id!==user.id){return res.status(403).json({error:\"Forbidden: You do not have access to this contract\"})}const filePath=deal.signed_contract_path||deal.contract_file_path;const fallbackUrl=deal.signed_contract_url||deal.contract_file_url;if(!filePath&&!fallbackUrl){return res.status(404).json({error:\"No contract file available for this deal\"})}if(filePath){try{const signedUrl=await generateSignedDownloadUrl(filePath,3600);return res.json({success:true,signedUrl,expiresIn:3600,type:deal.signed_contract_path?\"signed\":\"unsigned\"})}catch(error){console.error(\"[Contracts API] Failed to generate signed URL:\",error)}}if(fallbackUrl){return res.json({success:true,signedUrl:fallbackUrl,expiresIn:null,type:deal.signed_contract_url?\"signed\":\"unsigned\",legacy:true})}return res.status(404).json({error:\"No contract file available\"})}catch(error){console.error(\"[Contracts API] Error generating signed URL:\",error);return res.status(500).json({error:\"Internal server error\"})}});router.post(\"/signed-url-token\",async(req,res)=>{try{const{token,type=\"contract\"}=req.body;if(!token){return res.status(400).json({error:\"Missing token\"})}const{data:tokenData,error:tokenError}=await supabase.from(\"contract_ready_tokens\").select(\"deal_id, expires_at\").eq(\"token\",token).single();if(tokenError||!tokenData){return res.status(404).json({error:\"Invalid or expired token\"})}if(tokenData.expires_at&&new Date(tokenData.expires_at)<new Date){return res.status(403).json({error:\"Token has expired\"})}const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"id, contract_file_path, contract_file_url, signed_contract_path, signed_contract_url\").eq(\"id\",tokenData.deal_id).single();if(dealError||!deal){return res.status(404).json({error:\"Deal not found\"})}const filePath=type===\"signed\"?deal.signed_contract_path||deal.contract_file_path:deal.contract_file_path;const fallbackUrl=type===\"signed\"?deal.signed_contract_url||deal.contract_file_url:deal.contract_file_url;if(!filePath&&!fallbackUrl){return res.status(404).json({error:\"No contract file available\"})}if(filePath){try{const signedUrl=await generateSignedDownloadUrl(filePath,3600);return res.json({success:true,signedUrl,expiresIn:3600,type})}catch(error){console.error(\"[Contracts API] Failed to generate signed URL:\",error)}}if(fallbackUrl){return res.json({success:true,signedUrl:fallbackUrl,expiresIn:null,type,legacy:true})}return res.status(404).json({error:\"No contract file available\"})}catch(error){console.error(\"[Contracts API] Error generating signed URL with token:\",error);return res.status(500).json({error:\"Internal server error\"})}});var contracts_default=router;export{contracts_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/contracts.ts"],"sourcesContent":[null]}}