{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase}from\"../lib/supabase.js\";function validateGSTIN(gstin){if(!gstin||typeof gstin!==\"string\"){return false}const cleaned=gstin.trim().toUpperCase();return/^[0-9A-Z]{15}$/.test(cleaned)}__name(validateGSTIN,\"validateGSTIN\");function normalizeGSTIN(gstin){return gstin.trim().toUpperCase()}__name(normalizeGSTIN,\"normalizeGSTIN\");async function getCachedGSTData(gstin){try{const normalizedGstin=normalizeGSTIN(gstin);const{data,error}=await supabase.from(\"gst_company_cache\").select(\"*\").eq(\"gstin\",normalizedGstin).single();if(error||!data){return null}const cacheRecord=data;const fetchedAt=new Date(cacheRecord.fetched_at);const now=new Date;const daysSinceFetch=(now.getTime()-fetchedAt.getTime())/(1e3*60*60*24);if(daysSinceFetch<30){return{legalName:cacheRecord.legal_name,tradeName:cacheRecord.trade_name||void 0,address:cacheRecord.address,state:cacheRecord.state,gstStatus:cacheRecord.status}}return null}catch(error){console.error(\"[GSTService] Cache lookup error:\",error);return null}}__name(getCachedGSTData,\"getCachedGSTData\");async function saveGSTDataToCache(gstin,data){try{const normalizedGstin=normalizeGSTIN(gstin);const cacheData={gstin:normalizedGstin,legal_name:data.legalName,trade_name:data.tradeName||null,address:data.address,state:data.state,status:data.gstStatus,fetched_at:new Date().toISOString(),updated_at:new Date().toISOString()};const{error}=await supabase.from(\"gst_company_cache\").upsert(cacheData,{onConflict:\"gstin\"});if(error){console.error(\"[GSTService] Cache save error:\",error)}}catch(error){console.error(\"[GSTService] Cache save error:\",error)}}__name(saveGSTDataToCache,\"saveGSTDataToCache\");async function fetchGSTDataFromAPI(gstin){const apiKey=process.env.GSTINCHECK_API_KEY;if(!apiKey){throw new Error(\"GST API key not configured\")}const normalizedGstin=normalizeGSTIN(gstin);const apiUrl=`https://sheet.gstincheck.co.in/check/${apiKey}/${normalizedGstin}`;console.log(\"[GSTService] Calling API:\",apiUrl.replace(apiKey,\"***\"));try{const response=await fetch(apiUrl,{method:\"GET\",headers:{\"Content-Type\":\"application/json\"}});console.log(\"[GSTService] API Response Status:\",response.status);if(!response.ok){let errorMessage=`GST API error: ${response.status} ${response.statusText}`;try{const errorData=await response.text();console.error(\"[GSTService] API Error Response:\",errorData);if(errorData&&!errorData.includes(\"<!DOCTYPE\")){const parsed=JSON.parse(errorData);errorMessage=parsed.message||parsed.error||errorMessage}}catch(e){}if(response.status===404){throw new Error(\"GSTIN not found\")}if(response.status===401||response.status===403){throw new Error(\"GST API authentication failed. Please check your API key.\")}throw new Error(errorMessage)}const apiData=await response.json();console.log(\"[GSTService] Successful API call\");console.log(\"[GSTService] API response structure:\",JSON.stringify(apiData).substring(0,500));if(!apiData.flag||!apiData.data){throw new Error(apiData.message||\"GSTIN not found\")}const responseData=apiData.data;const addr=responseData.pradr?.addr||{};const fullAddress=responseData.pradr?.adr||[addr.bno,addr.bnm,addr.st,addr.loc,addr.city,addr.dst,addr.stcd,addr.pncd?`- ${addr.pncd}`:\"\"].filter(Boolean).join(\", \")||\"\";const state=addr.stcd||(responseData.stj?responseData.stj.split(\",\")[0]?.replace(\"State -\",\"\").trim():\"\")||\"\";const normalizedData={legalName:responseData.lgnm||\"\",tradeName:responseData.tradeNam||void 0,address:fullAddress,state,gstStatus:responseData.sts===\"Active\"||responseData.sts===\"ACTIVE\"?\"Active\":responseData.sts===\"Cancelled\"||responseData.sts===\"CANCELLED\"?\"Cancelled\":responseData.sts===\"Suspended\"||responseData.sts===\"SUSPENDED\"?\"Suspended\":\"Active\"};if(!normalizedData.legalName||!normalizedData.address||!normalizedData.state){console.error(\"[GSTService] Invalid API response - missing required fields:\",{legalName:normalizedData.legalName,address:normalizedData.address,state:normalizedData.state,rawResponse:apiData});throw new Error(\"Invalid API response: missing required fields\")}return normalizedData}catch(error){if(error instanceof Error){throw error}throw new Error(\"Failed to fetch GST data from API\")}}__name(fetchGSTDataFromAPI,\"fetchGSTDataFromAPI\");async function lookupGSTCompany(gstin){if(!validateGSTIN(gstin)){throw new Error(\"Invalid GSTIN format. Must be 15 characters (uppercase alphanumeric).\")}const normalizedGstin=normalizeGSTIN(gstin);const cachedData=await getCachedGSTData(normalizedGstin);if(cachedData){console.log(`[GSTService] Cache hit for GSTIN: ${normalizedGstin}`);return cachedData}console.log(`[GSTService] Cache miss for GSTIN: ${normalizedGstin}, fetching from API`);const apiData=await fetchGSTDataFromAPI(normalizedGstin);saveGSTDataToCache(normalizedGstin,apiData).catch(err=>{console.error(\"[GSTService] Failed to cache GST data:\",err)});return apiData}__name(lookupGSTCompany,\"lookupGSTCompany\");export{lookupGSTCompany};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/gstService.ts"],"sourcesContent":[null]}}