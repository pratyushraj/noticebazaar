{"code":"import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";const router=Router();router.get(\"/:conversationId/messages\",async(req,res)=>{try{const userId=req.user.id;const{conversationId}=req.params;const limit=parseInt(req.query.limit)||40;const before=req.query.before;const{data:participant}=await supabase.from(\"conversation_participants\").select(\"user_id\").eq(\"conversation_id\",conversationId).eq(\"user_id\",userId).single();if(!participant&&req.user.role!==\"admin\"){return res.status(403).json({error:\"Access denied\"})}let query=supabase.from(\"messages\").select(`\n        *,\n        sender:profiles!sender_id(first_name, last_name, avatar_url),\n        attachments:message_attachments(*)\n      `).eq(\"conversation_id\",conversationId).eq(\"is_deleted\",false).order(\"sent_at\",{ascending:false}).limit(limit);if(before){query=query.lt(\"id\",before)}const{data:messages,error}=await query;if(error)throw error;res.json({data:messages.reverse()})}catch(error){res.status(500).json({error:error.message})}});router.post(\"/:conversationId/messages\",async(req,res)=>{try{const userId=req.user.id;const{conversationId}=req.params;const{content,message_type=\"text\",attachment_ids}=req.body;if(!content||content.trim().length===0){return res.status(400).json({error:\"Message content required\"})}const{data:participant}=await supabase.from(\"conversation_participants\").select(\"user_id\").eq(\"conversation_id\",conversationId).eq(\"user_id\",userId).single();if(!participant){return res.status(403).json({error:\"Not a participant in this conversation\"})}const{data:message,error:msgError}=await supabase.from(\"messages\").insert({conversation_id:conversationId,sender_id:userId,content:content.trim(),message_type}).select().single();if(msgError)throw msgError;if(attachment_ids&&Array.isArray(attachment_ids)&&attachment_ids.length>0){await supabase.from(\"message_attachments\").update({message_id:message.id}).in(\"id\",attachment_ids)}res.status(201).json({data:message})}catch(error){res.status(500).json({error:error.message})}});router.patch(\"/messages/:id/read\",async(req,res)=>{try{const userId=req.user.id;const{id}=req.params;const{data:message}=await supabase.from(\"messages\").select(\"conversation_id\").eq(\"id\",id).single();if(!message){return res.status(404).json({error:\"Message not found\"})}const{data:participant}=await supabase.from(\"conversation_participants\").select(\"user_id\").eq(\"conversation_id\",message.conversation_id).eq(\"user_id\",userId).single();if(!participant){return res.status(403).json({error:\"Access denied\"})}const{error}=await supabase.from(\"messages\").update({is_read:true}).eq(\"id\",id).eq(\"conversation_id\",message.conversation_id);if(error)throw error;await supabase.from(\"conversation_participants\").update({last_read_at:new Date().toISOString()}).eq(\"conversation_id\",message.conversation_id).eq(\"user_id\",userId);res.json({success:true})}catch(error){res.status(500).json({error:error.message})}});var messages_default=router;export{messages_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/messages.ts"],"sourcesContent":[null]}}