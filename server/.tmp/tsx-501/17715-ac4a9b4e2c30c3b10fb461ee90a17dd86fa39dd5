{"code":"import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";import{generateAICounterProposal}from\"../services/counterProposalGenerator.js\";import{callLLM}from\"../services/aiContractAnalysis.js\";const router=Router();router.post(\"/counter-proposal\",async(req,res)=>{try{const userId=req.user.id;const{deal_id,deal_value,issues,missing_clauses,creator_category,brand_response_message,previous_negotiation_message,tone_preference}=req.body;if(!deal_id){return res.status(400).json({success:false,error:\"deal_id is required\"})}if(!issues||!Array.isArray(issues)||issues.length===0){return res.status(400).json({success:false,error:\"At least one issue is required\"})}const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"id, brand_name, creator_id, deal_amount, brand_response_message\").eq(\"id\",deal_id).single();if(dealError||!deal){return res.status(404).json({success:false,error:\"Deal not found\"})}if(deal.creator_id!==userId&&req.user.role!==\"admin\"){return res.status(403).json({success:false,error:\"Access denied\"})}const counterProposalRequest={deal_value:deal_value||deal.deal_amount,issues,missing_clauses:missing_clauses||[],creator_category,brand_response_message:brand_response_message||deal.brand_response_message,previous_negotiation_message,brand_name:deal.brand_name,tone_preference:tone_preference||\"firm\"};const result=await generateAICounterProposal(counterProposalRequest);return res.json({success:true,data:result})}catch(error){console.error(\"[AI Counter-Proposal] Error:\",error);return res.status(500).json({success:false,error:error.message||\"Failed to generate counter-proposal\"})}});router.post(\"/pitch\",async(req,res)=>{try{const{input,type,tone}=req.body;const userId=req.user.id;if(!input||typeof input!==\"string\"||input.trim().length<10){return res.status(400).json({success:false,error:\"input is required and must be at least 10 characters\"})}const mode=type===\"notice\"?\"notice\":\"pitch\";const toneValue=typeof tone===\"number\"?Math.max(0,Math.min(100,tone)):50;const toneLabel=toneValue<33?\"firm\":toneValue>66?\"friendly\":\"neutral\";const systemPrompt=`\nYou are an expert creator economy copywriter. Write a clear, persuasive ${mode===\"pitch\"?\"brand collaboration pitch\":\"response to a legal notice\"}.\n\nRules:\n- Output only the final text, no markdown, no explanations.\n- Keep it under 220 words.\n- Use a confident, professional tone.\n- Be specific and concrete, avoid fluff.\n- Include a short subject line for pitches only.\n${mode===\"notice\"?`- Tone should be ${toneLabel}.`:\"\"}`.trim();const userPrompt=`\nContext:\n${input.trim()}\n`.trim();const output=await callLLM(`${systemPrompt}\n\n${userPrompt}\n\nReturn ONLY the final text.`);if(!output||typeof output!==\"string\"){return res.status(500).json({success:false,error:\"Failed to generate response\"})}let savedId=null;let savedAt=null;try{const{data:saved,error:saveError}=await supabase.from(\"ai_pitch_history\").insert({user_id:userId,type:mode,tone:mode===\"notice\"?toneLabel:null,input:input.trim(),output:output.trim()}).select(\"id, created_at\").maybeSingle();if(!saveError&&saved){savedId=saved.id;savedAt=saved.created_at}else if(saveError){console.warn(\"[AI Pitch] Failed to save history:\",saveError.message)}}catch(saveErr){console.warn(\"[AI Pitch] Save exception:\",saveErr.message)}return res.json({success:true,data:{output:output.trim(),id:savedId,created_at:savedAt}})}catch(error){console.error(\"[AI Pitch] Error:\",error);return res.status(500).json({success:false,error:error.message||\"Failed to generate pitch\"})}});router.get(\"/pitch/history\",async(req,res)=>{try{const userId=req.user.id;const{data,error}=await supabase.from(\"ai_pitch_history\").select(\"id, input, output, type, tone, created_at\").eq(\"user_id\",userId).order(\"created_at\",{ascending:false}).limit(50);if(error){return res.status(500).json({success:false,error:error.message||\"Failed to load history\"})}return res.json({success:true,data:data||[]})}catch(error){console.error(\"[AI Pitch] History error:\",error);return res.status(500).json({success:false,error:error.message||\"Failed to load history\"})}});router.post(\"/pitch/history\",async(req,res)=>{try{const userId=req.user.id;const{items}=req.body;if(!items||!Array.isArray(items)||items.length===0){return res.status(400).json({success:false,error:\"items array is required\"})}const rows=items.map(item=>({user_id:userId,type:item.type===\"notice\"?\"notice\":\"pitch\",tone:item.type===\"notice\"?item.tone||null:null,input:item.input,output:item.output,created_at:item.created_at||void 0}));const{data,error}=await supabase.from(\"ai_pitch_history\").insert(rows).select(\"id, created_at\");if(error){return res.status(500).json({success:false,error:error.message||\"Failed to sync history\"})}return res.json({success:true,data:data||[]})}catch(error){console.error(\"[AI Pitch] History sync error:\",error);return res.status(500).json({success:false,error:error.message||\"Failed to sync history\"})}});var ai_default=router;export{ai_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/ai.ts"],"sourcesContent":[null]}}