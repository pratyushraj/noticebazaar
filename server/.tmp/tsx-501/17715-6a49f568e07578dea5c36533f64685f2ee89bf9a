{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";import{analyzeContract}from\"../services/contractAnalysis.js\";import{generateReportPdf}from\"../services/pdfGenerator.js\";import{generateSafeClause}from\"../services/clauseGenerator.js\";import{generateSafeContract}from\"../services/safeContractGenerator.js\";import{generateContractFromScratch}from\"../services/contractGenerator.js\";import{callLLM}from\"../services/aiContractAnalysis.js\";import crypto from\"crypto\";import{generateSignedDownloadUrl}from\"../services/storage.js\";import{getDealSubmissionDetails}from\"../services/dealDetailsTokenService.js\";import{buildDealSchemaFromDealData,mapDealSchemaToContractVariables,validateRequiredContractFields}from\"../services/contractTemplate.js\";import{generateContractDocx,prepareHtmlForDocx}from\"../services/docxGenerator.js\";const router=Router();const MAX_CONTRACT_BYTES=15*1024*1024;const ALLOWED_CONTRACT_MIME=new Set([\"application/pdf\",\"application/msword\",\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\"]);const isPrivateIp=__name(host=>{if(!/^\\d{1,3}(\\.\\d{1,3}){3}$/.test(host))return false;const parts=host.split(\".\").map(Number);if(parts.some(p=>p<0||p>255))return false;if(parts[0]===10)return true;if(parts[0]===127)return true;if(parts[0]===169&&parts[1]===254)return true;if(parts[0]===192&&parts[1]===168)return true;if(parts[0]===172&&parts[1]>=16&&parts[1]<=31)return true;return false},\"isPrivateIp\");const getAllowedStorageOrigins=__name(()=>{const base=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL||\"\";if(!base)return[];return[base.replace(/\\/$/,\"\")]},\"getAllowedStorageOrigins\");const isAllowedContractUrl=__name(urlString=>{try{const url=new URL(urlString);if(url.protocol!==\"https:\")return false;if(isPrivateIp(url.hostname))return false;const allowedOrigins=getAllowedStorageOrigins();if(!allowedOrigins.some(origin=>url.origin===origin))return false;if(!url.pathname.includes(\"/storage/v1/object\"))return false;return true}catch{return false}},\"isAllowedContractUrl\");const fetchWithTimeout=__name(async(url,timeoutMs=15e3)=>{const controller=new AbortController;const timeoutId=setTimeout(()=>controller.abort(),timeoutMs);try{const response=await fetch(url,{signal:controller.signal});return response}finally{clearTimeout(timeoutId)}},\"fetchWithTimeout\");router.post(\"/analyze\",async(req,res)=>{try{const userId=req.user.id;const{contract_url,deal_id}=req.body;if(!contract_url){return res.status(400).json({error:\"contract_url required\"})}if(!isAllowedContractUrl(contract_url)){return res.status(400).json({ok:false,error:\"Invalid contract URL. Please upload via Creator Armour and try again.\"})}const contractResponse=await fetchWithTimeout(contract_url,2e4);if(!contractResponse.ok){throw new Error(\"Failed to download contract file\")}const contentLength=contractResponse.headers.get(\"content-length\");if(contentLength&&Number(contentLength)>MAX_CONTRACT_BYTES){return res.status(413).json({ok:false,error:\"Contract file is too large. Max size is 15MB.\"})}const contentType=contractResponse.headers.get(\"content-type\")||\"\";if(contentType&&!ALLOWED_CONTRACT_MIME.has(contentType.split(\";\")[0].trim())){return res.status(400).json({ok:false,error:\"Unsupported contract file type. Use PDF or DOCX.\"})}const contractBuffer=Buffer.from(await contractResponse.arrayBuffer());if(contractBuffer.length>MAX_CONTRACT_BYTES){return res.status(413).json({ok:false,error:\"Contract file is too large. Max size is 15MB.\"})}let analysis;const provider=process.env.LLM_PROVIDER||\"huggingface\";const model=process.env.LLM_MODEL||\"mistralai/Mistral-7B-Instruct-v0.2\";try{analysis=await analyzeContract(contractBuffer,contract_url);try{const aiAnalysis=analysis;const promptHash=crypto.createHash(\"sha256\").update(JSON.stringify({provider,model,timestamp:Date.now()})).digest(\"hex\");await supabase.from(\"contract_ai_logs\").insert({report_id:null,user_id:userId,model_used:`${provider}/${model}`,prompt_hash:promptHash,risk_score:aiAnalysis.riskScore||null,detected_type:aiAnalysis.documentType||null,detected_category:aiAnalysis.detectedContractCategory||null,brand_detected:aiAnalysis.brandDetected??null,analysis_metadata:{parties:aiAnalysis.parties||null,extractedTerms:aiAnalysis.extractedTerms||null,negotiationPoints:aiAnalysis.negotiationPoints||null}})}catch(logError){console.warn(\"[Protection] Failed to log AI decision:\",logError.message)}}catch(err){console.error(\"[Protection] Contract analysis error:\",err);if(err.validationError===true){return res.status(400).json({ok:false,validationError:true,error:err.message,details:err.details||null})}if(err.message?.includes(\"Invalid\")||err.message?.includes(\"structure\")||err.message?.includes(\"extract text\")){return res.status(400).json({ok:false,error:\"Invalid document file. Please ensure the file is a valid PDF, DOCX, or DOC document.\",details:err.message})}return res.status(500).json({ok:false,error:err.message||\"Failed to analyze contract\",details:process.env.NODE_ENV===\"development\"?err.stack:void 0})}let pdfUrl=null;try{const pdfBuffer=await generateReportPdf(analysis);const pdfPath=`protection-reports/${userId}/${Date.now()}_analysis_report.pdf`;const{data:uploadData,error:uploadError}=await supabase.storage.from(\"creator-assets\").upload(pdfPath,pdfBuffer,{contentType:\"application/pdf\",upsert:false});if(!uploadError){const{data:urlData}=supabase.storage.from(\"creator-assets\").getPublicUrl(pdfPath);pdfUrl=urlData.publicUrl;console.log(\"[Protection] PDF report generated and uploaded successfully\")}else{console.warn(\"[Protection] PDF upload failed:\",uploadError.message)}}catch(pdfError){console.warn(\"[Protection] PDF generation failed, continuing without PDF:\",pdfError.message)}const rawProtectionScore=Number(analysis.protectionScore??0);const protectionScore=Number.isFinite(rawProtectionScore)?Math.min(100,Math.max(0,rawProtectionScore)):0;const rawOverallRisk=String(analysis.overallRisk||\"\").toLowerCase();let normalizedOverallRisk=\"medium\";if(rawOverallRisk.includes(\"low\")){normalizedOverallRisk=\"low\"}else if(rawOverallRisk.includes(\"high\")){normalizedOverallRisk=\"high\"}let reportId=null;try{const aiAnalysis=analysis;const{data:report,error:reportError}=await supabase.from(\"protection_reports\").insert({deal_id:deal_id||null,user_id:userId,contract_file_url:contract_url,pdf_report_url:pdfUrl,protection_score:protectionScore,negotiation_power_score:analysis.negotiationPowerScore||null,overall_risk:normalizedOverallRisk,analysis_json:analysis,document_type:aiAnalysis.documentType||null,detected_contract_category:aiAnalysis.detectedContractCategory||null,brand_detected:aiAnalysis.brandDetected??null}).select().single();if(reportError){console.error(\"[Protection] Failed to save report to database:\",reportError);console.error(\"[Protection] Error code:\",reportError.code);console.error(\"[Protection] Error message:\",reportError.message);const isUserIdError=reportError.message?.includes(\"user_id\")||reportError.message?.includes(\"Could not find the 'user_id' column\")||reportError.message?.includes('column \"user_id\"')||reportError.code===\"42703\"||reportError.code===\"PGRST116\";if(isUserIdError){console.log(\"[Protection] \\u{1F504} Retrying without user_id column (column may not exist yet)...\");try{const{data:reportRetry,error:retryError}=await supabase.from(\"protection_reports\").insert({deal_id:deal_id||null,contract_file_url:contract_url,pdf_report_url:pdfUrl,protection_score:protectionScore,negotiation_power_score:analysis.negotiationPowerScore||null,overall_risk:normalizedOverallRisk,analysis_json:analysis,document_type:aiAnalysis.documentType||null,detected_contract_category:aiAnalysis.detectedContractCategory||null,brand_detected:aiAnalysis.brandDetected??null}).select().single();if(!retryError&&reportRetry){reportId=reportRetry.id;console.log(\"[Protection] \\u2705 Report saved to database (without user_id):\",reportId)}else{console.error(\"[Protection] \\u274C Retry also failed:\",retryError);console.error(\"[Protection] Retry error details:\",JSON.stringify(retryError,null,2))}}catch(retryErr){console.error(\"[Protection] \\u274C Retry exception:\",retryErr)}}else{console.warn(\"[Protection] \\u26A0\\uFE0F Error is not related to user_id column. Not retrying.\")}}else{reportId=report?.id||null;console.log(\"[Protection] \\u2705 Report saved to database:\",reportId)}}catch(dbError){console.warn(\"[Protection] Database save failed, continuing without saving:\",dbError.message)}let savedIssueIds=[];if(reportId&&analysis.issues&&analysis.issues.length>0){try{const{data:insertedIssues,error:insertError}=await supabase.from(\"protection_issues\").insert(analysis.issues.map(issue=>({report_id:reportId,severity:issue.severity,category:issue.category,title:issue.title,description:issue.description,clause_reference:issue.clause,recommendation:issue.recommendation}))).select(\"id\");if(!insertError&&insertedIssues){savedIssueIds=insertedIssues.map(issue=>issue.id)}}catch(error){console.warn(\"[Protection] Failed to save issues:\",error)}}if(reportId&&analysis.verified&&analysis.verified.length>0){try{await supabase.from(\"protection_verified\").insert(analysis.verified.map(item=>({report_id:reportId,category:item.category,title:item.title,description:item.description,clause_reference:item.clause})))}catch(error){console.warn(\"[Protection] Failed to save verified items:\",error)}}if(savedIssueIds.length>0&&analysis.issues){analysis.issues=analysis.issues.map((issue,index)=>({...issue,db_id:savedIssueIds[index]||null}))}const responseData={ok:true,data:{analysis_json:analysis,report_id:reportId||null,pdf_report_url:pdfUrl||null}};if(!reportId){console.warn(\"[Protection] \\u26A0\\uFE0F Report was not saved to database. report_id will be null in response.\");console.warn(\"[Protection] \\u26A0\\uFE0F Action buttons (Download Safe Version, etc.) will not work without report_id.\");console.warn(\"[Protection] \\u{1F4A1} Run the migration to add user_id column: server/database/migrations/protection_tables.sql\")}res.json(responseData)}catch(err){console.error(\"[Protection] Unhandled error in /analyze endpoint:\",err);console.error(\"[Protection] Error name:\",err?.name);console.error(\"[Protection] Error message:\",err?.message);console.error(\"[Protection] Error stack:\",err?.stack);console.error(\"[Protection] Request body:\",JSON.stringify(req.body,null,2));console.error(\"[Protection] User ID:\",req.user?.id);if(err.validationError===true){return res.status(400).json({ok:false,validationError:true,error:err.message,details:err.details||null})}return res.status(500).json({ok:false,error:err.message||\"Internal Server Error\",details:process.env.NODE_ENV===\"development\"?{stack:err.stack,name:err.name}:void 0})}});router.get(\"/:id/report.pdf\",async(req,res)=>{try{const userId=req.user.id;const{id}=req.params;const{data:report,error}=await supabase.from(\"protection_reports\").select(\"*, deal:brand_deals!deal_id(creator_id)\").eq(\"id\",id).single();if(error||!report){return res.status(404).json({error:\"Report not found\"})}const reportData=report;if(reportData.deal?.creator_id!==userId&&req.user.role!==\"admin\"){return res.status(403).json({error:\"Access denied\"})}if(!reportData.pdf_report_url){return res.status(404).json({error:\"PDF report not available\"})}const path=reportData.pdf_report_url.split(\"/\").slice(-2).join(\"/\");const signedUrl=await generateSignedDownloadUrl(path,3600);res.redirect(signedUrl)}catch(error){res.status(500).json({error:error.message})}});router.post(\"/generate-safe-contract\",async(req,res)=>{try{const userId=req.user.id;const{reportId,originalFilePath,dealId}=req.body;if(!originalFilePath||originalFilePath.trim()===\"\"){return res.status(400).json({success:false,error:\"originalFilePath is required and cannot be empty\"})}if(!reportId){console.log(\"[Protection] Generating safe contract without reportId, using originalFilePath only\")}if(reportId){const{data:report,error:reportError}=await supabase.from(\"protection_reports\").select(\"*, deal:brand_deals!deal_id(creator_id)\").eq(\"id\",reportId).single();if(reportError||!report){console.warn(\"[Protection] Report not found, but continuing with originalFilePath only:\",reportId)}else{const hasAccess=report.user_id===userId||report.deal?.creator_id===userId||!report.deal_id||req.user.role===\"admin\";if(!hasAccess){return res.status(403).json({success:false,error:\"Access denied\"})}}}else{console.warn(\"[Protection] No reportId provided, generating safe contract from original file only\")}const result=await generateSafeContract({reportId:reportId||\"temp\",originalFilePath,userId});if(!result.contractHtml){return res.status(500).json({success:false,error:\"Failed to generate contract HTML\"})}if(dealId){const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"creator_id\").eq(\"id\",dealId).single();if(dealError||!deal){return res.status(404).json({success:false,error:\"Deal not found\"})}if(deal.creator_id!==userId&&req.user.role!==\"admin\"){return res.status(403).json({success:false,error:\"Access denied\"})}let safeContractUrl=null;if(result.fileBuffer&&result.fileName){const timestamp=Date.now();const storagePath=`safe-contracts/${dealId}/${timestamp}_${result.fileName}`;const{error:uploadError}=await supabase.storage.from(\"creator-assets\").upload(storagePath,result.fileBuffer,{contentType:result.contentType||\"application/pdf\",upsert:false});if(!uploadError){const{data:publicUrlData}=supabase.storage.from(\"creator-assets\").getPublicUrl(storagePath);safeContractUrl=publicUrlData?.publicUrl||null;console.log(\"[Protection] PDF uploaded successfully (optional):\",safeContractUrl)}else{console.warn(\"[Protection] PDF upload failed (non-blocking):\",uploadError.message)}}const baseUpdateData={contract_html:result.contractHtml,updated_at:new Date().toISOString()};if(safeContractUrl){baseUpdateData.safe_contract_url=safeContractUrl;baseUpdateData.contract_file_url=safeContractUrl}const updateDataWithVersion={...baseUpdateData,contract_version:\"safe_final\"};console.log(\"[Protection] Updating deal with contract HTML, length:\",result.contractHtml.length);const{error:updateError}=await supabase.from(\"brand_deals\").update(updateDataWithVersion).eq(\"id\",dealId);if(updateError){const errorMsg=updateError.message||\"\";console.warn(\"[Protection] Update failed, error:\",errorMsg);if(errorMsg.includes(\"contract_version\")||errorMsg.includes(\"contract_html\")||errorMsg.includes(\"column\")||errorMsg.includes(\"does not exist\")){console.warn(\"[Protection] Column may not exist, retrying with minimal fields...\");const minimalUpdateData={updated_at:new Date().toISOString()};try{const{error:htmlError}=await supabase.from(\"brand_deals\").update({contract_html:result.contractHtml,updated_at:minimalUpdateData.updated_at}).eq(\"id\",dealId);if(!htmlError){console.log(\"[Protection] Successfully updated contract_html\");minimalUpdateData.contract_html=result.contractHtml}else{console.warn(\"[Protection] contract_html column may not exist:\",htmlError.message)}}catch(e){console.warn(\"[Protection] Could not update contract_html:\",e)}if(safeContractUrl){minimalUpdateData.safe_contract_url=safeContractUrl;minimalUpdateData.contract_file_url=safeContractUrl}const{error:minimalError}=await supabase.from(\"brand_deals\").update(minimalUpdateData).eq(\"id\",dealId);if(minimalError){console.error(\"[Protection] Failed to update deal even with minimal fields:\",minimalError)}else{console.log(\"[Protection] Successfully updated deal with minimal fields\")}}else{console.error(\"[Protection] Failed to update deal:\",updateError)}}else{console.log(\"[Protection] Successfully updated deal with contract HTML and version\")}return res.json({success:true,contractHtml:result.contractHtml})}return res.json({success:true,contractHtml:result.contractHtml})}catch(error){console.error(\"[Protection] Generate safe contract error:\",error);res.status(500).json({success:false,error:error.message||\"Failed to generate safe contract\"})}});router.post(\"/generate-contract-from-scratch\",async(req,res)=>{try{const userId=req.user.id;const{dealId}=req.body;if(!dealId){return res.status(400).json({success:false,error:\"dealId is required\"})}const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"*\").eq(\"id\",dealId).single();if(dealError||!deal){console.error(\"[Protection] Deal fetch error:\",dealError);return res.status(404).json({success:false,error:\"Deal not found\"})}if(deal.creator_id!==userId&&req.user.role!==\"admin\"){return res.status(403).json({success:false,error:\"Access denied\"})}let creatorName=\"Creator\";let creatorEmail=req.user?.email;let creatorProfile=null;let creatorAddress;console.log(\"[Protection] Starting profile fetch:\",{dealCreatorId:deal.creator_id,currentUserId:userId,isCreator:deal.creator_id===userId,userEmail:req.user?.email});if(deal.creator_id===userId){console.log(\"[Protection] Fetching current user profile for userId:\",userId);const{data:profileExists,error:existsError}=await supabase.from(\"profiles\").select(\"id\").eq(\"id\",userId).maybeSingle();console.log(\"[Protection] Profile existence check:\",{userId,exists:!!profileExists,error:existsError,errorCode:existsError?.code,errorMessage:existsError?.message});const{data:allProfileData,error:allProfileError}=await supabase.from(\"profiles\").select(\"*\").eq(\"id\",userId).maybeSingle();console.log(\"[Protection] Full profile query (select *):\",{hasData:!!allProfileData,error:allProfileError,errorCode:allProfileError?.code,columns:allProfileData?Object.keys(allProfileData):[],location:allProfileData?.location,address:allProfileData?.address,locationType:typeof allProfileData?.location,addressType:typeof allProfileData?.address});const{data:currentUserProfile,error:profileError}=await supabase.from(\"profiles\").select(\"first_name, last_name, location\").eq(\"id\",userId).maybeSingle();console.log(\"[Protection] Profile query result:\",{userId,hasData:!!currentUserProfile,error:profileError,errorCode:profileError?.code,errorMessage:profileError?.message,firstName:currentUserProfile?.first_name,lastName:currentUserProfile?.last_name,location:currentUserProfile?.location,fullProfile:currentUserProfile});if(profileError){console.error(\"[Protection] Profile fetch error details:\",{code:profileError.code,message:profileError.message,details:profileError.details,hint:profileError.hint})}const profileToUse=allProfileData||currentUserProfile;if(profileToUse){creatorProfile=profileToUse;const firstName=(profileToUse.first_name||\"\").trim();const lastName=(profileToUse.last_name||\"\").trim();const fullName=`${firstName} ${lastName}`.trim();creatorName=fullName||firstName||lastName||\"Creator\";const locationValue=profileToUse.location;const profileAddress=locationValue&&typeof locationValue===\"string\"&&locationValue.trim()!==\"\"?locationValue.trim():null;creatorAddress=profileAddress||void 0;console.log(\"[Protection] Set creator info from profile:\",{creatorName,creatorAddress,creatorAddressLength:creatorAddress?.length,creatorEmail,hasFirstName:!!firstName,hasLastName:!!lastName,hasLocation:!!profileToUse.location,locationValue:profileToUse.location,locationType:typeof profileToUse.location,locationIsNull:profileToUse.location===null,locationIsUndefined:profileToUse.location===void 0,locationLength:profileToUse.location?.length,hasAddress:!!profileToUse.address,addressValue:profileToUse.address,addressType:typeof profileToUse.address,addressIsNull:profileToUse.address===null,addressIsUndefined:profileToUse.address===void 0,addressLength:profileToUse.address?.length,profileAddress,profileAddressLength:profileAddress?.length})}else{console.warn(\"[Protection] No profile data found for current user:\",{userId,error:profileError,hasData:!!currentUserProfile})}}else{console.warn(\"[Protection] Deal creator_id does not match current user:\",{dealCreatorId:deal.creator_id,currentUserId:userId})}if(deal.creator_id&&deal.creator_id!==userId){const{data:profileData,error:otherUserError}=await supabase.from(\"profiles\").select(\"first_name, last_name, location\").eq(\"id\",deal.creator_id).maybeSingle();if(otherUserError){console.error(\"[Protection] Error fetching other user profile:\",otherUserError)}if(profileData){creatorProfile=profileData;const firstName=(profileData.first_name||\"\").trim();const lastName=(profileData.last_name||\"\").trim();const fullName=`${firstName} ${lastName}`.trim();creatorName=fullName||firstName||lastName||\"Creator\";const profileAddress=profileData.location;creatorAddress=profileAddress&&profileAddress.trim()!==\"\"?profileAddress.trim():void 0}}if(!creatorName||creatorName===\"Creator\"||!creatorAddress||!creatorProfile){console.log(\"[Protection] Missing data, trying fallback profile fetch:\",{hasName:!!creatorName&&creatorName!==\"Creator\",hasAddress:!!creatorAddress,hasProfile:!!creatorProfile,willFetch:true,userId});const{data:fallbackProfile,error:fallbackError}=await supabase.from(\"profiles\").select(\"first_name, last_name, location\").eq(\"id\",userId).maybeSingle();console.log(\"[Protection] Fallback profile fetch result:\",{hasData:!!fallbackProfile,error:fallbackError,errorCode:fallbackError?.code,errorMessage:fallbackError?.message,firstName:fallbackProfile?.first_name,lastName:fallbackProfile?.last_name,location:fallbackProfile?.location,fullProfile:fallbackProfile});if(fallbackProfile){creatorProfile=fallbackProfile;if(!creatorName||creatorName===\"Creator\"){const fallbackFirstName=(fallbackProfile.first_name||\"\").trim();const fallbackLastName=(fallbackProfile.last_name||\"\").trim();const fallbackFullName=`${fallbackFirstName} ${fallbackLastName}`.trim();creatorName=fallbackFullName||fallbackFirstName||fallbackLastName||creatorName;console.log(\"[Protection] Updated creatorName from fallback:\",creatorName)}if(!creatorAddress){const fallbackAddress=fallbackProfile.location;creatorAddress=fallbackAddress&&fallbackAddress.trim()!==\"\"?fallbackAddress.trim():creatorAddress;console.log(\"[Protection] Updated creatorAddress from fallback:\",creatorAddress)}}else if(fallbackError){console.error(\"[Protection] Fallback profile fetch failed:\",{code:fallbackError.code,message:fallbackError.message,details:fallbackError.details,hint:fallbackError.hint})}}if(!creatorEmail&&req.user?.email){creatorEmail=req.user.email;console.log(\"[Protection] Set creatorEmail from req.user:\",creatorEmail)}const dealSchema=buildDealSchemaFromDealData(deal);const brandInfo={name:deal.brand_name||\"Brand\",address:deal.brand_address,email:deal.brand_email};if((!creatorAddress||creatorAddress.trim()===\"\")&&creatorProfile){const finalAddress=creatorProfile.location||creatorProfile.address;if(finalAddress&&typeof finalAddress===\"string\"&&finalAddress.trim()!==\"\"){creatorAddress=finalAddress.trim();console.log(\"[Protection] Final address extraction from profile:\",{address:creatorAddress,addressLength:creatorAddress.length,fromLocation:!!creatorProfile.location,locationValue:creatorProfile.location,locationType:typeof creatorProfile.location,fromAddress:!!creatorProfile.address,addressValue:creatorProfile.address,addressType:typeof creatorProfile.address,profileKeys:Object.keys(creatorProfile)})}else{console.warn(\"[Protection] Profile exists but address is empty:\",{hasLocation:!!creatorProfile.location,locationValue:creatorProfile.location,locationType:typeof creatorProfile.location,hasAddress:!!creatorProfile.address,addressValue:creatorProfile.address,addressType:typeof creatorProfile.address,profileKeys:Object.keys(creatorProfile)});console.log(\"[Protection] Attempting fresh database query for location...\");const{data:freshProfile,error:freshError}=await supabase.from(\"profiles\").select(\"location\").eq(\"id\",userId).maybeSingle();if(freshProfile&&!freshError){const freshLocation=freshProfile.location;const freshAddress=freshProfile.address;const freshFinal=freshLocation&&typeof freshLocation===\"string\"&&freshLocation.trim()!==\"\"?freshLocation.trim():freshAddress&&typeof freshAddress===\"string\"&&freshAddress.trim()!==\"\"?freshAddress.trim():null;if(freshFinal){creatorAddress=freshFinal;console.log(\"[Protection] SUCCESS: Got address from fresh database query:\",{address:creatorAddress,addressLength:creatorAddress.length,fromLocation:!!freshLocation,locationValue:freshLocation,fromAddress:!!freshAddress,addressValue:freshAddress})}else{console.error(\"[Protection] Fresh query also returned empty address:\",{freshLocation,freshAddress,locationType:typeof freshLocation,addressType:typeof freshAddress})}}else{console.error(\"[Protection] Fresh database query failed:\",freshError)}}}if(!creatorAddress||creatorAddress.trim()===\"\"){console.error(\"[Protection] CRITICAL: Creator address is still missing after all attempts:\",{hasProfile:!!creatorProfile,profileLocation:creatorProfile?.location,profileAddress:creatorProfile?.address,creatorAddress,userId,dealCreatorId:deal.creator_id})}else{console.log(\"[Protection] SUCCESS: Creator address is available:\",{address:creatorAddress,addressLength:creatorAddress.length,addressPreview:creatorAddress.substring(0,50)})}if((!creatorAddress||creatorAddress.trim()===\"\")&&creatorProfile){const safetyCheck=creatorProfile.location||creatorProfile.address;if(safetyCheck&&typeof safetyCheck===\"string\"&&safetyCheck.trim()!==\"\"){creatorAddress=safetyCheck.trim();console.log(\"[Protection] Safety check: Extracted address from profile:\",{address:creatorAddress,addressLength:creatorAddress.length})}}const creatorInfo={name:creatorName,address:creatorAddress||void 0,email:creatorEmail};console.log(\"[Protection] Final creatorInfo before validation:\",{name:creatorInfo.name,address:creatorInfo.address,addressLength:creatorInfo.address?.length,addressIsDefined:creatorInfo.address!==void 0,addressIsNull:creatorInfo.address===null,addressIsEmptyString:creatorInfo.address===\"\",addressType:typeof creatorInfo.address,email:creatorInfo.email,rawCreatorAddress:creatorAddress,rawCreatorAddressType:typeof creatorAddress});console.log(\"[Protection] === BEFORE VALIDATION ===\");console.log(\"[Protection] Creator Info:\",{name:creatorInfo.name,nameType:typeof creatorInfo.name,nameLength:creatorInfo.name?.length,address:creatorInfo.address,addressType:typeof creatorInfo.address,addressLength:creatorInfo.address?.length,addressTrimmed:creatorInfo.address?.trim(),addressIsEmpty:!creatorInfo.address||creatorInfo.address.trim()===\"\",email:creatorInfo.email,emailType:typeof creatorInfo.email});console.log(\"[Protection] Creator Address Details:\",{raw:creatorAddress,trimmed:creatorAddress?.trim(),length:creatorAddress?.length,isEmpty:!creatorAddress||creatorAddress.trim()===\"\",hasLocation:!!creatorProfile?.location,hasAddress:!!creatorProfile?.address,locationValue:creatorProfile?.location,addressValue:creatorProfile?.address});console.log(\"[Protection] Brand Info:\",{name:brandInfo.name,address:brandInfo.address,email:brandInfo.email});console.log(\"[Protection] Profile Data:\",{hasProfile:!!creatorProfile,firstName:creatorProfile?.first_name,lastName:creatorProfile?.last_name,location:creatorProfile?.location,address:creatorProfile?.address});console.log(\"[Protection] Deal Info:\",{creatorId:deal.creator_id,userId,isCreator:deal.creator_id===userId});console.log(\"[Protection] Validation debug:\",{brandInfo:{name:brandInfo.name,hasAddress:!!brandInfo.address,address:brandInfo.address||\"MISSING\",addressLength:brandInfo.address?.length||0,addressTrimmed:brandInfo.address?.trim()||\"MISSING\"},creatorInfo:{name:creatorInfo.name,nameLength:creatorInfo.name?.length||0,nameTrimmed:creatorInfo.name?.trim()||\"MISSING\",hasAddress:!!creatorInfo.address,address:creatorInfo.address||\"MISSING\",addressLength:creatorInfo.address?.length||0,addressTrimmed:creatorInfo.address?.trim()||\"MISSING\",hasEmail:!!creatorEmail,email:creatorEmail||\"MISSING\"},profileData:{firstName:creatorProfile?.first_name,lastName:creatorProfile?.last_name,address:creatorProfile?.address,location:creatorProfile?.location}});const validation=validateRequiredContractFields(brandInfo,creatorInfo);if(!validation.isValid){console.log(\"[Protection] Validation failed:\",{missingFields:validation.missingFields,brandInfo,creatorInfo});return res.status(400).json({success:false,error:\"Missing required contract fields\",missingFields:validation.missingFields,message:`Please provide the following information before generating the contract: ${validation.missingFields.join(\", \")}`,debug:{creatorInfo:{name:creatorInfo.name,nameLength:creatorInfo.name?.length,address:creatorInfo.address?`${creatorInfo.address.substring(0,20)}...`:\"MISSING\",addressLength:creatorInfo.address?.length,email:creatorInfo.email?`${creatorInfo.email.substring(0,20)}...`:\"MISSING\"},brandInfo:{name:brandInfo.name,hasAddress:!!brandInfo.address,addressLength:brandInfo.address?.length},profileData:{hasProfile:!!creatorProfile,firstName:creatorProfile?.first_name,lastName:creatorProfile?.last_name,hasLocation:!!creatorProfile?.location,hasAddress:!!creatorProfile?.address,location:creatorProfile?.location,address:creatorProfile?.address,allColumns:creatorProfile?Object.keys(creatorProfile):[]},dealInfo:{creatorId:deal.creator_id,userId,isCreator:deal.creator_id===userId}}})}let deliverables=[];try{if(typeof deal.deliverables===\"string\"){deliverables=JSON.parse(deal.deliverables)}else if(Array.isArray(deal.deliverables)){deliverables=deal.deliverables}else{deliverables=[\"As per agreement\"]}}catch{deliverables=[deal.deliverables||\"As per agreement\"]}const result=await generateContractFromScratch({brandName:deal.brand_name||\"Brand\",creatorName,creatorEmail,dealAmount:deal.deal_amount||0,deliverables,paymentTerms:deal.payment_expected_date?`Payment expected by ${new Date(deal.payment_expected_date).toLocaleDateString()}`:void 0,dueDate:deal.due_date?new Date(deal.due_date).toLocaleDateString():void 0,paymentExpectedDate:deal.payment_expected_date?new Date(deal.payment_expected_date).toLocaleDateString():void 0,platform:deal.platform||\"Multiple Platforms\",brandEmail:deal.brand_email||void 0,brandPhone:deal.brand_phone||void 0,brandAddress:deal.brand_address||void 0,creatorAddress:creatorAddress||creatorProfile?.location||creatorProfile?.address||void 0,dealSchema,usageType:deal.usage_type||void 0,usagePlatforms:deal.platform?[deal.platform]:deal.usage_platforms||void 0,usageDuration:deal.usage_duration||void 0,paidAdsAllowed:deal.paid_ads_allowed,whitelistingAllowed:deal.whitelisting_allowed,exclusivityEnabled:deal.exclusivity_enabled,exclusivityCategory:deal.exclusivity_category,exclusivityDuration:deal.exclusivity_duration,terminationNoticeDays:deal.termination_notice_days,jurisdictionCity:deal.jurisdiction_city});if(!result.contractDocx){return res.status(500).json({success:false,error:\"Failed to generate contract DOCX\"})}const timestamp=Date.now();const storagePath=`contracts/${dealId}/${timestamp}_${result.fileName}`;const{error:uploadError}=await supabase.storage.from(\"creator-assets\").upload(storagePath,result.contractDocx,{contentType:result.contentType,upsert:false});let contractUrl=null;if(!uploadError){const{data:publicUrlData}=supabase.storage.from(\"creator-assets\").getPublicUrl(storagePath);contractUrl=publicUrlData?.publicUrl||null;console.log(\"[Protection] DOCX uploaded successfully:\",contractUrl)}else{console.error(\"[Protection] DOCX upload failed:\",uploadError.message);return res.status(500).json({success:false,error:\"Failed to upload contract DOCX to storage\"})}const baseUpdateData={contract_file_url:contractUrl,updated_at:new Date().toISOString()};console.log(\"[Protection] Updating deal with DOCX contract:\",{dealId,hasDocx:!!result.contractDocx,docxSize:result.contractDocx.length,contractUrl,contractVersion:\"v3\",hasMetadata:!!result.metadata});let updateError=null;let updateResult=null;const updateDataWithAll={...baseUpdateData,contract_version:\"v3\",...result.metadata&&{contract_metadata:result.metadata}};const{error:errorWithAll,data:resultWithAll}=await supabase.from(\"brand_deals\").update(updateDataWithAll).eq(\"id\",dealId).select(\"contract_file_url\");if(!errorWithAll){updateError=null;updateResult=resultWithAll}else if(errorWithAll.message?.includes(\"contract_version\")||errorWithAll.message?.includes(\"contract_metadata\")){console.warn(\"[Protection] Optional columns not found, updating with base fields only:\",errorWithAll.message);const baseFieldsOnly={contract_file_url:contractUrl,updated_at:new Date().toISOString()};const{error:errorBase,data:resultBase}=await supabase.from(\"brand_deals\").update(baseFieldsOnly).eq(\"id\",dealId).select(\"contract_file_url\");updateError=errorBase;updateResult=resultBase}else{updateError=errorWithAll;updateResult=resultWithAll}if(updateError){console.error(\"[Protection] CRITICAL: Failed to update deal with new contract:\",{error:updateError,dealId,baseUpdateData,contractUrl})}else{console.log(\"[Protection] Successfully updated deal with new v3 DOCX contract:\",{dealId,updatedFields:updateResult?.[0]})}return res.json({success:true,contractDocxUrl:contractUrl,fileName:result.fileName,contentType:result.contentType,contractVersion:\"v3\",databaseUpdated:!updateError,...result.metadata&&{metadata:result.metadata}})}catch(error){console.error(\"[Protection] Generate contract from scratch error:\",error);if(error.message?.includes(\"Chrome/Puppeteer is required\")||error.message?.includes(\"Could not find Chrome\")||error.message?.includes(\"Puppeteer is required\")){return res.status(500).json({success:false,error:error.message||\"Contract PDF generation failed. Chrome/Puppeteer is required.\",requiresPuppeteer:true})}const isValidationError=error.message&&(error.message.includes(\"Missing required fields\")||error.message.includes(\"Please complete\")||error.message.includes(\"Jurisdiction could not be determined\"));const statusCode=isValidationError?400:500;const errorMessage=isValidationError?error.message:\"Failed to generate contract from scratch. Please try again or contact support.\";const missingFields=error.missingFields||(isValidationError?error.message.match(/Missing required fields: (.+)/)?.[1]?.split(\", \"):void 0);res.status(statusCode).json({success:false,error:errorMessage,missingFields})}});router.post(\"/generate-contract-docx\",async(req,res)=>{try{const userId=req.user.id;const{dealId}=req.body;if(!dealId){return res.status(400).json({success:false,error:\"dealId is required\"})}const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"*\").eq(\"id\",dealId).single();if(dealError||!deal){console.error(\"[Protection] Deal fetch error:\",dealError);return res.status(404).json({success:false,error:\"Deal not found\"})}if(deal.creator_id!==userId&&req.user.role!==\"admin\"){return res.status(403).json({success:false,error:\"Access denied\"})}let creatorName=\"Creator\";let creatorEmail=req.user?.email;let creatorAddress;const{data:creatorProfile}=await supabase.from(\"profiles\").select(\"first_name, last_name, location\").eq(\"id\",deal.creator_id).single();if(creatorProfile){creatorName=(creatorProfile.first_name+\" \"+(creatorProfile.last_name||\"\")).trim()||creatorName;creatorEmail=req.user?.email||creatorEmail;creatorAddress=creatorProfile.location||deal.creator_address}const{data:signatures}=await supabase.from(\"contract_signatures\").select(\"signer_role, signer_name, signer_email, signed_at, otp_verified_at, ip_address, user_agent\").eq(\"deal_id\",dealId);const brandSig=signatures?.find(s=>s.signer_role===\"brand\");const creatorSig=signatures?.find(s=>s.signer_role===\"creator\");const contractRequest={brandName:deal.brand_name||\"Brand\",creatorName,dealAmount:deal.deal_amount||0,deliverables:Array.isArray(deal.deliverables)?deal.deliverables:[deal.deliverables||\"As per agreement\"],brandEmail:deal.brand_email,brandAddress:deal.brand_address,creatorEmail,creatorAddress,dealSchema:deal.deal_schema,usageType:deal.usage_type,usagePlatforms:deal.usage_platforms||[deal.platform||\"Instagram\"],usageDuration:deal.usage_duration,paidAdsAllowed:deal.paid_ads_allowed,whitelistingAllowed:deal.whitelisting_allowed,exclusivityEnabled:deal.exclusivity_enabled,exclusivityCategory:deal.exclusivity_category,exclusivityDuration:deal.exclusivity_duration,terminationNoticeDays:deal.termination_notice_days,jurisdictionCity:deal.jurisdiction_city,additionalTerms:deal.additional_terms,brandSignature:brandSig?{signer_name:brandSig.signer_name,signer_email:brandSig.signer_email,signed_at:brandSig.signed_at,otp_verified_at:brandSig.otp_verified_at,ip_address:brandSig.ip_address,user_agent:brandSig.user_agent}:void 0,creatorSignature:creatorSig?{signer_name:creatorSig.signer_name,signer_email:creatorSig.signer_email,signed_at:creatorSig.signed_at,otp_verified_at:creatorSig.otp_verified_at,ip_address:creatorSig.ip_address,user_agent:creatorSig.user_agent}:void 0};const result=await generateContractFromScratch(contractRequest);res.setHeader(\"Content-Type\",\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");res.setHeader(\"Content-Disposition\",`attachment; filename=\"${result.fileName}\"`);res.setHeader(\"Content-Length\",result.contractDocx.length.toString());return res.send(result.contractDocx)}catch(error){console.error(\"[Protection] Generate contract DOCX error:\",error);const isValidationError=error.message&&(error.message.includes(\"Missing required fields\")||error.message.includes(\"is required\")||error.message.includes(\"Please complete\"));const statusCode=isValidationError?400:500;const errorMessage=isValidationError?error.message:\"Failed to generate contract DOCX. Please try again or contact support.\";res.status(statusCode).json({success:false,error:errorMessage})}});router.post(\"/generate-fix\",async(req,res)=>{try{const userId=req.user.id;const{issueId,originalClause,reportId,issueIndex}=req.body;let issue=null;if(issueId&&issueId.length===36){const{data,error:issueError}=await supabase.from(\"protection_issues\").select(\"*, report:protection_reports!report_id(user_id, deal:brand_deals!deal_id(creator_id))\").eq(\"id\",issueId).single();if(issueError||!data){return res.status(404).json({success:false,error:\"Issue not found\"})}issue=data}else if(reportId&&(issueIndex!==void 0||originalClause)){const{data:issues,error:issuesError}=await supabase.from(\"protection_issues\").select(\"*, report:protection_reports!report_id(user_id, deal:brand_deals!deal_id(creator_id))\").eq(\"report_id\",reportId).order(\"created_at\",{ascending:true});if(issuesError||!issues||issues.length===0){return res.status(404).json({success:false,error:\"Issues not found for this report\"})}if(issueIndex!==void 0){issue=issues[issueIndex]}else if(originalClause){issue=issues.find(i=>i.clause_reference===originalClause||i.title===originalClause)}if(!issue){return res.status(404).json({success:false,error:\"Issue not found\"})}}else{return res.status(400).json({success:false,error:\"issueId (UUID) or (reportId + issueIndex/originalClause) required\"})}const report=issue.report;const hasAccess=report?.user_id===userId||report?.deal?.creator_id===userId||!report?.deal_id||req.user.role===\"admin\";if(!hasAccess){return res.status(403).json({success:false,error:\"Access denied\"})}const actualIssueId=issueId||issue.id;const{data:existingClause}=await supabase.from(\"safe_clauses\").select(\"*\").eq(\"issue_id\",actualIssueId).single();if(existingClause){return res.json({success:true,safeClause:existingClause.safe_clause,explanation:existingClause.explanation})}const result=await generateSafeClause({originalClause,issueContext:issue.description,issueCategory:issue.category});await supabase.from(\"safe_clauses\").insert({report_id:issue.report_id,issue_id:actualIssueId,original_clause:originalClause,safe_clause:result.safeClause,explanation:result.explanation});res.json({success:true,safeClause:result.safeClause,explanation:result.explanation})}catch(error){console.error(\"[Protection] Generate fix error:\",error);res.status(500).json({success:false,error:error.message||\"Failed to generate safe clause\"})}});router.post(\"/generate-negotiation-message\",async(req,res)=>{try{const userId=req.user.id;const{reportId,brandName,issues:issuesFromBody}=req.body;let issuesList=[];if(reportId){const{data:report,error:reportError}=await supabase.from(\"protection_reports\").select(\"*, deal:brand_deals!deal_id(creator_id)\").eq(\"id\",reportId).single();if(reportError||!report){return res.status(404).json({success:false,error:\"Report not found\"})}const hasAccess=report.user_id===userId||report.deal?.creator_id===userId||!report.deal_id||req.user.role===\"admin\";if(!hasAccess){return res.status(403).json({success:false,error:\"Access denied\"})}const{data:dbIssues,error:issuesError}=await supabase.from(\"protection_issues\").select(\"*\").eq(\"report_id\",reportId).in(\"severity\",[\"high\",\"medium\",\"warning\"]).order(\"severity\",{ascending:false});if(issuesError){throw new Error(`Failed to fetch issues: ${issuesError.message}`)}if(!dbIssues||dbIssues.length===0){return res.status(400).json({success:false,error:\"No issues found for this report\"})}issuesList=dbIssues}else if(issuesFromBody&&Array.isArray(issuesFromBody)&&issuesFromBody.length>0){issuesList=issuesFromBody.filter(issue=>issue.severity===\"high\"||issue.severity===\"medium\"||issue.severity===\"warning\");if(issuesList.length===0){return res.status(400).json({success:false,error:\"No issues provided\"})}}else{return res.status(400).json({success:false,error:\"reportId or issues array is required\"})}const riskyClauses=issuesList.filter(issue=>issue.severity===\"high\"||issue.severity===\"medium\");const missingClauses=issuesList.filter(issue=>issue.severity===\"warning\");const riskyClausesContext=riskyClauses.map((issue,index)=>{const severityLabel=issue.severity===\"high\"?\"HIGH PRIORITY\":\"MEDIUM PRIORITY\";return`${index+1}. [${severityLabel}] ${issue.title||\"Issue\"}\n\nCategory: ${issue.category||\"General\"}\n\nDescription: ${issue.description||\"No description\"}\n\nRecommendation: ${issue.recommendation||\"Please review and revise this clause.\"}\n\n${issue.clause_reference?`Clause Reference: ${issue.clause_reference}`:\"\"}`}).join(\"\\n\\n\");const missingClausesContext=missingClauses.map((issue,index)=>{return`${index+1}. ${issue.title||\"Missing Clause\"}\n\nCategory: ${issue.category||\"General\"}\n\nDescription: ${issue.description||\"This important point is not specified in the contract.\"}\n\nRecommendation: ${issue.recommendation||\"Please add this clause to the contract.\"}\n\n${issue.clause_reference?`Clause Reference: ${issue.clause_reference}`:\"\"}`}).join(\"\\n\\n\");const prompt=`You are a professional legal advisor helping a creator negotiate better contract terms with a brand.\n\nTASK: Write a professional, polite, but firm legal negotiation message requesting changes for the following contract issues.\n\nBRAND NAME: ${brandName||\"the Brand\"}\n\n${riskyClauses.length>0?`A. CLAUSES TO IMPROVE (These terms are in the contract but need revision):\n${riskyClausesContext}\n\n`:\"\"}${missingClauses.length>0?`B. IMPORTANT POINTS MISSING (These clauses are not written anywhere yet):\n${missingClausesContext}\n\n`:\"\"}REQUIREMENTS:\n1. Professional and respectful tone - maintain positive working relationship\n2. Group your response into two clear sections:\n   ${riskyClauses.length>0?'- Section A: \"Clauses to improve\" - List the risky/unfair clauses that need revision':\"\"}\n   ${missingClauses.length>0?'- Section B: \"Important points missing\" - List the missing clauses that need to be added':\"\"}\n3. Clear explanation of each requested change\n4. Reference specific clauses or sections when mentioned\n5. Suggest fair alternatives that benefit both parties\n6. Legally sound and business-friendly language\n7. Suitable for email or formal communication (WhatsApp/Email)\n8. Keep it concise but comprehensive\n9. Start with a friendly greeting\n10. End with a call to action requesting a revised contract\n\nTONE GUIDELINES:\n- Cooperative, not confrontational\n- Firm on legal protections, flexible on business terms\n- Professional but approachable\n- Focus on mutual benefit\n\nReturn ONLY the negotiation message text, no additional formatting, markdown, or explanations. Write it as if the creator is sending it directly to the brand.`;const message=await callLLM(prompt);const cleanMessage=message.trim();if(reportId){const{error:saveError}=await supabase.from(\"negotiation_messages\").insert({report_id:reportId,user_id:userId,message:cleanMessage,brand_name:brandName||null});if(saveError){console.warn(\"[Protection] Failed to save negotiation message:\",saveError.message)}}else{console.log(\"[Protection] Skipping database save - reportId not provided\")}res.json({success:true,message:cleanMessage})}catch(error){console.error(\"[Protection] Generate negotiation message error:\",error);res.status(500).json({success:false,error:error.message||\"Failed to generate negotiation message\"})}});router.post(\"/send-negotiation-email\",async(req,res)=>{try{const userId=req.user.id;const{toEmail,message,reportId}=req.body;if(!toEmail||!message){return res.status(400).json({success:false,error:\"toEmail and message are required\"})}const emailRegex=/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;if(!emailRegex.test(toEmail)){return res.status(400).json({success:false,error:\"Invalid email address\"})}if(reportId){const{data:report,error:reportError}=await supabase.from(\"protection_reports\").select(\"*, deal:brand_deals!deal_id(creator_id)\").eq(\"id\",reportId).single();if(!reportError&&report){const hasAccess=report.user_id===userId||report.deal?.creator_id===userId||!report.deal_id||req.user.role===\"admin\";if(!hasAccess){return res.status(403).json({success:false,error:\"Access denied\"})}}}const{data:profile}=await supabase.from(\"profiles\").select(\"first_name, last_name\").eq(\"id\",userId).single();const fromEmail=profile?.email||req.user.email||\"noreply@creatorarmour.com\";const fromName=profile?.first_name&&profile?.last_name?`${profile.first_name} ${profile.last_name}`:\"CreatorArmour User\";console.log(\"[Protection] Email would be sent:\");console.log(\"From:\",`${fromName} <${fromEmail}>`);console.log(\"To:\",toEmail);console.log(\"Subject: Request for Contract Revisions \\u2013 Legal Review Applied\");console.log(\"Message:\",message);res.json({success:true,message:\"Email sent successfully\"})}catch(error){console.error(\"[Protection] Send negotiation email error:\",error);res.status(500).json({success:false,error:error.message||\"Failed to send email\"})}});router.post(\"/send-for-legal-review\",async(req,res)=>{try{const userId=req.user.id;const{reportId,userEmail,userPhone}=req.body;if(!reportId){return res.status(400).json({success:false,error:\"reportId is required\"})}const{data:report,error:reportError}=await supabase.from(\"protection_reports\").select(\"*, deal:brand_deals!deal_id(creator_id)\").eq(\"id\",reportId).single();if(reportError||!report){return res.status(404).json({success:false,error:\"Report not found\"})}const hasAccess=report.user_id===userId||report.deal?.creator_id===userId||!report.deal_id||req.user.role===\"admin\";if(!hasAccess){return res.status(403).json({success:false,error:\"Access denied\"})}const{data:profile}=await supabase.from(\"profiles\").select(\"phone\").eq(\"id\",userId).single();const{error:insertError}=await supabase.from(\"legal_review_requests\").insert({report_id:reportId,user_id:userId,user_email:userEmail||profile?.email||req.user.email,user_phone:userPhone||profile?.phone,status:\"pending\",requested_at:new Date().toISOString()});if(insertError){console.warn(\"[Protection] Failed to save legal review request:\",insertError.message)}else{console.log(`[Protection] Legal review requested for report ${reportId} by user ${userId}`)}res.json({success:true,message:\"Legal review request submitted successfully\"})}catch(error){console.error(\"[Protection] Send for legal review error:\",error);res.status(500).json({success:false,error:error.message||\"Failed to submit legal review request\"})}});router.post(\"/save-report\",async(req,res)=>{try{const userId=req.user.id;const{reportId}=req.body;if(!reportId){return res.status(400).json({success:false,error:\"reportId is required\"})}const{data:report,error:reportError}=await supabase.from(\"protection_reports\").select(\"*, deal:brand_deals!deal_id(creator_id)\").eq(\"id\",reportId).single();if(reportError||!report){return res.status(404).json({success:false,error:\"Report not found\"})}const hasAccess=report.user_id===userId||report.deal?.creator_id===userId||!report.deal_id||req.user.role===\"admin\";if(!hasAccess){return res.status(403).json({success:false,error:\"Access denied\"})}const{data:existing}=await supabase.from(\"saved_reports\").select(\"*\").eq(\"user_id\",userId).eq(\"report_id\",reportId).single();if(existing){return res.json({success:true,message:\"Report already saved\"})}const{error:insertError}=await supabase.from(\"saved_reports\").insert({user_id:userId,report_id:reportId,saved_at:new Date().toISOString()});if(insertError){console.warn(\"[Protection] Failed to save report:\",insertError.message)}res.json({success:true,message:\"Report saved successfully\"})}catch(error){console.error(\"[Protection] Save report error:\",error);res.status(500).json({success:false,error:error.message||\"Failed to save report\"})}});router.get(\"/download-report/:reportId\",async(req,res)=>{try{const userId=req.user.id;const{reportId}=req.params;const{data:report,error}=await supabase.from(\"protection_reports\").select(\"*, deal:brand_deals!deal_id(creator_id)\").eq(\"id\",reportId).single();if(error||!report){return res.status(404).json({error:\"Report not found\"})}const reportData=report;if(reportData.deal?.creator_id!==userId&&req.user.role!==\"admin\"){return res.status(403).json({error:\"Access denied\"})}if(!reportData.pdf_report_url){return res.status(404).json({error:\"PDF report not available\"})}const path=reportData.pdf_report_url.split(\"/\").slice(-2).join(\"/\");const signedUrl=await generateSignedDownloadUrl(path,3600);res.redirect(signedUrl)}catch(error){console.error(\"[Protection] Download report error:\",error);res.status(500).json({error:error.message})}});const downloadContractDocxHandler=__name(async(req,res)=>{try{const{dealId}=req.params;const accessToken=req.query.token||\"\";const authHeader=req.headers.authorization;const bearerToken=authHeader&&authHeader.startsWith(\"Bearer \")?authHeader.substring(7):\"\";console.log(\"[Protection] Download DOCX request:\",{dealId,path:req.path});if(!dealId){return res.status(400).json({error:\"Deal ID is required\"})}let deal=null;let dealError=null;const{data:dealWithHtml,error:htmlError}=await supabase.from(\"brand_deals\").select(\"id, creator_id, contract_html, brand_response_status\").eq(\"id\",dealId).maybeSingle();if(htmlError&&htmlError.message?.includes(\"contract_html\")&&htmlError.message?.includes(\"does not exist\")){console.warn(\"[Protection] contract_html column does not exist, fetching without it\");const{data:dealBasic,error:basicError}=await supabase.from(\"brand_deals\").select(\"id, creator_id, brand_response_status, contract_file_url, safe_contract_url\").eq(\"id\",dealId).maybeSingle();deal=dealBasic;dealError=basicError}else{deal=dealWithHtml;dealError=htmlError}if(dealError){console.error(\"[Protection] Deal query error:\",dealError);return res.status(500).json({error:\"Failed to fetch deal\",details:dealError.message})}if(!deal){console.warn(\"[Protection] Deal not found:\",dealId);return res.status(404).json({error:\"Deal not found\"})}let hasAccess=false;if(accessToken){const{data:tokenData}=await supabase.from(\"contract_ready_tokens\").select(\"id, deal_id, is_active, revoked_at, expires_at\").eq(\"id\",accessToken).maybeSingle();if(tokenData&&tokenData.deal_id===dealId&&tokenData.is_active===true&&!tokenData.revoked_at&&(!tokenData.expires_at||new Date(tokenData.expires_at)>new Date)){hasAccess=true}}if(!hasAccess&&bearerToken){try{const{data:authData}=await supabase.auth.getUser(bearerToken);const user=authData?.user;if(user?.id){const{data:profile}=await supabase.from(\"profiles\").select(\"role\").eq(\"id\",user.id).maybeSingle();if(deal.creator_id===user.id||profile?.role===\"admin\"){hasAccess=true}}}catch(e){}}if(!hasAccess){return res.status(401).json({error:\"Unauthorized\"})}const{data:signatures}=await supabase.from(\"contract_signatures\").select(\"signer_role, signed, signer_name, signer_email, signed_at, otp_verified_at, ip_address, user_agent\").eq(\"deal_id\",dealId);const brandSigned=signatures?.some(s=>s.signer_role===\"brand\"&&s.signed);const creatorSigned=signatures?.some(s=>s.signer_role===\"creator\"&&s.signed);const bothSigned=brandSigned&&creatorSigned;if(deal.brand_response_status!==\"accepted_verified\"&&!bothSigned){return res.status(403).json({error:\"Contract is not yet available for download\"})}const contractFileUrl=deal.contract_file_url||deal.safe_contract_url;if(contractFileUrl&&!bothSigned){console.log(\"[Protection] Contract file URL found and not both signed, redirecting to:\",contractFileUrl);return res.redirect(contractFileUrl)}if(bothSigned&&signatures&&signatures.length>0){console.log(\"[Protection] \\u2705 Using NEW REFACTORED contract template (v2.0 - improved layout, spacing, readability)\");console.log(\"[Protection] Both parties signed. Generating professional contract with latest template format...\");try{const{data:fullDeal}=await supabase.from(\"brand_deals\").select(\"*\").eq(\"id\",dealId).single();if(!fullDeal){throw new Error(\"Deal not found\")}const submissionDetails=await getDealSubmissionDetails(dealId);const formData=submissionDetails?.formData||{};const{data:creatorProfile,error:creatorProfileError}=await supabase.from(\"profiles\").select(\"first_name, last_name, location\").eq(\"id\",fullDeal.creator_id).single();console.log(\"[Protection] Creator profile fetch result:\",{hasCreatorProfile:!!creatorProfile,creatorProfileError,creatorId:fullDeal.creator_id,profileLocation:creatorProfile?.location,profileLocationType:typeof creatorProfile?.location,profileLocationLength:creatorProfile?.location?.length,profileAddress:creatorProfile?.address,profileFirstName:creatorProfile?.first_name,profileLastName:creatorProfile?.last_name,fullProfile:creatorProfile});const{data:creatorAuth}=await supabase.auth.admin.getUserById(fullDeal.creator_id);const creatorEmail=creatorAuth?.user?.email||\"\";const dealSchema=buildDealSchemaFromDealData(fullDeal);const brandSig=signatures.find(s=>s.signer_role===\"brand\");const creatorSig=signatures.find(s=>s.signer_role===\"creator\");const brandName=fullDeal.brand_name||formData.brandName||\"Brand\";const brandAddress=fullDeal.brand_address||formData.companyAddress||\"N/A\";const brandEmail=fullDeal.brand_email||formData.companyEmail||\"\";let creatorName=\"Creator\";if(creatorProfile){const firstName=(creatorProfile.first_name||\"\").trim();const lastName=(creatorProfile.last_name||\"\").trim();if(firstName&&lastName){creatorName=`${firstName} ${lastName}`.trim()}else if(firstName){creatorName=firstName}else if(lastName){creatorName=lastName}}if(creatorName===\"Creator\"&&creatorSig?.signer_name){creatorName=creatorSig.signer_name}if(creatorName===\"Creator\"&&creatorEmail){const emailUsername=creatorEmail.split(\"@\")[0];if(emailUsername&&emailUsername.length>=2){creatorName=emailUsername.charAt(0).toUpperCase()+emailUsername.slice(1)}}const locationValue=creatorProfile?.location;console.log(\"[Protection] Extracting creator address:\",{hasCreatorProfile:!!creatorProfile,locationValue,locationValueType:typeof locationValue,locationValueLength:locationValue?.length,profileKeys:creatorProfile?Object.keys(creatorProfile):[]});const rawCreatorAddress=locationValue&&typeof locationValue===\"string\"&&locationValue.trim()!==\"\"&&locationValue.toLowerCase()!==\"n/a\"?locationValue.trim():null;console.log(\"[Protection] Raw creator address extracted:\",{rawCreatorAddress,rawCreatorAddressType:typeof rawCreatorAddress,rawCreatorAddressLength:rawCreatorAddress?.length,rawCreatorAddressPreview:rawCreatorAddress?.substring(0,100)});const creatorAddress=rawCreatorAddress||void 0;console.log(\"[Protection] Final creator address for validation:\",{creatorAddress,creatorAddressType:typeof creatorAddress,creatorAddressLength:creatorAddress?.length,creatorAddressPreview:creatorAddress?.substring(0,100)});const brandInfo={name:brandName,address:brandAddress,email:brandEmail};const creatorInfo={name:creatorName,address:creatorAddress,email:creatorEmail};const validation=validateRequiredContractFields(brandInfo,creatorInfo);if(!validation.isValid){console.error(\"[Protection] Validation failed for download-docx:\",{missingFields:validation.missingFields,creatorName,creatorNameLength:creatorName?.length,creatorAddress,creatorAddressLength:creatorAddress?.length,creatorAddressType:typeof creatorAddress,creatorAddressPreview:creatorAddress?.substring(0,100),hasCreatorProfile:!!creatorProfile,profileFirstName:creatorProfile?.first_name,profileLastName:creatorProfile?.last_name,profileLocation:creatorProfile?.location,profileLocationType:typeof creatorProfile?.location,profileLocationLength:creatorProfile?.location?.length,profileLocationPreview:creatorProfile?.location?.substring(0,100),locationValue,rawCreatorAddress,dealId:fullDeal.id,creatorId:fullDeal.creator_id});const missingName=validation.missingFields.some(f=>f.includes(\"name\"));const missingAddress=validation.missingFields.some(f=>f.includes(\"address\"));let helpMessage=\"Cannot generate contract. \";if(missingName&&missingAddress){helpMessage+=\"Please update your profile with your full name (first name and last name) and address. \"}else if(missingName){helpMessage+=\"Please update your profile with your full name (first name and last name). \"}else if(missingAddress){helpMessage+=\"Please update your profile with your address (city and state minimum). \";helpMessage+='Go to Profile Settings \\u2192 Click the Edit button (top right) \\u2192 Scroll down to \"Address\" field \\u2192 Enter your address \\u2192 Click Save. '}if(!missingAddress){helpMessage+=\"You can update your profile from the Profile Settings page.\"}return res.status(400).json({success:false,error:\"Missing required contract fields\",missingFields:validation.missingFields,message:helpMessage,debug:process.env.NODE_ENV===\"development\"?{creatorName,creatorAddress,hasCreatorProfile:!!creatorProfile,profileData:creatorProfile?{hasFirstName:!!creatorProfile.first_name,hasLastName:!!creatorProfile.last_name,hasLocation:!!creatorProfile.location,hasAddress:!!creatorProfile.address}:null}:void 0})}const contractVars=mapDealSchemaToContractVariables(dealSchema,{name:brandName,address:brandAddress,email:brandEmail},{name:creatorName,address:creatorAddress,email:creatorEmail});const deliverablesText=contractVars.deliverables_list||\"As per agreement\";const deliveryDeadline=contractVars.delivery_deadline||(fullDeal.due_date?new Date(fullDeal.due_date).toLocaleDateString(\"en-IN\",{year:\"numeric\",month:\"long\",day:\"numeric\"}):\"As mutually agreed\");const paymentTimeline=contractVars.payment_timeline||\"Within 7 days of content delivery\";const paymentExpectedDate=fullDeal.payment_expected_date?new Date(fullDeal.payment_expected_date).toLocaleDateString(\"en-IN\",{day:\"2-digit\",month:\"2-digit\",year:\"numeric\"}):deliveryDeadline.split(\" \").slice(-3).join(\"/\");const usagePlatforms=contractVars.usage_platforms||\"Instagram\";const usageDuration=contractVars.usage_duration||\"6 months\";const paidAds=contractVars.paid_ads_allowed===\"Yes\"?\"Yes\":\"No\";const whitelisting=contractVars.whitelisting_allowed===\"Yes\"?\"Yes\":\"No\";const exclusivityText=contractVars.exclusivity_clause||\"No exclusivity period applies.\";const terminationDays=contractVars.termination_notice_days||7;const jurisdictionCity=contractVars.jurisdiction_city||\"Delhi\";const brandSigDate=brandSig?.signed_at?new Date(brandSig.signed_at).toLocaleDateString(\"en-IN\",{year:\"numeric\",month:\"long\",day:\"numeric\"}):\"\";const creatorSigDate=creatorSig?.signed_at?new Date(creatorSig.signed_at).toLocaleDateString(\"en-IN\",{year:\"numeric\",month:\"long\",day:\"numeric\"}):\"\";console.log(\"[Protection] \\u2705 Generating contract HTML with REFACTORED template (v2.0)...\");const contractSummary=`\n            <!DOCTYPE html>\n            <html>\n            <head>\n              <meta charset=\"UTF-8\">\n              <style>\n                body { \n                  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif; \n                  padding: 60px 70px; \n                  line-height: 1.5; \n                  color: #000;\n                  max-width: 800px;\n                  margin: 0 auto;\n                  font-size: 11pt;\n                }\n                h1 { \n                  text-align: center; \n                  font-size: 20pt; \n                  font-weight: bold; \n                  margin-bottom: 12px;\n                  margin-top: 40px;\n                  text-transform: uppercase;\n                  letter-spacing: 1.5px;\n                  line-height: 1.2;\n                }\n                .header-divider {\n                  border-top: 2px solid #333;\n                  margin: 20px auto 50px;\n                  width: 80%;\n                }\n                h2 {\n                  font-size: 13pt;\n                  font-weight: bold;\n                  margin-top: 36px;\n                  margin-bottom: 20px;\n                  line-height: 1.4;\n                  color: #000;\n                  page-break-after: avoid;\n                }\n                .date {\n                  text-align: center;\n                  margin-bottom: 20px;\n                  font-size: 10pt;\n                  color: #666;\n                }\n                .section {\n                  margin-bottom: 36px;\n                  line-height: 1.5;\n                  page-break-inside: avoid;\n                }\n                .parties {\n                  margin: 24px 0;\n                }\n                .party {\n                  margin: 20px 0;\n                  padding-left: 20px;\n                }\n                .party-label {\n                  font-weight: bold;\n                  font-size: 12pt;\n                  margin-bottom: 10px;\n                  color: #000;\n                }\n                .party-detail {\n                  margin: 8px 0;\n                  padding-left: 15px;\n                  line-height: 1.5;\n                }\n                .party-detail-label {\n                  font-weight: 600;\n                  display: inline-block;\n                  min-width: 70px;\n                }\n                .signature-section {\n                  margin-top: 36px;\n                  page-break-inside: avoid;\n                }\n                .execution-notice {\n                  margin: 24px 0;\n                  padding: 20px;\n                  background-color: #f5f5f5;\n                  border: 1px solid #ddd;\n                  border-left: 4px solid #333;\n                  line-height: 1.6;\n                }\n                .execution-details {\n                  margin-top: 32px;\n                }\n                .execution-details-title {\n                  font-size: 11pt;\n                  font-weight: bold;\n                  margin: 28px 0 16px 0;\n                  text-transform: uppercase;\n                  color: #000;\n                  letter-spacing: 0.5px;\n                }\n                .signature-block {\n                  margin: 20px 0;\n                  padding: 20px;\n                  border: 1px solid #e0e0e0;\n                  background-color: #fafafa;\n                }\n                .signature-block-divider {\n                  margin: 24px 0;\n                  border-top: 1px solid #ddd;\n                  height: 0;\n                }\n                .signature-block-title {\n                  font-weight: bold;\n                  font-size: 11pt;\n                  margin-bottom: 14px;\n                  text-transform: uppercase;\n                  color: #333;\n                }\n                .signature-line {\n                  margin: 10px 0;\n                  padding: 4px 0;\n                  line-height: 1.5;\n                }\n                .signature-label {\n                  font-weight: 600;\n                  display: inline-block;\n                  min-width: 160px;\n                  color: #333;\n                }\n                .footer {\n                  margin-top: 60px;\n                  padding-top: 24px;\n                  border-top: 1px solid #ddd;\n                  font-size: 8pt;\n                  font-style: italic;\n                  text-align: center;\n                  color: #666;\n                  line-height: 1.4;\n                }\n                .section-separator-line {\n                  margin: 36px 0;\n                  padding: 0;\n                  border-top: 2px solid #ccc;\n                  border-bottom: none;\n                  height: 0;\n                  width: 100%;\n                  display: block;\n                }\n                ul {\n                  margin: 18px 0;\n                  padding-left: 30px;\n                }\n                li {\n                  margin: 12px 0;\n                  line-height: 1.5;\n                }\n                p {\n                  margin: 14px 0;\n                  line-height: 1.5;\n                }\n                .compensation-amount {\n                  font-size: 12pt;\n                  font-weight: bold;\n                  color: #000;\n                }\n                .info-line {\n                  margin: 10px 0;\n                  padding-left: 15px;\n                  line-height: 1.5;\n                }\n                .info-label {\n                  font-weight: 600;\n                  display: inline-block;\n                  min-width: 140px;\n                }\n                .deliverables-list {\n                  margin: 18px 0;\n                  padding-left: 30px;\n                }\n                .deliverables-list li {\n                  margin: 12px 0;\n                  line-height: 1.5;\n                }\n                .late-payment-block {\n                  margin: 20px 0;\n                  padding: 16px;\n                  background-color: #f9f9f9;\n                  border-left: 3px solid #666;\n                  line-height: 1.5;\n                }\n              </style>\n            </head>\n            <body>\n              <h1>CREATOR\\u2013BRAND COLLABORATION AGREEMENT</h1>\n              \n              <div class=\"date\">\n                Date: ${contractVars.contract_date}\n              </div>\n              \n              <div class=\"header-divider\"></div>\n\n              <div class=\"section\">\n                <h2>1. PARTIES</h2>\n                <p>This Agreement is entered into between:</p>\n                \n                <div class=\"parties\">\n                  <div class=\"party\">\n                    <div class=\"party-label\">Brand:</div>\n                    <div class=\"party-detail\">\n                      <span class=\"party-detail-label\">Name:</span> ${brandName}\n                    </div>\n                    <div class=\"party-detail\">\n                      <span class=\"party-detail-label\">Address:</span> ${brandAddress}\n                    </div>\n                    <div class=\"party-detail\">\n                      <span class=\"party-detail-label\">Email:</span> ${brandEmail||\"N/A\"}\n                    </div>\n                  </div>\n                  \n                  <div style=\"margin: 24px 0; font-weight: bold; text-align: center; font-size: 11pt;\">AND</div>\n                  \n                  <div class=\"party\">\n                    <div class=\"party-label\">Creator:</div>\n                    <div class=\"party-detail\">\n                      <span class=\"party-detail-label\">Name:</span> ${creatorName}\n                    </div>\n                    <div class=\"party-detail\">\n                      <span class=\"party-detail-label\">Address:</span> ${contractVars.creator_address||creatorAddress||\"\"}\n                    </div>\n                    <div class=\"party-detail\">\n                      <span class=\"party-detail-label\">Email:</span> ${creatorEmail||\"N/A\"}\n                    </div>\n                  </div>\n                </div>\n              </div>\n              \n              <p class=\"section-separator-line\"></p>\n              \n              <div class=\"section\">\n                <h2>2. SCOPE OF WORK</h2>\n                <p>The Creator agrees to deliver the following content (\"Deliverables\"):</p>\n                <ul class=\"deliverables-list\">\n                  ${deliverablesText.split(/\\n\\n|\\n/).filter(line=>line.trim()&&line.trim()!==\"As per agreement\").map(line=>{const cleanLine=line.replace(/^[\\-\\*]\\s*/,\"\").trim();return cleanLine?`<li>${cleanLine}</li>`:\"\"}).filter(item=>item).join(\"\")||\"<li>As per agreement</li>\"}\n                </ul>\n                <p>Content shall be delivered on or before <strong>${deliveryDeadline}</strong>, unless otherwise mutually agreed in writing.</p>\n              </div>\n              \n              <p class=\"section-separator-line\"></p>\n              \n              <div class=\"section\">\n                <h2>3. COMPENSATION & PAYMENT TERMS</h2>\n                <div class=\"info-line\">\n                  <span class=\"info-label\"><strong>Total Compensation:</strong></span>\n                  <span class=\"compensation-amount\">${contractVars.deal_amount_formatted||`\\u20B9${fullDeal.deal_amount||0}`}</span>\n                </div>\n                <div class=\"info-line\">\n                  <span class=\"info-label\"><strong>Payment Method:</strong></span>\n                  ${contractVars.payment_method||\"Bank Transfer\"}\n                </div>\n                <div class=\"info-line\">\n                  <span class=\"info-label\"><strong>Payment Timeline:</strong></span>\n                  ${paymentTimeline}\n                </div>\n                <div class=\"late-payment-block\">\n                  <p style=\"margin: 0 0 8px 0; font-weight: 600;\">Late Payment Protection:</p>\n                  <p style=\"margin: 0; line-height: 1.5;\">If payment is delayed beyond 7 days from the due date, the Brand shall be liable to pay interest at 18% per annum, calculated daily until settlement. The Creator reserves the right to initiate legal recovery proceedings for unpaid dues.</p>\n                </div>\n              </div>\n\n              <p class=\"section-separator-line\"></p>\n              \n              <div class=\"section\">\n                <h2>4. USAGE RIGHTS</h2>\n                <p>The Creator grants the Brand a <strong>${contractVars.usage_type||\"Non-exclusive\"}</strong> license to use the content under the following conditions:</p>\n                <div class=\"info-line\">\n                  <span class=\"info-label\">Platforms:</span>\n                  ${usagePlatforms}\n                </div>\n                <div class=\"info-line\">\n                  <span class=\"info-label\">Usage Duration:</span>\n                  ${usageDuration}\n                </div>\n                <div class=\"info-line\">\n                  <span class=\"info-label\">Paid Advertising:</span>\n                  ${paidAds}\n                </div>\n                <div class=\"info-line\">\n                  <span class=\"info-label\">Whitelisting:</span>\n                  ${whitelisting}\n                </div>\n              </div>\n              \n              <p class=\"section-separator-line\"></p>\n              \n              <div class=\"section\">\n                <h2>5. EXCLUSIVITY</h2>\n                <p>Exclusivity Period: ${exclusivityText}</p>\n              </div>\n              \n              <p class=\"section-separator-line\"></p>\n              \n              <div class=\"section\">\n                <h2>6. TERMINATION</h2>\n                <p>Either party may terminate this Agreement with <strong>${terminationDays} days</strong> written notice.</p>\n              </div>\n              \n              <p class=\"section-separator-line\"></p>\n\n              <div class=\"section\">\n                <h2>7. GOVERNING LAW & JURISDICTION</h2>\n                <p>This Agreement shall be governed by the laws of India.</p>\n                <p>Any disputes shall be subject to the exclusive jurisdiction of the courts of <strong>${jurisdictionCity}</strong>, India.</p>\n              </div>\n              \n              <p class=\"section-separator-line\"></p>\n              \n              <div class=\"signature-section\">\n                <h2>8. DIGITAL ACCEPTANCE & EXECUTION</h2>\n                \n                <div class=\"execution-notice\">\n                  <p style=\"margin: 0 0 10px 0; line-height: 1.6;\">\n                    This Agreement has been executed electronically by both Parties through OTP verification and click-to-accept confirmation in accordance with the Information Technology Act, 2000 (India).\n                  </p>\n                  <p style=\"margin: 10px 0 0 0; font-weight: bold; line-height: 1.6;\">\n                    No physical or handwritten signature is required for legal validity.\n                  </p>\n                </div>\n                \n                <div class=\"execution-details\">\n                  <div class=\"execution-details-title\">EXECUTION DETAILS</div>\n                  \n                  <div class=\"signature-block\">\n                    <div class=\"signature-block-title\">BRAND</div>\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Name:</span>\n                      ${brandSig?.signer_name||brandName}\n                    </div>\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Email:</span>\n                      ${brandSig?.signer_email||brandEmail||\"N/A\"}\n                    </div>\n                    ${brandSig?.otp_verified_at?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">OTP Verified At:</span>\n                      ${new Date(brandSig.otp_verified_at).toLocaleString(\"en-IN\",{timeZone:\"Asia/Kolkata\",dateStyle:\"long\",timeStyle:\"medium\"})}\n                    </div>`:'<div class=\"signature-line\" style=\"font-style: italic; color: #888;\">Status: Pending signature</div>'}\n                    ${brandSig?.ip_address?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">IP Address:</span>\n                      ${brandSig.ip_address}\n                    </div>`:\"\"}\n                    ${brandSig?.user_agent?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Device / User Agent:</span>\n                      ${brandSig.user_agent}\n                    </div>`:\"\"}\n                    ${brandSig?.signed_at?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Execution Timestamp:</span>\n                      ${new Date(brandSig.signed_at).toLocaleString(\"en-IN\",{timeZone:\"Asia/Kolkata\",dateStyle:\"long\",timeStyle:\"medium\"})}\n                    </div>`:\"\"}\n                  </div>\n\n                  <div class=\"signature-block-divider\"></div>\n\n                  <div class=\"signature-block\">\n                    <div class=\"signature-block-title\">CREATOR</div>\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Name:</span>\n                      ${creatorSig?.signer_name||creatorName}\n                    </div>\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Email:</span>\n                      ${creatorSig?.signer_email||creatorEmail||\"N/A\"}\n                    </div>\n                    ${creatorSig?.otp_verified_at?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">OTP Verified At:</span>\n                      ${new Date(creatorSig.otp_verified_at).toLocaleString(\"en-IN\",{timeZone:\"Asia/Kolkata\",dateStyle:\"long\",timeStyle:\"medium\"})}\n                    </div>`:'<div class=\"signature-line\" style=\"font-style: italic; color: #888;\">Status: Pending signature</div>'}\n                    ${creatorSig?.ip_address?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">IP Address:</span>\n                      ${creatorSig.ip_address}\n                    </div>`:\"\"}\n                    ${creatorSig?.user_agent?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Device / User Agent:</span>\n                      ${creatorSig.user_agent}\n                    </div>`:\"\"}\n                    ${creatorSig?.signed_at?`\n                    <div class=\"signature-line\">\n                      <span class=\"signature-label\">Execution Timestamp:</span>\n                      ${new Date(creatorSig.signed_at).toLocaleString(\"en-IN\",{timeZone:\"Asia/Kolkata\",dateStyle:\"long\",timeStyle:\"medium\"})}\n                    </div>`:\"\"}\n                  </div>\n                </div>\n              </div>\n\n              <div class=\"footer\">\n                <p>This agreement was generated using the CreatorArmour Contract Scanner.</p>\n                <p>CreatorArmour is not a party to this agreement and does not provide legal representation.</p>\n                <p>Parties are advised to independently review this agreement.</p>\n              </div>\n            </body>\n            </html>\n          `;const bodyMatch=contractSummary.match(/<body[^>]*>([\\s\\S]*?)<\\/body>/i);const bodyContent=bodyMatch?bodyMatch[1]:contractSummary;const docxCompatibleHtml=prepareHtmlForDocx(bodyContent);const docxBuffer=await generateContractDocx(docxCompatibleHtml);const fileName=`CREATOR_BRAND_COLLABORATION_AGREEMENT_${dealId}_${Date.now()}.docx`;res.setHeader(\"Content-Type\",\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");res.setHeader(\"Content-Disposition\",`attachment; filename=\"${fileName}\"`);res.setHeader(\"Content-Length\",docxBuffer.length.toString());return res.send(docxBuffer)}catch(genError){console.error(\"[Protection] Failed to generate professional contract DOCX:\",genError);console.error(\"[Protection] Error stack:\",genError.stack);return res.status(500).json({error:\"Failed to generate contract\",hint:\"Please try again or contact support.\",details:genError.message})}}else{return res.status(404).json({error:\"Contract not available. Both parties must sign before downloading.\",hint:\"Please ensure both brand and creator have signed the agreement.\",contractFileUrl:contractFileUrl||null,bothSigned:bothSigned||false})}}catch(error){console.error(\"[Protection] Error generating DOCX:\",error);res.status(500).json({error:\"Failed to generate DOCX\",details:error.message})}},\"downloadContractDocxHandler\");const viewContractHandler=__name(async(req,res)=>{try{const{dealId}=req.params;const accessToken=req.query.token||\"\";const authHeader=req.headers.authorization;const bearerToken=authHeader&&authHeader.startsWith(\"Bearer \")?authHeader.substring(7):\"\";console.log(\"[Protection] View contract request:\",{dealId,path:req.path});if(!dealId){return res.status(400).json({error:\"Deal ID is required\"})}let deal=null;let dealError=null;const{data:dealWithHtml,error:htmlError}=await supabase.from(\"brand_deals\").select(\"id, creator_id, contract_html, brand_response_status\").eq(\"id\",dealId).maybeSingle();if(htmlError&&htmlError.message?.includes(\"contract_html\")&&htmlError.message?.includes(\"does not exist\")){console.warn(\"[Protection] contract_html column does not exist, fetching without it\");const{data:dealBasic,error:basicError}=await supabase.from(\"brand_deals\").select(\"id, creator_id, brand_response_status, contract_file_url, safe_contract_url\").eq(\"id\",dealId).maybeSingle();deal=dealBasic;dealError=basicError}else{deal=dealWithHtml;dealError=htmlError}console.log(\"[Protection] Deal query result:\",{hasDeal:!!deal,error:dealError?.message,hasContractHtml:!!deal?.contract_html,brandResponseStatus:deal?.brand_response_status});if(dealError){console.error(\"[Protection] Deal query error:\",dealError);return res.status(500).json({error:\"Failed to fetch deal\",details:dealError.message})}if(!deal){console.warn(\"[Protection] Deal not found:\",dealId);return res.status(404).json({error:\"Deal not found\"})}let hasAccess=false;if(accessToken){const{data:tokenData}=await supabase.from(\"contract_ready_tokens\").select(\"id, deal_id, is_active, revoked_at, expires_at\").eq(\"id\",accessToken).maybeSingle();if(tokenData&&tokenData.deal_id===dealId&&tokenData.is_active===true&&!tokenData.revoked_at&&(!tokenData.expires_at||new Date(tokenData.expires_at)>new Date)){hasAccess=true}}if(!hasAccess&&bearerToken){try{const{data:authData}=await supabase.auth.getUser(bearerToken);const user=authData?.user;if(user?.id){const{data:profile}=await supabase.from(\"profiles\").select(\"role\").eq(\"id\",user.id).maybeSingle();if(deal.creator_id===user.id||profile?.role===\"admin\"){hasAccess=true}}}catch(e){}}if(!hasAccess){return res.status(401).json({error:\"Unauthorized\"})}if(deal.brand_response_status!==\"accepted_verified\"){return res.status(403).json({error:\"Contract is not yet available for viewing\"})}const contractHtml=deal.contract_html;if(!contractHtml){const contractFileUrl=deal.contract_file_url||deal.safe_contract_url;if(contractFileUrl){return res.redirect(contractFileUrl)}return res.status(404).json({error:\"Contract HTML not found. Please regenerate the contract.\",hint:\"The contract_html column may not exist in the database. Please regenerate the contract to create it.\"})}res.setHeader(\"Content-Type\",\"text/html; charset=utf-8\");res.send(contractHtml)}catch(error){console.error(\"[Protection] Error viewing contract:\",error);res.status(500).json({error:\"Failed to load contract\"})}},\"viewContractHandler\");var protection_default=router;export{protection_default as default,downloadContractDocxHandler,viewContractHandler};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/protection.ts"],"sourcesContent":[null]}}