{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{Router}from\"express\";import{authMiddleware}from\"../middleware/auth.js\";import{supabase}from\"../lib/supabase.js\";import{createInstagramOAuthState,exchangeCodeForTokens,fetchInstagramPerformanceSummary,getInstagramOAuthUrl,parseInstagramOAuthState,resolveInstagramBusinessAccount}from\"../services/instagramGraphService.js\";const router=Router();router.post(\"/oauth/url\",authMiddleware,async(req,res)=>{try{const creatorId=req.user?.id;if(!creatorId){return res.status(401).json({success:false,error:\"Unauthorized\"})}const returnTo=typeof req.body?.return_to===\"string\"?req.body.return_to:\"\";const state=createInstagramOAuthState({creatorId,returnTo});const url=getInstagramOAuthUrl(state);return res.json({success:true,auth_url:url,state,redirect_uri:process.env.META_REDIRECT_URI})}catch(error){console.error(\"[InstagramOAuth] oauth/url error:\",error);return res.status(500).json({success:false,error:error?.message||\"Failed to create OAuth URL\"})}});router.get(\"/status\",authMiddleware,async(req,res)=>{try{const creatorId=req.user?.id;if(!creatorId){return res.status(401).json({success:false,error:\"Unauthorized\"})}const[{data:conn,error:connError},{data:latestSnapshot,error:snapshotError},{data:profile,error:profileError}]=await Promise.all([supabase.from(\"instagram_connections\").select(\"ig_user_id, ig_username, connected_at, updated_at, page_access_token\").eq(\"creator_id\",creatorId).maybeSingle(),supabase.from(\"instagram_performance_snapshots\").select(\"created_at\").eq(\"creator_id\",creatorId).order(\"created_at\",{ascending:false}).limit(1).maybeSingle(),supabase.from(\"profiles\").select(\"instagram_handle, last_instagram_sync\").eq(\"id\",creatorId).maybeSingle()]);if(connError){throw connError}if(snapshotError){throw snapshotError}if(profileError){throw profileError}const connected=Boolean(conn?.ig_user_id||conn?.ig_username||profile?.instagram_handle);const lastSyncedAt=latestSnapshot?.created_at||profile?.last_instagram_sync||null;return res.json({success:true,status:{connected,ig_username:conn?.ig_username||profile?.instagram_handle||null,connected_at:conn?.connected_at||null,last_synced_at:lastSyncedAt,can_sync:Boolean(conn?.ig_user_id&&conn?.page_access_token)}})}catch(error){console.error(\"[InstagramOAuth] status error:\",error);return res.status(500).json({success:false,error:error?.message||\"Failed to fetch Instagram status\"})}});router.get(\"/oauth/callback\",async(req,res)=>{const frontendBase=process.env.FRONTEND_URL||\"https://creatorarmour.com\";const sanitizeReturnPath=__name(input=>{if(!input||typeof input!==\"string\")return\"/creator-profile\";if(!input.startsWith(\"/\"))return\"/creator-profile\";if(input.startsWith(\"//\"))return\"/creator-profile\";return input},\"sanitizeReturnPath\");const failRedirect=__name((reason,returnPath)=>`${frontendBase}${returnPath}?instagram_connect=failed&reason=${encodeURIComponent(reason)}`,\"failRedirect\");try{const code=typeof req.query.code===\"string\"?req.query.code:\"\";const stateRaw=typeof req.query.state===\"string\"?req.query.state:\"\";if(!code||!stateRaw){return res.redirect(failRedirect(\"missing_code_or_state\",\"/creator-profile\"))}const state=parseInstagramOAuthState(stateRaw);const creatorId=state.creatorId;const returnPath=sanitizeReturnPath(state.returnTo);const tokenData=await exchangeCodeForTokens(code);let account=null;let summary=null;try{account=await resolveInstagramBusinessAccount(tokenData.userAccessToken);summary=await fetchInstagramPerformanceSummary(account.igUserId,account.pageAccessToken,account.followersCount)}catch(partialError){console.warn(\"[InstagramOAuth] Limited connection (no insights/page permissions yet):\",partialError?.message||partialError)}await supabase.from(\"instagram_connections\").upsert({creator_id:creatorId,meta_user_access_token:tokenData.userAccessToken,user_token_expires_at:tokenData.userExpiresAt,page_id:account?.pageId||null,page_access_token:account?.pageAccessToken||null,ig_user_id:account?.igUserId||null,ig_username:account?.igUsername||null,updated_at:new Date().toISOString(),connected_at:new Date().toISOString()},{onConflict:\"creator_id\"});if(account&&summary){await supabase.from(\"instagram_performance_snapshots\").insert({creator_id:creatorId,ig_user_id:account.igUserId,ig_username:account.igUsername,followers_count:account.followersCount,engagement_rate:summary.engagementRate,median_reel_views:summary.medianReelViews,avg_likes:summary.avgLikes,avg_comments:summary.avgComments,avg_saves:summary.avgSaves,avg_shares:summary.avgShares,sample_size:summary.sampleSize,data_quality:summary.dataQuality,raw:{media:summary.media}});await supabase.from(\"profiles\").update({instagram_handle:account.igUsername,username:account.igUsername,instagram_followers:account.followersCount,instagram_profile_photo:account.profilePhoto,last_instagram_sync:new Date().toISOString()}).eq(\"id\",creatorId)}const successUrl=account?.igUsername?`${frontendBase}${returnPath}?instagram_connect=success&instagram_username=${encodeURIComponent(account.igUsername)}`:`${frontendBase}${returnPath}?instagram_connect=limited`;return res.redirect(successUrl)}catch(error){console.error(\"[InstagramOAuth] callback error:\",error);const rawState=typeof req.query.state===\"string\"?req.query.state:\"\";let returnPath=\"/creator-profile\";try{if(rawState){const parsed=parseInstagramOAuthState(rawState);returnPath=sanitizeReturnPath(parsed.returnTo)}}catch{}return res.redirect(failRedirect(error?.message||\"oauth_failed\",returnPath))}});router.post(\"/insights/sync\",authMiddleware,async(req,res)=>{try{const creatorId=req.user?.id;if(!creatorId){return res.status(401).json({success:false,error:\"Unauthorized\"})}const{data:conn}=await supabase.from(\"instagram_connections\").select(\"page_id, page_access_token, ig_user_id, ig_username\").eq(\"creator_id\",creatorId).maybeSingle();if(!conn?.ig_user_id||!conn?.page_access_token){return res.status(404).json({success:false,error:\"Instagram not connected\"})}const{data:profile}=await supabase.from(\"profiles\").select(\"instagram_followers\").eq(\"id\",creatorId).maybeSingle();const summary=await fetchInstagramPerformanceSummary(conn.ig_user_id,conn.page_access_token,profile?.instagram_followers||null);await supabase.from(\"instagram_performance_snapshots\").insert({creator_id:creatorId,ig_user_id:conn.ig_user_id,ig_username:conn.ig_username,followers_count:profile?.instagram_followers||null,engagement_rate:summary.engagementRate,median_reel_views:summary.medianReelViews,avg_likes:summary.avgLikes,avg_comments:summary.avgComments,avg_saves:summary.avgSaves,avg_shares:summary.avgShares,sample_size:summary.sampleSize,data_quality:summary.dataQuality,raw:{media:summary.media}});return res.json({success:true,summary:{engagement_rate:summary.engagementRate,median_reel_views:summary.medianReelViews,avg_likes:summary.avgLikes,avg_comments:summary.avgComments,avg_saves:summary.avgSaves,avg_shares:summary.avgShares,sample_size:summary.sampleSize,data_quality:summary.dataQuality}})}catch(error){console.error(\"[InstagramOAuth] insights/sync error:\",error);return res.status(500).json({success:false,error:error?.message||\"Failed to sync insights\"})}});var instagramOAuth_default=router;export{instagramOAuth_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/instagramOAuth.ts"],"sourcesContent":[null]}}