{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import crypto from\"crypto\";import{supabase}from\"../lib/supabase.js\";const TOKEN_EXPIRY_DAYS=14;async function createShippingToken(options){const{dealId}=options;if(!dealId)throw new Error(\"dealId is required\");const token=crypto.randomBytes(32).toString(\"hex\");const expiresAt=new Date;expiresAt.setDate(expiresAt.getDate()+TOKEN_EXPIRY_DAYS);const{error}=await supabase.from(\"shipping_tokens\").insert({deal_id:dealId,token,expires_at:expiresAt.toISOString(),used:false});if(error){console.error(\"[ShippingTokenService] Insert error:\",error);throw new Error(\"Failed to create shipping token\")}return{token,expiresAt}}__name(createShippingToken,\"createShippingToken\");async function getShippingTokenInfo(token){if(!token||typeof token!==\"string\"||!token.trim())return null;const trimmed=token.trim();const now=new Date().toISOString();const{data:row,error:tokenError}=await supabase.from(\"shipping_tokens\").select(\"id, deal_id, token, expires_at, used, created_at\").eq(\"token\",trimmed).maybeSingle();if(tokenError||!row)return null;if(row.used)return null;if(new Date(row.expires_at)<new Date(now))return null;const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").select(\"id, brand_name, deliverables, creator_id\").eq(\"id\",row.deal_id).maybeSingle();if(dealError||!deal)return null;let creatorName=\"Creator\";let creatorCity=null;if(deal.creator_id){const{data:profile}=await supabase.from(\"profiles\").select(\"first_name, last_name, location\").eq(\"id\",deal.creator_id).maybeSingle();if(profile){creatorName=`${(profile.first_name||\"\").trim()} ${(profile.last_name||\"\").trim()}`.trim()||\"Creator\";creatorCity=profile.location||null}}let productDescription=typeof deal.deliverables===\"string\"?deal.deliverables:Array.isArray(deal.deliverables)?deal.deliverables.join(\", \"):\"Product\";return{dealId:deal.id,creatorName,creatorCity,productDescription,brandName:deal.brand_name||\"Brand\",used:!!row.used}}__name(getShippingTokenInfo,\"getShippingTokenInfo\");async function useShippingToken(token){if(!token||typeof token!==\"string\"||!token.trim())return null;const trimmed=token.trim();const now=new Date().toISOString();const{data:row,error:fetchError}=await supabase.from(\"shipping_tokens\").select(\"id, deal_id, expires_at, used\").eq(\"token\",trimmed).maybeSingle();if(fetchError||!row||row.used)return null;if(new Date(row.expires_at)<new Date(now))return null;const{error:updateError}=await supabase.from(\"shipping_tokens\").update({used:true}).eq(\"token\",trimmed);if(updateError)return null;return row.deal_id}__name(useShippingToken,\"useShippingToken\");export{createShippingToken,getShippingTokenInfo,useShippingToken};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/shippingTokenService.ts"],"sourcesContent":[null]}}