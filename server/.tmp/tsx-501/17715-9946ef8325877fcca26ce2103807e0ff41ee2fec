{"code":"import{Router}from\"express\";import{supabase}from\"../lib/supabase.js\";const router=Router();router.get(\"/\",async(req,res)=>{try{const userId=req.user.id;const limit=parseInt(req.query.limit)||20;const offset=parseInt(req.query.offset)||0;const{data:conversations,error}=await supabase.from(\"conversations\").select(`\n        *,\n        participants:conversation_participants!inner(\n          user_id,\n          role,\n          last_read_at\n        ),\n        last_message:messages!last_message_id(\n          id,\n          content,\n          sent_at,\n          sender_id\n        )\n      `).eq(\"conversation_participants.user_id\",userId).order(\"updated_at\",{ascending:false}).range(offset,offset+limit-1);if(error)throw error;res.json({data:conversations,limit,offset})}catch(error){res.status(500).json({error:error.message})}});router.post(\"/\",async(req,res)=>{try{const userId=req.user.id;const{participant_ids,title,type=\"direct\",risk_tag}=req.body;if(!participant_ids||!Array.isArray(participant_ids)||participant_ids.length===0){return res.status(400).json({error:\"participant_ids required\"})}const{data:conversation,error:convError}=await supabase.from(\"conversations\").insert({title,type,risk_tag}).select().single();if(convError)throw convError;const participants=[{conversation_id:conversation.id,user_id:userId,role:req.user.role||\"creator\"},...participant_ids.map(pid=>({conversation_id:conversation.id,user_id:pid,role:\"advisor\"}))];const{error:partError}=await supabase.from(\"conversation_participants\").insert(participants);if(partError)throw partError;res.status(201).json({data:conversation})}catch(error){res.status(500).json({error:error.message})}});router.get(\"/:id\",async(req,res)=>{try{const userId=req.user.id;const{id}=req.params;const{data:conversation,error}=await supabase.from(\"conversations\").select(`\n        *,\n        participants:conversation_participants(\n          user_id,\n          role,\n          profiles:user_id(first_name, last_name, avatar_url, role)\n        )\n      `).eq(\"id\",id).single();if(error)throw error;const isParticipant=conversation.participants.some(p=>p.user_id===userId);if(!isParticipant&&req.user.role!==\"admin\"){return res.status(403).json({error:\"Access denied\"})}res.json({data:conversation})}catch(error){res.status(500).json({error:error.message})}});var conversations_default=router;export{conversations_default as default};\n","warnings":[],"map":{"version":3,"mappings":"AAGA,OAAS,WAAwB,UACjC,OAAS,aAAgB,qBAGzB,MAAM,OAAS,OAAO,EAGtB,OAAO,IAAI,IAAK,MAAO,IAA2B,MAAkB,CAClE,GAAI,CACF,MAAM,OAAS,IAAI,KAAM,GACzB,MAAM,MAAQ,SAAS,IAAI,MAAM,KAAe,GAAK,GACrD,MAAM,OAAS,SAAS,IAAI,MAAM,MAAgB,GAAK,EAEvD,KAAM,CAAE,KAAM,cAAe,KAAM,EAAI,MAAM,SAC1C,KAAK,eAAe,EACpB,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAaP,EACA,GAAG,oCAAqC,MAAM,EAC9C,MAAM,aAAc,CAAE,UAAW,KAAM,CAAC,EACxC,MAAM,OAAQ,OAAS,MAAQ,CAAC,EAEnC,GAAI,MAAO,MAAM,MAEjB,IAAI,KAAK,CAAE,KAAM,cAAe,MAAO,MAAO,CAAC,CACjD,OAAS,MAAY,CACnB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,MAAM,OAAQ,CAAC,CAC/C,CACF,CAAC,EAGD,OAAO,KAAK,IAAK,MAAO,IAA2B,MAAkB,CACnE,GAAI,CACF,MAAM,OAAS,IAAI,KAAM,GACzB,KAAM,CAAE,gBAAiB,MAAO,KAAO,SAAU,QAAS,EAAI,IAAI,KAElE,GAAI,CAAC,iBAAmB,CAAC,MAAM,QAAQ,eAAe,GAAK,gBAAgB,SAAW,EAAG,CACvF,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,0BAA2B,CAAC,CACnE,CAGA,KAAM,CAAE,KAAM,aAAc,MAAO,SAAU,EAAI,MAAM,SACpD,KAAK,eAAe,EACpB,OAAO,CACN,MACA,KACA,QACF,CAAC,EACA,OAAO,EACP,OAAO,EAEV,GAAI,UAAW,MAAM,UAGrB,MAAM,aAAe,CACnB,CAAE,gBAAiB,aAAa,GAAI,QAAS,OAAQ,KAAM,IAAI,KAAM,MAAQ,SAAU,EACvF,GAAG,gBAAgB,IAAK,MAAiB,CACvC,gBAAiB,aAAa,GAC9B,QAAS,IACT,KAAM,SACR,EAAE,CACJ,EAEA,KAAM,CAAE,MAAO,SAAU,EAAI,MAAM,SAChC,KAAK,2BAA2B,EAChC,OAAO,YAAY,EAEtB,GAAI,UAAW,MAAM,UAErB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,KAAM,YAAa,CAAC,CAC7C,OAAS,MAAY,CACnB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,MAAM,OAAQ,CAAC,CAC/C,CACF,CAAC,EAGD,OAAO,IAAI,OAAQ,MAAO,IAA2B,MAAkB,CACrE,GAAI,CACF,MAAM,OAAS,IAAI,KAAM,GACzB,KAAM,CAAE,EAAG,EAAI,IAAI,OAEnB,KAAM,CAAE,KAAM,aAAc,KAAM,EAAI,MAAM,SACzC,KAAK,eAAe,EACpB,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAOP,EACA,GAAG,KAAM,EAAE,EACX,OAAO,EAEV,GAAI,MAAO,MAAM,MAGjB,MAAM,cAAgB,aAAa,aAAa,KAC7C,GAAW,EAAE,UAAY,MAC5B,EAEA,GAAI,CAAC,eAAiB,IAAI,KAAM,OAAS,QAAS,CAChD,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,eAAgB,CAAC,CACxD,CAEA,IAAI,KAAK,CAAE,KAAM,YAAa,CAAC,CACjC,OAAS,MAAY,CACnB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,MAAM,OAAQ,CAAC,CAC/C,CACF,CAAC,EAED,IAAO,sBAAQ","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/conversations.ts"],"sourcesContent":[null]}}