{"code":"import express from\"express\";import{validateCreatorSigningToken,markTokenAsUsed}from\"../services/creatorSigningTokenService.js\";import{signContractAsCreator}from\"../services/contractSigningService.js\";const router=express.Router();router.get(\"/:token\",async(req,res)=>{try{const{token}=req.params;if(!token){return res.status(400).json({success:false,error:\"Token is required\"})}const result=await validateCreatorSigningToken(token);if(!result.success){return res.status(400).json({success:false,error:result.error||\"Invalid signing link\"})}return res.json({success:true,tokenData:result.tokenData,dealData:result.dealData})}catch(error){console.error(\"[CreatorSignRoutes] GET error:\",error);return res.status(500).json({success:false,error:\"Failed to validate signing link\"})}});router.post(\"/:token/sign\",async(req,res)=>{try{const{token}=req.params;const{signerName,signerEmail,signerPhone,contractVersionId,contractSnapshotHtml,otpVerified,otpVerifiedAt}=req.body;if(!token){return res.status(400).json({success:false,error:\"Token is required\"})}const validationResult=await validateCreatorSigningToken(token);if(!validationResult.success){return res.status(400).json({success:false,error:validationResult.error||\"Invalid or expired signing link\"})}const{tokenData,dealData}=validationResult;if(signerEmail!==tokenData.creator_email){return res.status(403).json({success:false,error:\"Email address does not match the authorized signer for this contract\"})}const ipAddress=req.headers[\"x-forwarded-for\"]?.split(\",\")[0]?.trim()||req.socket.remoteAddress||\"unknown\";const userAgent=req.headers[\"user-agent\"]||\"unknown\";const signResult=await signContractAsCreator({dealId:tokenData.deal_id,creatorId:tokenData.creator_id,signerName,signerEmail,signerPhone,contractVersionId,contractSnapshotHtml,ipAddress,userAgent,otpVerified,otpVerifiedAt});if(!signResult.success){return res.status(400).json({success:false,error:signResult.error||\"Failed to sign contract\"})}await markTokenAsUsed(token);return res.json({success:true,signature:signResult.signature})}catch(error){console.error(\"[CreatorSignRoutes] POST sign error:\",error);return res.status(500).json({success:false,error:\"Failed to sign contract\"})}});var creatorSign_default=router;export{creatorSign_default as default};\n","warnings":[],"map":{"version":3,"mappings":"AAIA,OAAO,YAAoC,UAC3C,OACI,4BACA,oBACG,4CACP,OAAS,0BAA6B,wCAEtC,MAAM,OAAS,QAAQ,OAAO,EAM9B,OAAO,IAAI,UAAW,MAAO,IAAc,MAAkB,CACzD,GAAI,CACA,KAAM,CAAE,KAAM,EAAI,IAAI,OAEtB,GAAI,CAAC,MAAO,CACR,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,mBACX,CAAC,CACL,CAEA,MAAM,OAAS,MAAM,4BAA4B,KAAK,EAEtD,GAAI,CAAC,OAAO,QAAS,CACjB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,OAAO,OAAS,sBAC3B,CAAC,CACL,CAGA,OAAO,IAAI,KAAK,CACZ,QAAS,KACT,UAAW,OAAO,UAClB,SAAU,OAAO,QACrB,CAAC,CACL,OAAS,MAAY,CACjB,QAAQ,MAAM,iCAAkC,KAAK,EACrD,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,iCACX,CAAC,CACL,CACJ,CAAC,EAMD,OAAO,KAAK,eAAgB,MAAO,IAAc,MAAkB,CAC/D,GAAI,CACA,KAAM,CAAE,KAAM,EAAI,IAAI,OACtB,KAAM,CACF,WACA,YACA,YACA,kBACA,qBACA,YACA,aACJ,EAAI,IAAI,KAER,GAAI,CAAC,MAAO,CACR,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,mBACX,CAAC,CACL,CAGA,MAAM,iBAAmB,MAAM,4BAA4B,KAAK,EAEhE,GAAI,CAAC,iBAAiB,QAAS,CAC3B,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,iBAAiB,OAAS,iCACrC,CAAC,CACL,CAEA,KAAM,CAAE,UAAW,QAAS,EAAI,iBAGhC,GAAI,cAAgB,UAAW,cAAe,CAC1C,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,sEACX,CAAC,CACL,CAGA,MAAM,UAAa,IAAI,QAAQ,iBAAiB,GAAc,MAAM,GAAG,EAAE,CAAC,GAAG,KAAK,GAC9E,IAAI,OAAO,eACX,UACJ,MAAM,UAAY,IAAI,QAAQ,YAAY,GAAK,UAG/C,MAAM,WAAa,MAAM,sBAAsB,CAC3C,OAAQ,UAAW,QACnB,UAAW,UAAW,WACtB,WACA,YACA,YACA,kBACA,qBACA,UACA,UACA,YACA,aACJ,CAAC,EAED,GAAI,CAAC,WAAW,QAAS,CACrB,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,WAAW,OAAS,yBAC/B,CAAC,CACL,CAGA,MAAM,gBAAgB,KAAK,EAE3B,OAAO,IAAI,KAAK,CACZ,QAAS,KACT,UAAW,WAAW,SAC1B,CAAC,CACL,OAAS,MAAY,CACjB,QAAQ,MAAM,uCAAwC,KAAK,EAC3D,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CACxB,QAAS,MACT,MAAO,yBACX,CAAC,CACL,CACJ,CAAC,EAED,IAAO,oBAAQ","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/creatorSign.ts"],"sourcesContent":[null]}}