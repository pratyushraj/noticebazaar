{"code":"import express from\"express\";import{verifyActionToken}from\"../utils/token.js\";import{createContractReadyToken}from\"../services/contractReadyTokenService.js\";import{sendCollabRequestAcceptedEmail,sendCollabRequestDeclinedEmail,sendCollabRequestCounterEmail}from\"../services/collabRequestEmailService.js\";import{getEffectiveReelRate}from\"../services/creatorRateService.js\";import{supabase}from\"../lib/supabase.js\";const router=express.Router();router.get(\"/details\",async(req,res)=>{const{token}=req.query;if(!token||typeof token!==\"string\"){return res.status(400).json({success:false,error:\"Token required\"})}const{valid,requestId,action,expired}=verifyActionToken(token);if(!valid){return res.status(401).json({success:false,error:\"Invalid or tampered token\"})}if(expired){return res.status(410).json({success:false,error:\"Token expired\"})}try{const{data:request,error}=await supabase.from(\"collab_requests\").select(`\n        id,\n        creator_id,\n        brand_name,\n        collab_type,\n        deliverables,\n        budget_range,\n        exact_budget,\n        barter_value,\n        barter_description,\n        deadline,\n        campaign_description,\n        status,\n        created_at\n      `).eq(\"id\",requestId).single();if(error||!request){return res.status(404).json({success:false,error:\"Request not found\"})}if(request.status!==\"pending\"&&request.status!==\"countered\"){return res.json({success:true,data:request,status_message:`This request is already ${request.status}.`})}const{data:profile}=await supabase.from(\"profiles\").select(\"avg_rate_reel, learned_avg_rate_reel, learned_deal_count, instagram_followers\").eq(\"id\",request.creator_id).single();let suggested_reel_rate=null;if(profile){suggested_reel_rate=getEffectiveReelRate(profile)}res.json({success:true,data:request,action,suggested_reel_rate})}catch(err){res.status(500).json({success:false,error:err.message})}});router.post(\"/confirm\",async(req,res)=>{const{token}=req.body;if(!token)return res.status(400).json({success:false,error:\"Token required\"});const{valid,requestId,action}=verifyActionToken(token);if(!valid||action!==\"accept\"){return res.status(401).json({success:false,error:\"Invalid token for acceptance\"})}try{const{data:request}=await supabase.from(\"collab_requests\").select(\"*\").eq(\"id\",requestId).single();if(!request)return res.status(404).json({success:false,error:\"Request not found\"});if(request.status!==\"pending\"&&request.status!==\"countered\"){return res.status(400).json({success:false,error:\"Request already processed\"})}const dealData={brand_id:request.brand_id,creator_id:request.creator_id,brand_name:request.brand_name,brand_email:request.brand_email,deal_type:request.collab_type===\"both\"?\"paid\":request.collab_type,deal_amount:request.collab_type===\"paid\"||request.collab_type===\"both\"?request.exact_budget:request.barter_value,currency:\"INR\",deliverables:request.deliverables,status:\"contract_ready\",platform:\"instagram\",collab_request_id:request.id};const{data:deal,error:dealError}=await supabase.from(\"brand_deals\").insert(dealData).select().single();if(dealError)throw dealError;await supabase.from(\"collab_requests\").update({status:\"accepted\",deal_id:deal.id}).eq(\"id\",request.id);const contractToken=await createContractReadyToken({dealId:deal.id,creatorId:request.creator_id,expiresAt:null});const{data:profile}=await supabase.from(\"profiles\").select(\"first_name, last_name, id\").eq(\"id\",request.creator_id).single();const creatorName=profile?`${profile.first_name||\"\"} ${profile.last_name||\"\"}`.trim():\"Creator\";await sendCollabRequestAcceptedEmail(request.brand_email,{creatorName,brandName:request.brand_name,dealType:dealData.deal_type,dealAmount:dealData.deal_amount,deliverables:dealData.deliverables,contractReadyToken:contractToken.id,barterValue:request.barter_value});res.json({success:true,dealId:deal.id,contractReadyToken:contractToken.id})}catch(err){console.error(\"Confirm Error:\",err);res.status(500).json({success:false,error:err.message})}});router.post(\"/decline\",async(req,res)=>{const{token,reason}=req.body;const{valid,requestId,action}=verifyActionToken(token);if(!valid||action!==\"decline\")return res.status(401).json({success:false,error:\"Invalid token\"});try{const{data:request}=await supabase.from(\"collab_requests\").select(\"*\").eq(\"id\",requestId).single();if(!request)return res.status(404).json({success:false,error:\"Request not found\"});await supabase.from(\"collab_requests\").update({status:\"declined\",decline_reason:reason}).eq(\"id\",requestId);const{data:profile}=await supabase.from(\"profiles\").select(\"first_name, last_name, username\").eq(\"id\",request.creator_id).single();const creatorName=profile?`${profile.first_name} ${profile.last_name}`.trim():\"Creator\";await sendCollabRequestDeclinedEmail(request.brand_email,{brandName:request.brand_name,creatorName,creatorUsername:profile?.username||\"creator\"});res.json({success:true})}catch(err){res.status(500).json({success:false,error:err.message})}});router.post(\"/counter\",async(req,res)=>{const{token,counterBudget,counterDeliverables,counterTimeline,notes}=req.body;const{valid,requestId,action}=verifyActionToken(token);if(!valid||action!==\"counter\")return res.status(401).json({success:false,error:\"Invalid token\"});try{const{data:request}=await supabase.from(\"collab_requests\").select(\"*\").eq(\"id\",requestId).single();if(!request)return res.status(404).json({success:false,error:\"Request not found\"});await supabase.from(\"collab_requests\").update({status:\"countered\",counter_offer:{budget:counterBudget,deliverables:counterDeliverables,timeline:counterTimeline,notes}}).eq(\"id\",requestId);const{data:profile}=await supabase.from(\"profiles\").select(\"first_name, last_name\").eq(\"id\",request.creator_id).single();const creatorName=profile?`${profile.first_name} ${profile.last_name}`.trim():\"Creator\";await sendCollabRequestCounterEmail(request.brand_email,{brandName:request.brand_name,creatorName,originalBudget:request.exact_budget,counterPrice:counterBudget,counterDeliverables:Array.isArray(counterDeliverables)?counterDeliverables.join(\", \"):counterDeliverables,counterTimeline,counterNotes:notes,requestId:request.id});res.json({success:true})}catch(err){res.status(500).json({success:false,error:err.message})}});var collabAction_default=router;export{collabAction_default as default};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/routes/collabAction.ts"],"sourcesContent":[null]}}