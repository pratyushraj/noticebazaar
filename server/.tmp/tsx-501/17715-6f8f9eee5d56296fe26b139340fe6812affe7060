{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{supabase}from\"../lib/supabase.js\";import{sendBrandFormSubmissionEmail}from\"./brandFormSubmissionEmailService.js\";function shouldRequireBrandConfirmation(deal){if(deal.creatorRequestedChanges)return true;if(deal.flags?.requiresClarification===true)return true;if(!deal.usage||!deal.usage.duration)return true;if(!deal.payment?.timeline||!deal.payment?.method)return true;if(deal.exclusivity?.status===\"unknown\")return true;const required=[\"deliverables\",\"deadline\",\"amount\"];for(const field of required){if(!deal[field])return true}return false}__name(shouldRequireBrandConfirmation,\"shouldRequireBrandConfirmation\");async function createDealDetailsToken(options){const{creatorId,expiresAt}=options;if(!creatorId){throw new Error(\"creatorId is required\")}const{data:token,error:tokenError}=await supabase.from(\"deal_details_tokens\").insert({creator_id:creatorId,expires_at:expiresAt?expiresAt.toISOString():null,is_active:true}).select().single();if(tokenError||!token){console.error(\"[DealDetailsTokenService] Token creation error:\",tokenError);throw new Error(\"Failed to create deal details token\")}return token}__name(createDealDetailsToken,\"createDealDetailsToken\");async function getDealDetailsTokenInfo(tokenId){const uuidRegex=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;if(!uuidRegex.test(tokenId.trim())){return null}const{data:tokenData,error:tokenError}=await supabase.from(\"deal_details_tokens\").select(`\n      *,\n      profiles:creator_id (\n        first_name,\n        last_name\n      )\n    `).eq(\"id\",tokenId.trim()).maybeSingle();if(tokenError||!tokenData){return null}if(!tokenData.is_active||tokenData.revoked_at){return null}if(tokenData.expires_at){const expiresAt=new Date(tokenData.expires_at);if(expiresAt<new Date){return null}}const profile=tokenData.profiles;const creatorName=profile?`${profile.first_name||\"\"} ${profile.last_name||\"\"}`.trim()||\"the creator\":\"the creator\";return{token:tokenData,creatorName}}__name(getDealDetailsTokenInfo,\"getDealDetailsTokenInfo\");async function submitDealDetails(tokenId,formData){const tokenInfo=await getDealDetailsTokenInfo(tokenId);if(!tokenInfo){throw new Error(\"Invalid or expired token\")}const{token}=tokenInfo;if(token.used_at){throw new Error(\"This form has already been submitted and cannot be edited. Please contact the creator for changes.\")}const{error:updateError}=await supabase.from(\"deal_details_tokens\").update({used_at:new Date().toISOString()}).eq(\"id\",tokenId);if(updateError){console.error(\"[DealDetailsTokenService] Token update error:\",updateError)}const{data:submission,error:submissionError}=await supabase.from(\"deal_details_submissions\").insert({token_id:tokenId,creator_id:token.creator_id,form_data:formData}).select().single();if(submissionError||!submission){console.error(\"[DealDetailsTokenService] Submission error:\",submissionError);throw new Error(\"Failed to submit deal details\")}let dealId=null;try{console.log(\"[DealDetailsTokenService] Generating contract for submission...\");const{generateContractFromScratch}=await import(\"./contractGenerator.js\").then(s=>{const e=\"default\";return s[e]&&typeof s[e]==\"object\"&&\"__esModule\"in s[e]?s[e]:s});const{data:creator,error:creatorError}=await supabase.from(\"profiles\").select(\"id, first_name, last_name, address, location\").eq(\"id\",token.creator_id).single();let creatorEmail=null;if(creator){const{data:authUser}=await supabase.auth.admin.getUserById(token.creator_id);creatorEmail=authUser?.user?.email||null}if(!creatorError&&creator){const deliverablesList=Array.isArray(formData.deliverables)?formData.deliverables.map(d=>`${d.quantity||1}x ${d.contentType||\"Content\"} on ${d.platform||\"Platform\"}`):[\"As per agreement\"];const creatorName=creator.first_name&&creator.last_name?`${creator.first_name} ${creator.last_name}`:creator.first_name||creator.email?.split(\"@\")[0]||\"Creator\";let creatorAddress=null;const locationValue=creator.location;const addressValue=creator.address;const rawAddress=locationValue&&typeof locationValue===\"string\"&&locationValue.trim()!==\"\"&&locationValue.toLowerCase()!==\"n/a\"?locationValue.trim():addressValue&&typeof addressValue===\"string\"&&addressValue.trim()!==\"\"&&addressValue.toLowerCase()!==\"n/a\"?addressValue.trim():null;creatorAddress=rawAddress;const dealAmount=formData.dealType===\"paid\"&&formData.paymentAmount?parseFloat(formData.paymentAmount)||0:0;const contractRequest={brandName:formData.brandName||\"Brand\",creatorName,dealAmount,deliverables:deliverablesList,brandEmail:formData.companyEmail||null,brandAddress:formData.companyAddress||null,creatorEmail:creatorEmail||null,creatorAddress,dealSchema:{usage_type:formData.usageRightsDuration||\"3_months\",usage_platforms:formData.deliverables?.map(d=>d.platform)||[\"Instagram\"],usage_duration:formData.usageRightsDuration||\"3_months\",paid_ads_allowed:formData.paidAdsAllowed||false,whitelisting_allowed:formData.whitelistingAllowed||false,exclusivity_enabled:formData.exclusivityPeriod&&formData.exclusivityPeriod!==\"none\",exclusivity_duration:formData.exclusivityPeriod||null,payment_method:formData.paymentMethod?.[0]||null,payment_timeline:formData.paymentTimeline||null},usageType:formData.usageRightsDuration||\"3_months\",usagePlatforms:formData.deliverables?.map(d=>d.platform)||[\"Instagram\"],usageDuration:formData.usageRightsDuration||\"3_months\",paidAdsAllowed:formData.paidAdsAllowed||false,whitelistingAllowed:formData.whitelistingAllowed||false,exclusivityEnabled:formData.exclusivityPeriod&&formData.exclusivityPeriod!==\"none\",exclusivityCategory:null,exclusivityDuration:formData.exclusivityPeriod||null,terminationNoticeDays:null,jurisdictionCity:formData.companyState||null,additionalTerms:null};const contractResult=await generateContractFromScratch(contractRequest);const{data:uploadData,error:uploadError}=await supabase.storage.from(\"creator-assets\").upload(`contracts/submissions/${submission.id}/${contractResult.fileName}`,contractResult.contractDocx,{contentType:\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",upsert:true});if(!uploadError&&uploadData){const{data:urlData}=await supabase.storage.from(\"creator-assets\").getPublicUrl(uploadData.path);console.log(\"[DealDetailsTokenService] Contract generated and stored for submission:\",submission.id)}else{console.error(\"[DealDetailsTokenService] Contract upload failed:\",uploadError)}}else{console.error(\"[DealDetailsTokenService] Creator not found for contract generation\")}}catch(contractError){console.error(\"[DealDetailsTokenService] Contract generation failed (non-fatal):\",contractError)}{try{const{data:creatorProfile,error:profileError}=await supabase.from(\"profiles\").select(\"first_name, last_name\").eq(\"id\",token.creator_id).maybeSingle();let creatorEmail=null;if(!profileError&&creatorProfile){const{data:authUser}=await supabase.auth.admin.getUserById(token.creator_id);creatorEmail=authUser?.user?.email||null}if(!profileError&&creatorProfile&&creatorEmail){const creatorName=creatorProfile.first_name||creatorProfile.last_name?`${creatorProfile.first_name||\"\"} ${creatorProfile.last_name||\"\"}`.trim():\"Creator\";const brandData={brandName:formData.brandName||\"Brand\",campaignName:formData.campaignName,dealType:formData.dealType||\"paid\",paymentAmount:formData.dealType===\"paid\"&&formData.paymentAmount?parseFloat(formData.paymentAmount)||0:void 0,deliverables:formData.deliverables||[],deadline:formData.deadline};sendBrandFormSubmissionEmail(creatorEmail,creatorName,brandData,submission.id).then(result=>{if(result.success){console.log(\"[DealDetailsTokenService] Email notification sent successfully:\",result.emailId)}else{console.warn(\"[DealDetailsTokenService] Failed to send email notification:\",result.error)}}).catch(error=>{console.error(\"[DealDetailsTokenService] Error sending email notification:\",error)})}else{console.warn(\"[DealDetailsTokenService] Could not fetch creator email for notification:\",profileError)}}catch(emailError){console.error(\"[DealDetailsTokenService] Error preparing email notification:\",emailError)}}let contractReadyToken=null;try{console.log(\"[DealDetailsTokenService] Creating contract ready token for submission:\",submission.id,\"creator:\",token.creator_id);const{createContractReadyToken}=await import(\"./contractReadyTokenService.js\").then(s=>{const e=\"default\";return s[e]&&typeof s[e]==\"object\"&&\"__esModule\"in s[e]?s[e]:s});const readyToken=await createContractReadyToken({submissionId:submission.id,creatorId:token.creator_id,expiresAt:null});contractReadyToken=readyToken.id;console.log(\"[DealDetailsTokenService] \\u2705 Contract ready token generated successfully:\",contractReadyToken)}catch(tokenError){console.error(\"[DealDetailsTokenService] \\u274C Failed to generate contract ready token:\",tokenError);contractReadyToken=null}return{submissionId:submission.id,dealId,contractReadyToken}}__name(submitDealDetails,\"submitDealDetails\");async function getDealSubmissionDetails(dealId){const{data:submission,error}=await supabase.from(\"deal_details_submissions\").select(\"*, deal_details_tokens!inner(*)\").eq(\"deal_id\",dealId).maybeSingle();if(error||!submission){return null}return{submission,formData:submission.form_data}}__name(getDealSubmissionDetails,\"getDealSubmissionDetails\");export{createDealDetailsToken,getDealDetailsTokenInfo,getDealSubmissionDetails,shouldRequireBrandConfirmation,submitDealDetails};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/pratyushraj/Documents/noticebazaar/server/src/services/dealDetailsTokenService.ts"],"sourcesContent":[null]}}